# Copyright 2020 The Oppia Authors. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS-IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""Check for decrease in coverage from 100% of frontend files."""

from __future__ import absolute_import  # pylint: disable=import-only-modules
from __future__ import unicode_literals  # pylint: disable=import-only-modules

import os
import re
import sys

import python_utils

LCOV_FILE_PATH = os.path.join(os.pardir, 'karma_coverage_reports', 'lcov.info')
RELEVANT_LCOV_LINE_PREFIXES = ['SF', 'LH', 'LF']

# Contains the name of all files that is not 100% coverage.
# This list must be kept up-to-date; the changes (only remove) should be done
# manually.
# Please keep the list in alphabetical order.
<<<<<<< HEAD
# NOTE TO REVIEWERS: Please be circumspect about any PRs which delete elements
# from this list.
FULLY_COVERED_FILENAMES = [
    'about-page.controller.ts',
    'admin-config-tab-backend-api.service.ts',
    'admin-data.service.ts',
    'admin-page.constants.ajs.ts',
    'admin-page.constants.ts',
    'admin-router.service.ts',
    'admin-task-manager.service.ts',
    'alerts.service.ts',
    'angular-name.service.ts',
    'answer-groups-cache.service.ts',
    'AnswerClassificationResultObjectFactory.ts',
    'AnswerDetailsImprovementTaskObjectFactory.ts',
    'AnswerGroupObjectFactory.ts',
    'AnswerStatsObjectFactory.ts',
    'app.constants.ajs.ts',
    'app.constants.ts',
    'apply-validation.directive.ts',
    'assets-backend-api.service.ts',
    'audio-bar-status.service.ts',
    'audio-translation-language.service.ts',
    'AudioFileObjectFactory.ts',
    'AudioLanguageObjectFactory.ts',
    'AutogeneratedAudioLanguageObjectFactory.ts',
    'autoplayed-videos.service.ts',
    'background-mask.service.ts',
    'base-undo-redo.service.ts',
    'browser-checker.service.ts',
    'camel-case-to-hyphens.filter.ts',
    'camel-case-to-hyphens.pipe.ts',
    'capitalize.filter.ts',
    'capitalize.pipe.ts',
    'ChangeObjectFactory.ts',
    'changes-in-human-readable-form.directive.ts',
    'ckeditor.import.ts',
    'ClassifierObjectFactory.ts',
    'classifiers-extension.constants.ts',
    'classroom-backend-api.service.ts',
    'classroom-domain.constants.ajs.ts',
    'classroom-domain.constants.ts',
    'code-normalizer.service.ts',
    'code-repl-rules.service.ts',
    'code-repl-validation.service.ts',
    'codemirrorRequires.ts',
    'CodeRepl.ts',
    'collection-creation-backend-api.service.ts',
    'collection-domain.constants.ajs.ts',
    'collection-domain.constants.ts',
    'collection-editor-page.constants.ajs.ts',
    'collection-editor-page.constants.ts',
    'collection-linearizer.service.ts',
    'collection-rights-backend-api.service.ts',
    'collection-summary-tile.constants.ajs.ts',
    'collection-summary-tile.constants.ts',
    'collection-validation.service.ts',
    'CollectionRightsObjectFactory.ts',
    'community-dashboard-page.constants.ajs.ts',
    'community-dashboard-page.constants.ts',
    'compare-versions.service.ts',
    'compute-graph.service.ts',
    'concept-card-backend-api.service.ts',
    'confirm-or-cancel-modal.controller.ts',
    'constants.ts',
    'construct-translation-ids.service.ts',
    'continue-rules.service.ts',
    'continue-validation.service.ts',
    'Continue.ts',
    'convert-html-to-unicode.filter.ts',
    'convert-unicode-to-html.filter.ts',
    'convert-unicode-with-params-to-html.filter.ts',
    'count-vectorizer.service.ts',
    'creator-dashboard-backend-api.service.ts',
    'creator-dashboard-page.constants.ajs.ts',
    'creator-dashboard-page.constants.ts',
    'data.ts',
    'date-time-format.service.ts',
    'debouncer.service.ts',
    'device-info.service.ts',
    'document-attribute-customization.service.ts',
    'drag-and-drop-sort-input-rules.service.ts',
    'DragAndDropSortInput.ts',
    'editability.service.ts',
    'editable-question-backend-api.service.ts',
    'editable-topic-backend-api.service.ts',
    'editor-domain.constants.ajs.ts',
    'editor-domain.constants.ts',
    'editor-first-time-events.service.ts',
    'email-dashboard-page.controller.ts',
    'email-dashboard-result.controller.ts',
    'end-exploration-rules.service.ts',
    'end-exploration-validation.service.ts',
    'EndExploration.ts',
    'EntityContextObjectFactory.ts',
    'exploration-automatic-text-to-speech.service.ts',
    'exploration-category.service.ts',
    'exploration-correctness-feedback.service.ts',
    'exploration-data.service.ts',
    'exploration-editor-page.constants.ajs.ts',
    'exploration-editor-page.constants.ts',
    'exploration-features-backend-api.service.ts',
    'exploration-features.service.ts',
    'exploration-html-formatter.service.ts',
    'exploration-id-validation.service.ts',
    'exploration-init-state-name.service.ts',
    'exploration-language-code.service.ts',
    'exploration-objective.service.ts',
    'exploration-param-changes.service.ts',
    'exploration-param-specs.service.ts',
    'exploration-player-page.constants.ajs.ts',
    'exploration-player-page.constants.ts',
    'exploration-property.service.ts',
    'exploration-rights.service.ts',
    'exploration-summary-backend-api.service.ts',
    'exploration-tags.service.ts',
    'exploration-title.service.ts',
    'exploration-warnings.service.ts',
    'ExplorationDraftObjectFactory.ts',
    'ExplorationMetadataObjectFactory.ts',
    'ExplorationObjectFactory.ts',
    'ExplorationOpportunitySummaryObjectFactory.ts',
    'expression-parser.service.ts',
    'expression-syntax-tree.service.ts',
    'extension-tag-assembler.service.ts',
    'extract-image-filenames-from-state.service.ts',
    'FeedbackImprovementTaskObjectFactory.ts',
    'FeedbackMessageSummaryObjectFactory.ts',
    'FeedbackThreadObjectFactory.ts',
    'FileDownloadRequestObjectFactory.ts',
    'focus-manager.service.ts',
    'format-rte-preview.filter.ts',
    'fraction-input-rules.service.ts',
    'FractionInput.ts',
    'FractionObjectFactory.ts',
    'generate-content-id.service.ts',
    'generatedDefaultData.ts',
    'get-abbreviated-text.filter.ts',
    'get-abbreviated-text.pipe.ts',
    'graph-data.service.ts',
    'graph-utils.service.ts',
    'GraphInput.ts',
    'guest-collection-progress.service.ts',
    'GuestCollectionProgressObjectFactory.ts',
    'HintObjectFactory.ts',
    'hints-and-solution-manager.service.ts',
    'id-generation.service.ts',
    'image-click-input-rules.service.ts',
    'image-click-input-validation.service.ts',
    'image-preloader.service.ts',
    'ImageClickInput.ts',
    'ImageFileObjectFactory.ts',
    'improvement-confirmation-modal.controller.ts',
    'improvement-feedback-thread-modal.controller.ts',
    'improvement-learner-answer-details-modal.controller.ts',
    'improvement-modal.service.ts',
    'improvement-playthrough-modal.controller.ts',
    'improvement-suggestion-thread-modal.controller.ts',
    'ImprovementActionButtonObjectFactory.ts',
    'improvements.service.ts',
    'interaction-details-cache.service.ts',
    'interaction-specs.constants.ajs.ts',
    'interaction-specs.constants.ts',
    'InteractionObjectFactory.ts',
    'interactions-extension.constants.ajs.ts',
    'interactions-extension.constants.ts',
    'interactionsQuestionsRequires.ts',
    'interactionsRequires.ts',
    'interactive-map-rules.service.ts',
    'interactive-map-validation.service.ts',
    'InteractiveMap.ts',
    'is-at-least.filter.ts',
    'is-at-most.filter.ts',
    'is-float.filter.ts',
    'is-integer.filter.ts',
    'is-nonempty.filter.ts',
    'item-selection-input-rules.service.ts',
    'ItemSelectionInput.ts',
    'learner-action-render.service.ts',
    'learner-answer-details-backend-api.service.ts',
    'learner-answer-details-data.service.ts',
    'learner-dashboard-backend-api.service.ts',
    'learner-dashboard-ids-backend-api.service.ts',
    'learner-dashboard-page.constants.ajs.ts',
    'learner-dashboard-page.constants.ts',
    'learner-params.service.ts',
    'learner-playlist-modal.controller.ts',
    'learner-playlist.service.ts',
    'LearnerActionObjectFactory.ts',
    'LearnerAnswerDetailsObjectFactory.ts',
    'LearnerAnswerInfoObjectFactory.ts',
    'LearnerDashboardActivityIdsObjectFactory.ts',
    'library-page.constants.ajs.ts',
    'library-page.constants.ts',
    'loader.service.ts',
    'loading-message.component.ts',
    'local-storage.service.ts',
    'logger.service.ts',
    'logic-proof-rules.service.ts',
    'logic-proof-validation.service.ts',
    'LogicProof.ts',
    'LostChangeObjectFactory.ts',
    'mark-all-audio-and-translations-as-needing-update.controller.ts',
    'MathExpressionInput.ts',
    'mathjaxConfig.ts',
    'meta-tag-customization.service.ts',
    'MisconceptionObjectFactory.ts',
    'moderator-page.controller.ts',
    'multiple-choice-input-rules.service.ts',
    'multiple-choice-input-validation.service.ts',
    'MultipleChoiceInput.ts',
    'music-notes-input-validation.service.ts',
    'MusicNotesInput.ts',
    'navigation.service.ts',
    'nested-directives-recursion-timeout-prevention.service.ts',
    'normalize-whitespace.filter.ts',
    'normalize-whitespace.pipe.ts',
    'notifications-dashboard-page.controller.ts',
    'number-attempts.service.ts',
    'number-with-units-rules.service.ts',
    'NumberWithUnits.ts',
    'numeric-input-rules.service.ts',
    'NumericInput.ts',
    'objectComponentsRequires.ts',
    'objectComponentsRequiresForPlayers.ts',
    'objects-domain.constants.ajs.ts',
    'objects-domain.constants.ts',
    'OutcomeObjectFactory.ts',
    'page-title.service.ts',
    'ParamChangeObjectFactory.ts',
    'ParamChangesObjectFactory.ts',
    'parameter-metadata.service.ts',
    'ParamMetadataObjectFactory.ts',
    'ParamSpecObjectFactory.ts',
    'ParamSpecsObjectFactory.ts',
    'ParamTypeObjectFactory.ts',
    'pencil-code-editor-rules.service.ts',
    'pencil-code-editor-validation.service.ts',
    'PencilCodeEditor.ts',
    'playthrough-issues-backend-api.service.ts',
    'playthrough-issues.service.ts',
    'PlaythroughImprovementTaskObjectFactory.ts',
    'PlaythroughIssueObjectFactory.ts',
    'PlaythroughObjectFactory.ts',
    'practice-session-page.constants.ajs.ts',
    'practice-session-page.constants.ts',
    'prediction-algorithm-registry.service.ts',
    'PredictionResultObjectFactory.ts',
    'question-backend-api.service.ts',
    'question-domain.constants.ajs.ts',
    'question-domain.constants.ts',
    'question-player-state.service.ts',
    'question-player.constants.ajs.ts',
    'question-player.constants.ts',
    'question-undo-redo.service.ts',
    'QuestionObjectFactory.ts',
    'questions-list.constants.ajs.ts',
    'questions-list.constants.ts',
    'questions-list.service.ts',
    'QuestionSummaryForOneSkillObjectFactory.ts',
    'QuestionSummaryObjectFactory.ts',
    'rating-computation.service.ts',
    'read-only-exploration-backend-api.service.ts',
    'read-only-topic-object.factory.ts',
    'ReadOnlyStoryNodeObjectFactory.ts',
    'ReadOnlySubtopicPageObjectFactory.ts',
    'replace-inputs-with-ellipses.filter.ts',
    'replace-inputs-with-ellipses.pipe.ts',
    'require-is-float.directive.ts',
    'responses.service.ts',
    'review-test-backend-api.service.ts',
    'review-test-domain.constants.ts',
    'review-test-engine.service.ts',
    'review-test-page.constants.ajs.ts',
    'review-test-page.constants.ts',
    'rich_text_components_definitions.ts',
    'richTextComponentsRequires.ts',
    'router.service.ts',
    'rte-helper-modal.controller.ts',
    'rte-helper.service.ts',
    'RubricObjectFactory.ts',
    'RuleObjectFactory.ts',
    'schema-default-value.service.ts',
    'schema-undefined-last-element.service.ts',
    'search-explorations-backend-api.service.ts',
    'search.service.ts',
    'services.constants.ajs.ts',
    'services.constants.ts',
    'set-input-rules.service.ts',
    'set-input-validation.service.ts',
    'SetInput.ts',
    'sidebar-status.service.ts',
    'site-analytics.service.ts',
    'skill-backend-api.service.ts',
    'skill-creation-backend-api.service.ts',
    'skill-domain.constants.ajs.ts',
    'skill-domain.constants.ts',
    'skill-editor-page.constants.ajs.ts',
    'skill-editor-page.constants.ts',
    'skill-editor-routing.service.ts',
    'skill-mastery-backend-api.service.ts',
    'skill-rights-backend-api.service.ts',
    'SkillOpportunityObjectFactory.ts',
    'SkillRightsObjectFactory.ts',
    'skills-mastery-list.constants.ajs.ts',
    'skills-mastery-list.constants.ts',
    'SkillSummaryObjectFactory.ts',
    'solution-validity.service.ts',
    'solution-verification.service.ts',
    'SolutionObjectFactory.ts',
    'speech-synthesis-chunker.service.ts',
    'splash-page.controller.ts',
    'state-classifier-mapping.service.ts',
    'state-content.service.ts',
    'state-customization-args.service.ts',
    'state-editor.constants.ajs.ts',
    'state-editor.constants.ts',
    'state-hints.service.ts',
    'state-interaction-id.service.ts',
    'state-name.service.ts',
    'state-param-changes.service.ts',
    'state-recorded-voiceovers.service.ts',
    'state-rules-stats.service.ts',
    'state-solicit-answer-details.service.ts',
    'state-solution.service.ts',
    'state-top-answers-stats-backend-api.service.ts',
    'state-written-translations.service.ts',
    'StateObjectFactory.ts',
    'statistics-domain.constants.ajs.ts',
    'statistics-domain.constants.ts',
    'stewards-landing-page.controller.ts',
    'StopwatchObjectFactory.ts',
    'story-domain.constants.ajs.ts',
    'story-domain.constants.ts',
    'story-editor-page.constants.ajs.ts',
    'story-editor-page.constants.ts',
    'story-viewer-domain.constants.ts',
    'StoryObjectFactory.ts',
    'StoryPlaythroughObjectFactory.ts',
    'StoryReferenceObjectFactory.ts',
    'StorySummaryObjectFactory.ts',
    'SubtitledHtmlObjectFactory.ts',
    'subtopic-viewer-backend-api.service.ts',
    'subtopic-viewer-domain.constants.ts',
    'SubtopicPageContentsObjectFactory.ts',
    'suggestion-modal-for-creator-view.controller.ts',
    'suggestion-modal-for-creator-view.service.ts',
    'suggestion-modal.service.ts',
    'SuggestionImprovementTaskObjectFactory.ts',
    'SuggestionObjectFactory.ts',
    'suggestions.service.ts',
    'SuggestionThreadObjectFactory.ts',
    'summarize-nonnegative-number.filter.ts',
    'teach-page.controller.ts',
    'test.extras.ts',
    'text-input-prediction.service.ts',
    'text-input-rules.service.ts',
    'text-input-validation.service.ts',
    'text-input.tokenizer.ts',
    'TextInput.ts',
    'thread-data.service.ts',
    'thread-status-display.service.ts',
    'ThreadMessageObjectFactory.ts',
    'ThreadMessageSummaryObjectFactory.ts',
    'topic-creation-backend-api.service.ts',
    'topic-domain.constants.ajs.ts',
    'topic-domain.constants.ts',
    'topic-editor-page.constants.ajs.ts',
    'topic-editor-page.constants.ts',
    'topic-landing-page.constants.ajs.ts',
    'topic-landing-page.constants.ts',
    'topic-landing-page.controller.ts',
    'topic-rights-backend-api.service.ts',
    'topic-viewer-backend-api.service.ts',
    'topic-viewer-domain.constants.ajs.ts',
    'topic-viewer-domain.constants.ts',
    'TopicRightsObjectFactory.ts',
    'topics-and-skills-dashboard-domain.constants.ajs.ts',
    'topics-and-skills-dashboard-domain.constants.ts',
    'topics-and-skills-dashboard-page.constants.ajs.ts',
    'topics-and-skills-dashboard-page.constants.ts',
    'TopicSummaryObjectFactory.ts',
    'training-data-editor-panel-modal.controller.ts',
    'training-data-editor-panel.service.ts',
    'training-data.service.ts',
    'training-modal.controller.ts',
    'training-modal.service.ts',
    'translation-language.service.ts',
    'translation-status.service.ts',
    'translation-tab-active-content-id.service.ts',
    'translation-tab-active-mode.service.ts',
    'truncate-at-first-ellipsis.filter.ts',
    'truncate-at-first-ellipsis.pipe.ts',
    'truncate-at-first-line.filter.ts',
    'truncate-at-first-line.pipe.ts',
    'uiLeafletRequires.ts',
    'underscores-to-camel-case.filter.ts',
    'underscores-to-camel-case.pipe.ts',
    'undo-redo.service.ts',
    'UnitsObjectFactory.ts',
    'UpgradedServices.ts',
    'url.service.ts',
    'user-email-preferences.service.ts',
    'user-exploration-permissions.service.ts',
    'user.service.ts',
    'UserInfoObjectFactory.ts',
    'validators.service.ts',
    'valueGeneratorsRequires.ts',
    'VoiceoverObjectFactory.ts',
    'window-dimensions.service.ts',
    'window-ref.service.ts',
    'winnowing-preprocessing.service.ts',
    'WorkedExampleObjectFactory.ts',
    'wrap-text-with-ellipsis.filter.ts',
    'wrap-text-with-ellipsis.pipe.ts',
    'WrittenTranslationObjectFactory.ts',
    'WrittenTranslationsObjectFactory.ts',
=======
# NOTE TO DEVELOPERS: do not add any new files to this list without asking
# @marianazangrossi first.
NOT_FULLY_COVERED_FILENAMES = [
    'about-page.module.ts',
    'activity-tiles-infinity-grid.directive.ts',
    'admin-config-tab.directive.ts',
    'admin-dev-mode-activities-tab.directive.ts',
    'admin-jobs-tab.directive.ts',
    'admin-misc-tab.directive.ts',
    'admin-navbar.directive.ts',
    'admin-page.directive.ts',
    'admin-prod-mode-activities-tab.directive.ts',
    'admin-roles-tab.directive.ts',
    'alert-message.directive.ts',
    'angular-html-bind.directive.ts',
    'answer-classification.service.ts',
    'answer-details-improvement-task.directive.ts',
    'answer-group-editor.directive.ts',
    'answer-submit-action.directive.ts',
    'App.ts',
    'attribution-guide.directive.ts',
    'audio-bar.directive.ts',
    'audio-file-uploader.directive.ts',
    'audio-player.service.ts',
    'audio-preloader.service.ts',
    'audio-translation-bar.directive.ts',
    'audio-translation-manager.service.ts',
    'autogenerated-audio-player.service.ts',
    'autosave-info-modals.service.ts',
    'background-banner.directive.ts',
    'bar-chart.directive.ts',
    'base-content.directive.ts',
    'base-interaction-validation.service.ts',
    'Base.ts',
    'boolean-editor.directive.ts',
    'change-list.service.ts',
    'circular-image.directive.ts',
    'ck-editor-4-rte.directive.ts',
    'ck-editor-4-widgets.initializer.ts',
    'classroom-page.controller.ts',
    'code-repl-prediction.service.ts',
    'code-string-editor.directive.ts',
    'codemirror-mergeview.directive.ts',
    'collection-creation.service.ts',
    'collection-details-editor.directive.ts',
    'collection-editor-navbar-breadcrumb.directive.ts',
    'collection-editor-navbar.directive.ts',
    'collection-editor-page.directive.ts',
    'collection-editor-state.service.ts',
    'collection-editor-tab.directive.ts',
    'collection-footer.directive.ts',
    'collection-history-tab.directive.ts',
    'collection-local-nav.directive.ts',
    'collection-navbar.directive.ts',
    'collection-node-creator.directive.ts',
    'collection-node-editor.directive.ts',
    'collection-node-list.directive.ts',
    'collection-permissions-card.directive.ts',
    'collection-player-page.directive.ts',
    'collection-settings-tab.directive.ts',
    'collection-statistics-tab.directive.ts',
    'collection-summary-tile.directive.ts',
    'collection-update.service.ts',
    'CollectionNodeObjectFactory.ts',
    'CollectionObjectFactory.ts',
    'CollectionPlaythroughObjectFactory.ts',
    'community-dashboard-page.controller.ts',
    'concept-card.directive.ts',
    'ConceptCardObjectFactory.ts',
    'context.service.ts',
    'continue-button.directive.ts',
    'contribution-and-review.service.ts',
    'contribution-opportunities-backend-api.service.ts',
    'contribution-opportunities.service.ts',
    'contributions-and-review.directive.ts',
    'conversation-skin.directive.ts',
    'conversion.ts',
    'convert-to-plain-text.filter.ts',
    'convert-to-plain-text.pipe.ts',
    'coord-two-dim-editor.directive.ts',
    'copier.directive.ts',
    'correctness-footer.directive.ts',
    'create-activity-button.directive.ts',
    'creator-dashboard-page.controller.ts',
    'csrf-token.service.ts',
    'current-interaction.service.ts',
    'cyclic-transitions-issue.directive.ts',
    'delete-account-page.controller.ts',
    'drag-and-drop-html-string-editor.directive.ts',
    'drag-and-drop-positive-int-editor.directive.ts',
    'drag-and-drop-sort-input-validation.service.ts',
    'early-quit-issue.directive.ts',
    'editable-collection-backend-api.service.ts',
    'editable-exploration-backend-api.service.ts',
    'editable-story-backend-api.service.ts',
    'editor-navbar-breadcrumb.directive.ts',
    'editor-navigation.directive.ts',
    'email-dashboard-data.service.ts',
    'error-page.controller.ts',
    'exploration-automatic-text-to-speech.service.ts',
    'exploration-creation.service.ts',
    'exploration-diff.service.ts',
    'exploration-editor-page.controller.ts',
    'exploration-editor-tab.directive.ts',
    'exploration-embed-button.service.ts',
    'exploration-engine.service.ts',
    'exploration-footer.directive.ts',
    'exploration-graph.directive.ts',
    'exploration-objective-editor.directive.ts',
    'exploration-player-page.controller.ts',
    'exploration-player-state.service.ts',
    'exploration-recommendations.service.ts',
    'exploration-save-and-publish-buttons.directive.ts',
    'exploration-save.service.ts',
    'exploration-states.service.ts',
    'exploration-summary-tile.directive.ts',
    'exploration-title-editor.directive.ts',
    'expression-evaluator.service.ts',
    'expression-interpolation.service.ts',
    'expression-type-parser.service.ts',
    'fatigue-detection.service.ts',
    'feedback-improvement-task.directive.ts',
    'feedback-popup.directive.ts',
    'feedback-tab.directive.ts',
    'FeedbackThreadSummaryObjectFactory.ts',
    'filepath-editor.directive.ts',
    'focus-on.directive.ts',
    'format-timer.filter.ts',
    'fraction-editor.directive.ts',
    'fraction-input-validation.service.ts',
    'generatedParser.ts',
    'google-analytics.initializer.ts',
    'graph-detail.service.ts',
    'graph-editor.directive.ts',
    'graph-input-rules.service.ts',
    'graph-input-validation.service.ts',
    'graph-layout.service.ts',
    'graph-property-editor.directive.ts',
    'graph-viz.directive.ts',
    'hint-and-solution-buttons.directive.ts',
    'hint-and-solution-modal.service.ts',
    'hint-editor.directive.ts',
    'history-tab.directive.ts',
    'html-editor.directive.ts',
    'html-escaper.service.ts',
    'html-select.directive.ts',
    'I18nFooter.ts',
    'image-upload-helper.service.ts',
    'image-uploader.directive.ts',
    'image-with-regions-editor.directive.ts',
    'improvements-tab.directive.ts',
    'input-response-pair.directive.ts',
    'int-editor.directive.ts',
    'item-selection-input-validation.service.ts',
    'language-util.service.ts',
    'lazy-loading.directive.ts',
    'learner-answer-info-card.directive.ts',
    'learner-answer-info.service.ts',
    'learner-dashboard-icons.directive.ts',
    'learner-dashboard-page.controller.ts',
    'learner-local-nav.directive.ts',
    'learner-view-info.directive.ts',
    'learner-view-rating.service.ts',
    'library-footer.directive.ts',
    'library-page.directive.ts',
    'list-of-sets-of-html-strings-editor.directive.ts',
    'list-of-tabs-editor.directive.ts',
    'list-of-unicode-string-editor.directive.ts',
    'loading-dots.directive.ts',
    'logic-demo-test.controller.ts',
    'logic-error-category-editor.directive.ts',
    'logic-question-editor.directive.ts',
    'login-required-message.directive.ts',
    'maintenance-page.controller.ts',
    'math-expression-input-rules.service.ts',
    'math-expression-input-validation.service.ts',
    'math-latex-string-editor.directive.ts',
    'mathjax-bind.directive.ts',
    'messenger.service.ts',
    'misconception-editor.directive.ts',
    'multiple-incorrect-issue.directive.ts',
    'multiple-incorrect-submissions-issue.directive.ts',
    'music-notes-input-rules.service.ts',
    'music-phrase-editor.directive.ts',
    'music-phrase-player.service.ts',
    'nonnegative-int-editor.directive.ts',
    'normalize-whitespace-punctuation-and-case.pipe.ts',
    'normalized-string-editor.directive.ts',
    'number-with-units-editor.directive.ts',
    'number-with-units-validation.service.ts',
    'NumberWithUnitsObjectFactory.ts',
    'numeric-input-validation.service.ts',
    'object-editor.directive.ts',
    'oppia-interactive-code-repl.directive.ts',
    'oppia-interactive-continue.directive.ts',
    'oppia-interactive-drag-and-drop-sort-input.directive.ts',
    'oppia-interactive-end-exploration.directive.ts',
    'oppia-interactive-fraction-input.directive.ts',
    'oppia-interactive-graph-input.directive.ts',
    'oppia-interactive-image-click-input.directive.ts',
    'oppia-interactive-interactive-map.directive.ts',
    'oppia-interactive-item-selection-input.directive.ts',
    'oppia-interactive-logic-proof.directive.ts',
    'oppia-interactive-math-expression-input.directive.ts',
    'oppia-interactive-multiple-choice-input.directive.ts',
    'oppia-interactive-music-notes-input.directive.ts',
    'oppia-interactive-number-with-units.directive.ts',
    'oppia-interactive-numeric-input.directive.ts',
    'oppia-interactive-pencil-code-editor.directive.ts',
    'oppia-interactive-set-input.directive.ts',
    'oppia-interactive-text-input.directive.ts',
    'oppia-noninteractive-collapsible.directive.ts',
    'oppia-noninteractive-image.directive.ts',
    'oppia-noninteractive-link.directive.ts',
    'oppia-noninteractive-math.directive.ts',
    'oppia-noninteractive-skillreview.directive.ts',
    'oppia-noninteractive-tabs.directive.ts',
    'oppia-noninteractive-video.directive.ts',
    'oppia-response-code-repl.directive.ts',
    'oppia-response-continue.directive.ts',
    'oppia-response-drag-and-drop-sort-input.directive.ts',
    'oppia-response-end-exploration.directive.ts',
    'oppia-response-fraction-input.directive.ts',
    'oppia-response-graph-input.directive.ts',
    'oppia-response-image-click-input.directive.ts',
    'oppia-response-interactive-map.directive.ts',
    'oppia-response-item-selection-input.directive.ts',
    'oppia-response-logic-proof.directive.ts',
    'oppia-response-math-expression-input.directive.ts',
    'oppia-response-multiple-choice-input.directive.ts',
    'oppia-response-music-notes-input.directive.ts',
    'oppia-response-number-with-units.directive.ts',
    'oppia-response-numeric-input.directive.ts',
    'oppia-response-pencil-code-editor.directive.ts',
    'oppia-response-set-input.directive.ts',
    'oppia-response-text-input.directive.ts',
    'oppia-short-response-code-repl.directive.ts',
    'oppia-short-response-continue.directive.ts',
    'oppia-short-response-drag-and-drop-sort-input.directive.ts',
    'oppia-short-response-end-exploration.directive.ts',
    'oppia-short-response-fraction-input.directive.ts',
    'oppia-short-response-graph-input.directive.ts',
    'oppia-short-response-image-click-input.directive.ts',
    'oppia-short-response-interactive-map.directive.ts',
    'oppia-short-response-item-selection-input.directive.ts',
    'oppia-short-response-logic-proof.directive.ts',
    'oppia-short-response-math-expression-input.directive.ts',
    'oppia-short-response-multiple-choice-input.directive.ts',
    'oppia-short-response-music-notes-input.directive.ts',
    'oppia-short-response-number-with-units.directive.ts',
    'oppia-short-response-numeric-input.directive.ts',
    'oppia-short-response-pencil-code-editor.directive.ts',
    'oppia-short-response-set-input.directive.ts',
    'oppia-short-response-text-input.directive.ts',
    'oppia-visualization-bar-chart.directive.ts',
    'oppia-visualization-enumerated-frequency-table.directive.ts',
    'oppia-visualization-frequency-table.directive.ts',
    'OppiaFooterDirective.ts',
    'opportunities-list-item.directive.ts',
    'opportunities-list.directive.ts',
    'outcome-destination-editor.directive.ts',
    'outcome-editor.directive.ts',
    'outcome-feedback-editor.directive.ts',
    'param-changes-editor.directive.ts',
    'parameter-name-editor.directive.ts',
    'parameterize-rule-description.filter.ts',
    'pencil-code-editor-validation.service.ts',
    'pie-chart.directive.ts',
    'player-correctness-feedback-enabled.service.ts',
    'player-position.service.ts',
    'player-transcript.service.ts',
    'playthrough-improvement-task.directive.ts',
    'playthrough-issues.directive.ts',
    'playthrough.service.ts',
    'Polyfills.ts',
    'practice-session-page.controller.ts',
    'practice-tab.directive.ts',
    'preferences-page.controller.ts',
    'pretest-question-backend-api.service.ts',
    'preview-tab.directive.ts',
    'profile-link-image.directive.ts',
    'profile-link-text.directive.ts',
    'profile-page-navbar.directive.ts',
    'profile-page.controller.ts',
    'progress-nav.directive.ts',
    'promo-bar.directive.ts',
    'promo-bar.service.ts',
    'python-program.tokenizer.ts',
    'question-creation.service.ts',
    'question-difficulty-selector.directive.ts',
    'question-editor.directive.ts',
    'question-opportunities.directive.ts',
    'question-player-engine.service.ts',
    'question-player.directive.ts',
    'question-suggestion.service.ts',
    'question-update.service.ts',
    'questions-list.directive.ts',
    'random-selector.directive.ts',
    'rating-display.directive.ts',
    'read-only-collection-backend-api.service.ts',
    'real-editor.directive.ts',
    'RecordedVoiceoversObjectFactory.ts',
    'refresher-exploration-confirmation-modal.service.ts',
    'remove-duplicates-in-array.pipe.ts',
    'request-interceptor.service.ts',
    'response-header.directive.ts',
    'review-material-editor.directive.ts',
    'review-test-page.directive.ts',
    'role-graph.directive.ts',
    'rubrics-editor.directive.ts',
    'rule-editor.directive.ts',
    'rule-type-selector.directive.ts',
    'sanitized-url-editor.directive.ts',
    'schema-based-bool-editor.directive.ts',
    'schema-based-choices-editor.directive.ts',
    'schema-based-custom-editor.directive.ts',
    'schema-based-custom-viewer.directive.ts',
    'schema-based-dict-editor.directive.ts',
    'schema-based-dict-viewer.directive.ts',
    'schema-based-editor.directive.ts',
    'schema-based-expression-editor.directive.ts',
    'schema-based-float-editor.directive.ts',
    'schema-based-html-editor.directive.ts',
    'schema-based-html-viewer.directive.ts',
    'schema-based-int-editor.directive.ts',
    'schema-based-list-editor.directive.ts',
    'schema-based-list-viewer.directive.ts',
    'schema-based-primitive-viewer.directive.ts',
    'schema-based-unicode-editor.directive.ts',
    'schema-based-unicode-viewer.directive.ts',
    'schema-based-viewer.directive.ts',
    'score-ring.directive.ts',
    'search-bar.directive.ts',
    'search-results.directive.ts',
    'select2-dropdown.directive.ts',
    'set-of-html-string-editor.directive.ts',
    'set-of-unicode-string-editor.directive.ts',
    'settings-tab.directive.ts',
    'shared.ts',
    'sharing-links.directive.ts',
    'side-navigation-bar.directive.ts',
    'signup-page.controller.ts',
    'skill-concept-card-editor.directive.ts',
    'skill-creation.service.ts',
    'skill-description-editor.directive.ts',
    'skill-editor-main-tab.directive.ts',
    'skill-editor-navbar-breadcrumb.directive.ts',
    'skill-editor-navbar.directive.ts',
    'skill-editor-page.controller.ts',
    'skill-editor-state.service.ts',
    'skill-mastery.directive.ts',
    'skill-misconceptions-editor.directive.ts',
    'skill-prerequisite-skills-editor.directive.ts',
    'skill-questions-tab.directive.ts',
    'skill-rubrics-editor.directive.ts',
    'skill-selector-editor.directive.ts',
    'skill-selector.directive.ts',
    'skill-update.service.ts',
    'SkillDifficultyObjectFactory.ts',
    'SkillObjectFactory.ts',
    'skills-list.directive.ts',
    'skills-mastery-list.directive.ts',
    'social-buttons.directive.ts',
    'solution-editor.directive.ts',
    'solution-explanation-editor.directive.ts',
    'state-content-editor.directive.ts',
    'state-editor.directive.ts',
    'state-editor.service.ts',
    'state-graph-visualization.directive.ts',
    'state-hints-editor.directive.ts',
    'state-improvement-suggestion.service.ts',
    'state-interaction-editor.directive.ts',
    'state-name-editor.directive.ts',
    'state-param-changes-editor.directive.ts',
    'state-property.service.ts',
    'state-responses.directive.ts',
    'state-solution-editor.directive.ts',
    'state-top-answers-stats.service.ts',
    'state-translation-editor.directive.ts',
    'state-translation-status-graph.directive.ts',
    'state-translation.directive.ts',
    'state-tutorial-first-time.service.ts',
    'StateCardObjectFactory.ts',
    'StatesObjectFactory.ts',
    'statistics-tab.directive.ts',
    'stats-reporting.service.ts',
    'story-creation.service.ts',
    'story-editor-navbar-breadcrumb.directive.ts',
    'story-editor-navbar.directive.ts',
    'story-editor-page.controller.ts',
    'story-editor-state.service.ts',
    'story-editor.directive.ts',
    'story-node-editor.directive.ts',
    'story-summary-tile.directive.ts',
    'story-update.service.ts',
    'story-viewer-backend-api.service.ts',
    'story-viewer-navbar-breadcrumb.directive.ts',
    'story-viewer-page.directive.ts',
    'StoryContentsObjectFactory.ts',
    'StoryNodeObjectFactory.ts',
    'student.ts',
    'subtopic-summary-tile.directive.ts',
    'subtopic-viewer-navbar-breadcrumb.directive.ts',
    'subtopic-viewer-page.controller.ts',
    'SubtopicObjectFactory.ts',
    'SubtopicPageObjectFactory.ts',
    'subtopics-list-tab.directive.ts',
    'subtopics-list.directive.ts',
    'suggestion-improvement-task.directive.ts',
    'suggestion-modal-for-exploration-editor.service.ts',
    'suggestion-modal-for-exploration-player.service.ts',
    'suggestion-modal-for-learner-dashboard.service.ts',
    'summary-list-header.directive.ts',
    'supplemental-card.directive.ts',
    'svm-prediction.service.ts',
    'teacher.ts',
    'teacher2.ts',
    'test-interaction-panel.directive.ts',
    'thanks-page.controller.ts',
    'thread-table.directive.ts',
    'thumbnail-uploader.directive.ts',
    'top-navigation-bar.directive.ts',
    'topic-creation.service.ts',
    'topic-editor-navbar-breadcrumb.directive.ts',
    'topic-editor-navbar.directive.ts',
    'topic-editor-page.controller.ts',
    'topic-editor-routing.service.ts',
    'topic-editor-state.service.ts',
    'topic-editor-stories-list.directive.ts',
    'topic-editor-tab.directive.ts',
    'topic-questions-tab.directive.ts',
    'topic-selector.directive.ts',
    'topic-summary-tile.directive.ts',
    'topic-update.service.ts',
    'topic-viewer-navbar-breadcrumb.directive.ts',
    'topic-viewer-page.controller.ts',
    'topic-viewer-stories-list.directive.ts',
    'TopicObjectFactory.ts',
    'topics-and-skills-dashboard-backend-api.service.ts',
    'topics-and-skills-dashboard-navbar-breadcrumb.directive.ts',
    'topics-and-skills-dashboard-navbar.directive.ts',
    'topics-and-skills-dashboard-page.controller.ts',
    'topics-list.directive.ts',
    'training-panel.directive.ts',
    'translate-text.service.ts',
    'translation-file-hash-loader.service.ts',
    'translation-opportunities.directive.ts',
    'translation-tab.directive.ts',
    'translator-overview.directive.ts',
    'truncate-and-capitalize.filter.ts',
    'truncate-and-capitalize.pipe.ts',
    'truncate-input-based-on-interaction-answer-type.filter.ts',
    'truncate.filter.ts',
    'truncate.pipe.ts',
    'tutor-card.directive.ts',
    'unicode-string-editor.directive.ts',
    'unresolved-answers-overview.directive.ts',
    'url-interpolation.service.ts',
    'utils.service.ts',
    'value-generator-editor.directive.ts',
    'version-diff-visualization.directive.ts',
    'version-tree.service.ts',
    'voiceover-opportunities.directive.ts',
    'voiceover-recording.service.ts',
    'warnings-and-alerts.directive.ts',
    'worked-example-editor.directive.ts',
>>>>>>> 6c87ee6c63ea94ac7d4bb58285bcbae688987876
]


class LcovStanzaRelevantLines(python_utils.OBJECT):
    """Gets the relevant lines from a lcov stanza."""

    def __init__(self, stanza):
        """Initialize the object which provides relevant data of a lcov
        stanza in order to calculate any decrease in frontend test coverage.

        Args:
            stanza: list(str). Contains all the lines from a lcov stanza.

        Raises:
            Exception: file_path is empty.
            Exception: Total lines number is not found.
            Exception: Covered lines number is not found.
        """

        match = re.search('SF:(.+)\n', stanza)
        if match is None:
            raise Exception(
                'The test path is empty or null. '
                'It\'s not possible to diff the test coverage correctly.')
        _, file_name = os.path.split(match.group(1))
        self.file_name = file_name

        match = re.search(r'LF:(\d+)\n', stanza)
        if match is None:
            raise Exception(
                'It wasn\'t possible to get the total lines of {} file.'
                'It\'s not possible to diff the test coverage correctly.'
                .format(file_name))
        self.total_lines = int(match.group(1))

        match = re.search(r'LH:(\d+)\n', stanza)
        if match is None:
            raise Exception(
                'It wasn\'t possible to get the covered lines of {} file.'
                'It\'s not possible to diff the test coverage correctly.'
                .format(file_name))
        self.covered_lines = int(match.group(1))


def get_stanzas_from_lcov_file():
    """Get all stanzas from a lcov file. The lcov file gather all the frontend
    files that has tests and each one has the following structure:
    TN: test name
    SF: file path
    FNF: total functions
    FNH: functions covered
    LF: total lines
    LH: lines covered
    BRF: total branches
    BRH: branches covered
    end_of_record

    Returns:
        list(LcovStanzaRelevantLines). A list with all stanzas.
    """
    f = python_utils.open_file(LCOV_FILE_PATH, 'r')
    lcov_items_list = f.read().split('end_of_record')
    stanzas_list = []

    for item in lcov_items_list:
        if item.strip('\n'):
            stanza = LcovStanzaRelevantLines(item)
            stanzas_list.append(stanza)

    return stanzas_list


def check_not_fully_covered_filenames_list_is_sorted():
    """Check if NOT_FULLY_COVERED_FILENAMES list is in alphabetical order."""
    if NOT_FULLY_COVERED_FILENAMES != sorted(
            NOT_FULLY_COVERED_FILENAMES, key=lambda s: s.lower()):
        sys.exit(
            'The \033[1mNOT_FULLY_COVERED_FILENAMES\033[0m list must be'
            ' kept in alphabetical order.')


def check_coverage_changes():
    """Checks if the blacklist for not fully covered files needs to be changed
    by:
    - File renaming
    - File deletion

    Raises:
        Exception: LCOV_FILE_PATH doesn't exist.
    """
    if not os.path.exists(LCOV_FILE_PATH):
        raise Exception(
            'Expected lcov file to be available at {}, but the'
            ' file does not exist.'.format(LCOV_FILE_PATH))

    stanzas = get_stanzas_from_lcov_file()
    remaining_blacklisted_files = list(NOT_FULLY_COVERED_FILENAMES)
    errors = ''

    for stanza in stanzas:
        file_name = stanza.file_name
        total_lines = stanza.total_lines
        covered_lines = stanza.covered_lines

        if file_name not in remaining_blacklisted_files:
            if total_lines != covered_lines:
                errors += (
                    '\033[1m{}\033[0m seems to be not completely tested.'
                    ' Make sure it\'s fully covered.\n'.format(file_name))
        else:
            if total_lines == covered_lines:
                errors += (
                    '\033[1m{}\033[0m seems to be fully covered!'
                    ' Before removing it manually from the blacklist'
                    ' in the file'
                    ' scripts/check_frontend_test_coverage.py, please'
                    ' make sure you\'ve followed the unit tests rules'
                    ' correctly on:'
                    ' https://github.com/oppia/oppia/wiki/Frontend'
                    '-unit-tests-guide#rules\n'.format(file_name))

            remaining_blacklisted_files.remove(file_name)

    if remaining_blacklisted_files:
        for test_name in remaining_blacklisted_files:
            errors += (
                '\033[1m{}\033[0m is in the frontend test coverage'
                ' blacklist but it doesn\'t exist anymore. If you have'
                ' renamed it, please make sure to remove the old file'
                ' name and add the new file name in the blacklist in'
                ' the file scripts/check_frontend_test_coverage.py.\n'
                .format(test_name))

    if errors:
        python_utils.PRINT('------------------------------------')
        python_utils.PRINT('Frontend Coverage Checks Not Passed.')
        python_utils.PRINT('------------------------------------')
        sys.exit(errors)
    else:
        python_utils.PRINT('------------------------------------')
        python_utils.PRINT('All Frontend Coverage Checks Passed.')
        python_utils.PRINT('------------------------------------')

    check_not_fully_covered_filenames_list_is_sorted()


def main():
    """Runs all the steps for checking if there is any decrease of 100% covered
    files in the frontend.
    """
    check_coverage_changes()


# The 'no coverage' pragma is used as this line is un-testable. This is because
# it will only be called when check_frontend_coverage.py is used as a script.
if __name__ == '__main__': # pragma: no cover
    main()
