timeout: 3600s # 1 hour
logsBucket: 'gs://$_LOGS_BUCKET_NAME'
steps:
  - id: build-oppia-base
    name: gcr.io/kaniko-project/executor:latest
    wait_for: ["-"]
    args: 
    - --dockerfile=Dockerfile.base
    - --destination=gcr.io/$_PROJECT_NAME/oppia-base:$SHORT_SHA
    - --cache=true
    - --cache-ttl=24h

  - id: install-dependencies
    wait_for: ["build-oppia-base"]
    name: gcr.io/$_PROJECT_NAME/oppia-base:$SHORT_SHA
    volumes:
      - name: 'test'
        path: '/test'
    entrypoint: bash
    args: 
      - "-c"
      - |
          mkdir /test/oppia
          shopt -s dotglob
          mv * /test/oppia
          cd /test/oppia
          git init
          python -m scripts.install_third_party_libs

  - id: third-party-size-check
    wait_for: ["install-dependencies"]
    name: gcr.io/$_PROJECT_NAME/oppia-base:$SHORT_SHA
    volumes:
      - name: 'test'
        path: '/test'
    dir: /test/oppia
    entrypoint: python
    args: ["-m", "scripts.third_party_size_check"]

  - id: backend-tests
    name: gcr.io/$_PROJECT_NAME/oppia-base:$SHORT_SHA
    wait_for: ["install-dependencies"]
    volumes:
      - name: 'test'
        path: '/test'
    dir: /test/oppia
    entrypoint: bash
    args:
      - "-c"
      - |
          set -e
          python -m scripts.run_backend_tests
