
  <!DOCTYPE html>
  <html>
    <head>
      <title>set-input-validation.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">extensions/interactions/SetInput/directives/set-input-validation.service.ts</td><td class="">96.88%</td><td class="">100%</td><td class="">224</td><td class="">217</td><td class="">7</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2014 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Validator service for the interaction.
 */

import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;
import { Injectable } from &#x27;@angular/core&#x27;;

import { AnswerGroup } from
  &#x27;domain/exploration/AnswerGroupObjectFactory&#x27;;
import { AppConstants } from &#x27;app.constants&#x27;;
import { Warning, baseInteractionValidationService } from
  &#x27;interactions/base-interaction-validation.service&#x27;;
import { SetInputCustomizationArgs } from
  &#x27;interactions/customization-args-defs&#x27;;
import { Outcome } from
  &#x27;domain/exploration/OutcomeObjectFactory&#x27;;
import { Rule } from
  &#x27;domain/exploration/RuleObjectFactory&#x27;;
import { TranslatableSetOfUnicodeString } from &#x27;interactions/rule-input-defs&#x27;;

interface PreviousRule {
  answerGroupIndex: number;
  ruleIndex: number;
  rule: Rule;
}

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class SetInputValidationService {
  constructor(
    private baseInteractionValidationServiceInstance:
      baseInteractionValidationService) {}

  /**
   * Checks if the two sets are identical.
   *
   * @param {string[]} inputA first set.
   * @param {string[]} inputB second set.
   * @return {boolean} True if the two sets are identical.
   */
  private areSameSet(inputA: string[], inputB: string[]): boolean {
    let setA = new Set(inputA);
    let setB = new Set(inputB);
    if (setA.size !== setB.size) {
      return false;
    }
    return this.isSubset(inputA, inputB);
  }

  /**
   * Checks if the first set is a subset of the second set.
   *
   * @param {string[]} inputA first set.
   * @param {string[]} inputB second set.
   * @return {boolean} True if the first set is a subset of the second set.
   */
  private isSubset(inputA: string[], inputB: string[]): boolean {
    let setB = new Set(inputB);
    return inputA.every(val =&gt; setB.has(val));
  }

  /**
   * Checks if the two rules are identical.
   *
   * @param {Rule} ruleA first rule.
   * @param {Rule} ruleB second rule.
   * @return {boolean} True if the two rules are identical.
   */
  private areSameRule(ruleA: Rule, ruleB: Rule): boolean {
    return ruleA.type === ruleB.type &amp;&amp;
      this.areSameSet(
        (&lt;TranslatableSetOfUnicodeString&gt;ruleA.inputs.x).unicodeStrSet,
        (&lt;TranslatableSetOfUnicodeString&gt;ruleB.inputs.x).unicodeStrSet);
  }

  getCustomizationArgsWarnings(
      customizationArgs: SetInputCustomizationArgs): Warning[] {
    let warningsList = [];

    let buttonText = (
      customizationArgs.buttonText &amp;&amp; customizationArgs.buttonText.value);
    if (!buttonText || !angular.isString(buttonText.unicode)) {
      warningsList.push({
        type: AppConstants.WARNING_TYPES.ERROR,
        message: &#x27;Button text must be a string.&#x27;
      });
    } else if (buttonText.unicode.length === 0) {
      warningsList.push({
        message: &#x27;Label for this button should not be empty.&#x27;,
        type: AppConstants.WARNING_TYPES.ERROR
      });
    }

    return warningsList;
  }

  /**
   * Generate warnings for redundant rules in answer groups.
   * A rule is considered redundant if it will never be matched.
   *
   * @param {AnswerGroup[]} answerGroups answer groups created from user input.
   * @return {Warning[]} Array of warnings.
   */
  getRedundantRuleWarnings(answerGroups: AnswerGroup[]): Warning[] {
    let warningsList: Warning[] = [];

    let previousRules: PreviousRule[] = [];

    for (let [answerGroupIndex, answerGroup] of answerGroups.entries()) {
      for (let [ruleIndex, rule] of answerGroup.rules.entries()) {
        for (let prevRule of previousRules) {
          if (this.areSameRule(prevRule.rule, rule)) {
            warningsList.push({
              type: AppConstants.WARNING_TYPES.ERROR,
              message: `Rule ${ruleIndex + 1} from answer group ` +
                `${answerGroupIndex + 1} is the same as ` +
                `rule ${prevRule.ruleIndex + 1} from ` +
                `answer group ${prevRule.answerGroupIndex + 1}`
            });
          } else if (prevRule.rule.type === rule.type) {
            /*
            For setInput, a rule A is made redundant by rule B only when:
              - rule B appears before rule A, and
              - they are of the same type, and
              - they are not &#x27;Equals&#x27; rules, and
              - A&#x27;s input is the subset of B&#x27;s input or vice versa,
                depending on their rule types.
            */
            let isRuleCoveredByAnyPrevRule = false;
            let ruleInput = &lt;TranslatableSetOfUnicodeString&gt;rule.inputs.x;
            let prevRuleInput = (
              &lt;TranslatableSetOfUnicodeString&gt;prevRule.rule.inputs.x);
            switch (rule.type) {
              case &#x27;Equals&#x27;:
                // An &#x27;Equals&#x27; rule is made redundant by another only when
                // they are the same, which has been checked in the code above,
                // using areSameRule method.
                break;
              case &#x27;IsSubsetOf&#x27;:
              case &#x27;HasElementsIn&#x27;:
              case &#x27;IsDisjointFrom&#x27;:
                isRuleCoveredByAnyPrevRule = this.isSubset(
                  ruleInput.unicodeStrSet,
                  prevRuleInput.unicodeStrSet
                );
                break;
              case &#x27;IsSupersetOf&#x27;:
              case &#x27;HasElementsNotIn&#x27;:
              case &#x27;OmitsElementsIn&#x27;:
                isRuleCoveredByAnyPrevRule = this.isSubset(
                  prevRuleInput.unicodeStrSet,
                  ruleInput.unicodeStrSet
                );
                break;
              default:
            }

            if (isRuleCoveredByAnyPrevRule) {
              warningsList.push({
                type: AppConstants.WARNING_TYPES.ERROR,
                message: `Rule ${ruleIndex + 1} from answer group ` +
                  `${answerGroupIndex + 1} will never be matched because it ` +
                  `is made redundant by rule ${prevRule.ruleIndex + 1}` +
                  ` from answer group ${prevRule.answerGroupIndex + 1}.`
              });
            }
          }
        }

        previousRules.push({
          rule,
          ruleIndex,
          answerGroupIndex
        });
      }
    }

    return warningsList;
  }

  getAllWarnings(
      stateName: string, customizationArgs: SetInputCustomizationArgs,
      answerGroups: AnswerGroup[], defaultOutcome: Outcome): Warning[] {
    return [
      ...this.getCustomizationArgsWarnings(customizationArgs),
      ...this.getRedundantRuleWarnings(answerGroups),
      ...this.baseInteractionValidationServiceInstance.getAllOutcomeWarnings(
        answerGroups, defaultOutcome, stateName)
    ];
  }
}

angular.module(&#x27;oppia&#x27;).factory(
  &#x27;SetInputValidationService&#x27;, downgradeInjectable(SetInputValidationService));
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;extensions/interactions/SetInput/directives/set-input-validation.service.ts&quot;,&quot;line&quot;:86,&quot;character&quot;:9,&quot;text&quot;:&quot;&lt;TranslatableSetOfUnicodeString&gt;ruleA.inputs.x&quot;,&quot;kind&quot;:4},{&quot;file&quot;:&quot;extensions/interactions/SetInput/directives/set-input-validation.service.ts&quot;,&quot;line&quot;:87,&quot;character&quot;:9,&quot;text&quot;:&quot;&lt;TranslatableSetOfUnicodeString&gt;ruleB.inputs.x&quot;,&quot;kind&quot;:4},{&quot;file&quot;:&quot;extensions/interactions/SetInput/directives/set-input-validation.service.ts&quot;,&quot;line&quot;:92,&quot;character&quot;:8,&quot;text&quot;:&quot;warningsList&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/interactions/SetInput/directives/set-input-validation.service.ts&quot;,&quot;line&quot;:97,&quot;character&quot;:6,&quot;text&quot;:&quot;warningsList&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/interactions/SetInput/directives/set-input-validation.service.ts&quot;,&quot;line&quot;:102,&quot;character&quot;:6,&quot;text&quot;:&quot;warningsList&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/interactions/SetInput/directives/set-input-validation.service.ts&quot;,&quot;line&quot;:144,&quot;character&quot;:28,&quot;text&quot;:&quot;&lt;TranslatableSetOfUnicodeString&gt;rule.inputs.x&quot;,&quot;kind&quot;:4},{&quot;file&quot;:&quot;extensions/interactions/SetInput/directives/set-input-validation.service.ts&quot;,&quot;line&quot;:146,&quot;character&quot;:14,&quot;text&quot;:&quot;&lt;TranslatableSetOfUnicodeString&gt;prevRule.rule.inputs.x&quot;,&quot;kind&quot;:4}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:55 GMT</p>
    </body>
  </html>
  