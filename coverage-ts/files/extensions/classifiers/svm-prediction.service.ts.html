
  <!DOCTYPE html>
  <html>
    <head>
      <title>svm-prediction.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">extensions/classifiers/svm-prediction.service.ts</td><td class="">87.97%</td><td class="">100%</td><td class="">449</td><td class="">395</td><td class="">54</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2017 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview SVM predict function for SVC classifier of sklearn.
 *
 * IMPORTANT NOTE: The predict function uses svm data that was extracted
 * after training of classifier on Oppia-ml. If there are any changes in
 * format of extracted data then corresponding changes must be propagated here.
 * Oppia-ml uses scikit&#x27;s SVC class during training classifier which uses
 * libsvm&#x27;s implementation. If there are any changes in following part of
 * code in libsvm then corresponding changes must be propagated here.
 *
 * libsvm&#x27;s code for prediction:
 * https://github.com/arnaudsj/libsvm/blob/master/svm.cpp#L2481
 */

import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;
import { Injectable } from &#x27;@angular/core&#x27;;

import { PredictionResult } from &#x27;domain/classifier/prediction-result.model&#x27;;

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class SVMPredictionService {
  constructor() {}
  kernel(
      kernelParams: KernelParams, supportVectors: number[][],
      input: number[]): number[] {
    var kernel = kernelParams.kernel;
    var kvalues = [];

    if (kernel === &#x27;rbf&#x27;) {
      var gamma = kernelParams.gamma;
      for (var i = 0; i &lt; supportVectors.length; i++) {
        var sum = 0;
        for (var j = 0; j &lt; input.length; j++) {
          sum += Math.pow((supportVectors[i][j] - input[j]), 2);
        }
        kvalues.push(Math.exp(-gamma * sum));
      }
    } else if (kernel === &#x27;linear&#x27;) {
      for (var i = 0; i &lt; supportVectors.length; i++) {
        var sum = 0;
        for (var j = 0; j &lt; input.length; j++) {
          sum += supportVectors[i][j] * input[j];
        }
        kvalues.push(sum);
      }
    }
    return kvalues;
  }
  // Find multiclass probabilities.
  // NOTE: This function is implemented as it is given in LibSVM.
  // For more information on exact approach used, read following paper:
  // https://www.csie.ntu.edu.tw/~cjlin/papers/svmprob/svmprob.pdf
  // Also take a look at implementation by LibSVM:
  // https://github.com/arnaudsj/libsvm/blob/master/svm.cpp#L1829
  calculateMulticlassProbabilities(
      nClasses: number, pairwiseProb: number[][]): number[] {
    var Q = [];
    for (var i = 0; i &lt; nClasses; i++) {
      Q.push([]);
      for (var j = 0; j &lt; nClasses; j++) {
        Q[i].push(0);
      }
    }

    var Qp = [];
    for (var i = 0; i &lt; nClasses; i++) {
      Qp.push(0);
    }

    var P = [];
    for (var i = 0; i &lt; nClasses; i++) {
      P.push(0);
    }

    var maxIter = Math.max(100, nClasses);
    var eps = 0.005 / nClasses;

    for (var t = 0; t &lt; nClasses; t++) {
      P[t] = 1.0 / nClasses;
      Q[t][t] = 0.0;
      for (var j = 0; j &lt; t; j++) {
        Q[t][t] += pairwiseProb[j][t] * pairwiseProb[j][t];
        Q[t][j] = Q[j][t];
      }

      for (var j = t + 1; j &lt; nClasses; j++) {
        Q[t][t] += pairwiseProb[j][t] * pairwiseProb[j][t];
        Q[t][j] = -pairwiseProb[j][t] * pairwiseProb[t][j];
      }
    }

    var iter = 0;
    for (iter = 0; iter &lt; maxIter; iter++) {
      var pQp = 0.0;

      for (var t = 0; t &lt; nClasses; t++) {
        Qp[t] = 0;
        for (var j = 0; j &lt; nClasses; j++) {
          Qp[t] += Q[t][j] * P[j];
        }
        pQp += P[t] * Qp[t];
      }

      var maxError = 0;
      for (var t = 0; t &lt; nClasses; t++) {
        var error = Math.abs(Qp[t] - pQp);
        if (error &gt; maxError) {
          maxError = error;
        }
      }

      if (maxError &lt; eps) {
        break;
      }

      for (var t = 0; t &lt; nClasses; t++) {
        var diff = (-Qp[t] + pQp) / Q[t][t];
        P[t] += diff;
        pQp = (
          (pQp + diff * (diff * Q[t][t] + 2 * Qp[t])) /
          (1 + diff) / (1 + diff));
        for (var j = 0; j &lt; nClasses; j++) {
          Qp[j] = (Qp[j] + diff * Q[t][j]) / (1 + diff);
          P[j] /= (1 + diff);
        }
      }
    }

    if (iter &gt;= maxIter) {
      console.warn(&#x27;Exceeds maxIter in calculateMulticlassProbabilities&#x27;);
    }

    return P;
  }

  predict(
      classifierData: SVM, input: number[]): PredictionResult {
    var nSupport = classifierData.n_support;
    var supportVectors = classifierData.support_vectors;
    var dualCoef = classifierData.dual_coef;
    var intercept = classifierData.intercept;
    var classes = classifierData.classes;
    var kernelParams = classifierData.kernel_params;
    var probA = classifierData.probA;
    var probB = classifierData.probB;

    var startIndices = [];
    startIndices[0] = 0;
    for (var i = 1; i &lt; nSupport.length; i++) {
      startIndices[i] = startIndices[i - 1] + nSupport[i - 1];
    }

    if (supportVectors[0].length !== input.length) {
      // Support vector and input dimensions do not match.
      console.error(
        &#x27;Dimension of support vectors and given input is different.&#x27;);
    }

    // Find kernel values for supportVectors and given input. Assumes that
    // input has same dimension and data type as any of the supportVectors.
    var kvalues = this.kernel(kernelParams, supportVectors, input);

    var votes = [];
    for (var i = 0; i &lt; classes.length; i++) {
      votes.push(0);
    }

    var pairwiseProb = [];
    for (var i = 0; i &lt; classes.length; i++) {
      pairwiseProb.push([]);
      for (var j = 0; j &lt; classes.length; j++) {
        pairwiseProb[i].push(0);
      }
    }

    var p = 0;
    for (var i = 0; i &lt; classes.length; i++) {
      for (var j = i + 1; j &lt; classes.length; j++) {
        var si = startIndices[i];
        var sj = startIndices[j];
        var ci = nSupport[i];
        var cj = nSupport[j];
        var minProb = 1e-7;

        var coef1 = dualCoef[j - 1];
        var coef2 = dualCoef[i];

        var sum = 0;
        for (var k = 0; k &lt; ci; k++) {
          sum += kvalues[si + k] * coef1[si + k];
        }

        for (var k = 0; k &lt; cj; k++) {
          sum += kvalues[sj + k] * coef2[sj + k];
        }

        // NOTE: libsvm substracts the intercept from sum in its prediction
        // function. Here intercept is added because sci-kit negates the
        // intercept before passing it on to libsvm for prediction.
        // For more info see github following issue:
        // https://github.com/oppia/oppia/issues/4166
        sum += intercept[p];

        // The following approach to calculate pairwise probabilities was
        // proposed by platt. For more info on LibSVM&#x27;s implementation
        // of platt scaling, read following paper:
        // https://www.csie.ntu.edu.tw/~cjlin/papers/plattprob.pdf
        // Also take a look at following implementation by LibSVM:
        // https://github.com/arnaudsj/libsvm/blob/master/svm.cpp#L2552
        var f = probA[p] * sum + probB[p];
        var prob = 0;
        if (f &gt;= 0) {
          prob = Math.exp(-f) / (1 + Math.exp(-f));
        } else {
          prob = 1 / (1 + Math.exp(f));
        }
        prob = Math.min(Math.max(prob, minProb), 1 - minProb);
        pairwiseProb[i][j] = prob;
        pairwiseProb[j][i] = 1 - prob;
        p++;
      }
    }

    var probabilities = this.calculateMulticlassProbabilities(
      classes.length, pairwiseProb);

    var maxProbIdx = 0;
    for (var i = 1; i &lt; classes.length; i++) {
      if (probabilities[i] &gt; probabilities[maxProbIdx]) {
        maxProbIdx = i;
      }
    }

    var predictedLabel = classes[maxProbIdx];
    var prediction = new PredictionResult(
      predictedLabel, probabilities[maxProbIdx]);
    return prediction;
  }
}

angular.module(&#x27;oppia&#x27;).factory(
  &#x27;SVMPredictionService&#x27;, downgradeInjectable(SVMPredictionService));
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:42,&quot;character&quot;:8,&quot;text&quot;:&quot;kvalues&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:51,&quot;character&quot;:8,&quot;text&quot;:&quot;kvalues&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:59,&quot;character&quot;:8,&quot;text&quot;:&quot;kvalues&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:72,&quot;character&quot;:8,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:74,&quot;character&quot;:6,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:76,&quot;character&quot;:8,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:76,&quot;character&quot;:13,&quot;text&quot;:&quot;push&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:80,&quot;character&quot;:8,&quot;text&quot;:&quot;Qp&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:82,&quot;character&quot;:6,&quot;text&quot;:&quot;Qp&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:85,&quot;character&quot;:8,&quot;text&quot;:&quot;P&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:87,&quot;character&quot;:6,&quot;text&quot;:&quot;P&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:94,&quot;character&quot;:6,&quot;text&quot;:&quot;P&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:95,&quot;character&quot;:6,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:97,&quot;character&quot;:8,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:98,&quot;character&quot;:8,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:98,&quot;character&quot;:18,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:102,&quot;character&quot;:8,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:103,&quot;character&quot;:8,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:112,&quot;character&quot;:8,&quot;text&quot;:&quot;Qp&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:114,&quot;character&quot;:10,&quot;text&quot;:&quot;Qp&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:114,&quot;character&quot;:19,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:114,&quot;character&quot;:29,&quot;text&quot;:&quot;P&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:116,&quot;character&quot;:15,&quot;text&quot;:&quot;P&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:116,&quot;character&quot;:22,&quot;text&quot;:&quot;Qp&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:121,&quot;character&quot;:29,&quot;text&quot;:&quot;Qp&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:132,&quot;character&quot;:21,&quot;text&quot;:&quot;Qp&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:132,&quot;character&quot;:36,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:133,&quot;character&quot;:8,&quot;text&quot;:&quot;P&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:135,&quot;character&quot;:32,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:135,&quot;character&quot;:46,&quot;text&quot;:&quot;Qp&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:138,&quot;character&quot;:10,&quot;text&quot;:&quot;Qp&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:138,&quot;character&quot;:19,&quot;text&quot;:&quot;Qp&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:138,&quot;character&quot;:34,&quot;text&quot;:&quot;Q&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:139,&quot;character&quot;:10,&quot;text&quot;:&quot;P&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:162,&quot;character&quot;:8,&quot;text&quot;:&quot;startIndices&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:163,&quot;character&quot;:4,&quot;text&quot;:&quot;startIndices&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:165,&quot;character&quot;:6,&quot;text&quot;:&quot;startIndices&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:165,&quot;character&quot;:24,&quot;text&quot;:&quot;startIndices&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:178,&quot;character&quot;:8,&quot;text&quot;:&quot;votes&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:180,&quot;character&quot;:6,&quot;text&quot;:&quot;votes&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:183,&quot;character&quot;:8,&quot;text&quot;:&quot;pairwiseProb&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:185,&quot;character&quot;:6,&quot;text&quot;:&quot;pairwiseProb&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:187,&quot;character&quot;:8,&quot;text&quot;:&quot;pairwiseProb&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:187,&quot;character&quot;:24,&quot;text&quot;:&quot;push&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:194,&quot;character&quot;:12,&quot;text&quot;:&quot;si&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:194,&quot;character&quot;:17,&quot;text&quot;:&quot;startIndices&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:195,&quot;character&quot;:12,&quot;text&quot;:&quot;sj&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:195,&quot;character&quot;:17,&quot;text&quot;:&quot;startIndices&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:205,&quot;character&quot;:25,&quot;text&quot;:&quot;si&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:205,&quot;character&quot;:41,&quot;text&quot;:&quot;si&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:209,&quot;character&quot;:25,&quot;text&quot;:&quot;sj&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:209,&quot;character&quot;:41,&quot;text&quot;:&quot;sj&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:233,&quot;character&quot;:8,&quot;text&quot;:&quot;pairwiseProb&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;extensions/classifiers/svm-prediction.service.ts&quot;,&quot;line&quot;:234,&quot;character&quot;:8,&quot;text&quot;:&quot;pairwiseProb&quot;,&quot;kind&quot;:2}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:55 GMT</p>
    </body>
  </html>
  