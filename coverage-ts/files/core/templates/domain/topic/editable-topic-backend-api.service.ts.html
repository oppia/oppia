
  <!DOCTYPE html>
  <html>
    <head>
      <title>editable-topic-backend-api.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">core/templates/domain/topic/editable-topic-backend-api.service.ts</td><td class="">94.98%</td><td class="">100%</td><td class="">418</td><td class="">397</td><td class="">21</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2018 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Service to send changes to a topic to the backend.
 */

import { HttpClient } from &#x27;@angular/common/http&#x27;;
import { Injectable } from &#x27;@angular/core&#x27;;
import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;

import { AppConstants } from &#x27;app.constants&#x27;;
import { BackendChangeObject } from &#x27;domain/editor/undo_redo/change.model&#x27;;
import { RubricBackendDict } from &#x27;domain/skill/rubric.model&#x27;;
import { SkillSummaryBackendDict } from &#x27;domain/skill/skill-summary.model&#x27;;
import { StorySummaryBackendDict } from &#x27;domain/story/story-summary.model&#x27;;
import { SkillIdToDescriptionMap } from &#x27;domain/topic/subtopic.model&#x27;;
import { SubtopicPageBackendDict } from &#x27;domain/topic/subtopic-page.model&#x27;;
import { TopicBackendDict } from &#x27;domain/topic/TopicObjectFactory&#x27;;
import { TopicDomainConstants } from &#x27;domain/topic/topic-domain.constants&#x27;;
import { UrlInterpolationService } from &#x27;domain/utilities/url-interpolation.service&#x27;;

interface FetchTopicBackendResponse {
  &#x27;topic_dict&#x27;: TopicBackendDict;
  &#x27;grouped_skill_summary_dicts&#x27;: {
    [topicName: string]: SkillSummaryBackendDict[];
  };
  &#x27;skill_id_to_description_dict&#x27;: SkillIdToDescriptionMap;
  &#x27;skill_question_count_dict&#x27;: {
    [skillId: string]: number;
  };
  &#x27;skill_id_to_rubrics_dict&#x27;: {
    [skillId: string]: RubricBackendDict[];
  };
  &#x27;classroom_url_fragment&#x27;: string;
  &#x27;skill_creation_is_allowed&#x27;: boolean;
}

interface FetchTopicResponse {
  topicDict: TopicBackendDict;
  groupedSkillSummaries: {
    [topicName: string]: SkillSummaryBackendDict[];
  };
  skillIdToDescriptionDict: SkillIdToDescriptionMap;
  skillQuestionCountDict: {
    [skillId: string]: number;
  };
  skillIdToRubricsDict: {
    [skillId: string]: RubricBackendDict[];
  };
  classroomUrlFragment: string;
  skillCreationIsAllowed: boolean;
}

interface FetchStoriesBackendResponse {
  &#x27;canonical_story_summary_dicts&#x27;: StorySummaryBackendDict[];
}

interface FetchSubtopicPageBackendResponse {
  &#x27;subtopic_page&#x27;: SubtopicPageBackendDict;
}

interface DeleteTopicBackendResponse {
  status: number;
}

interface UpdateTopicBackendResponse {
  &#x27;topic_dict&#x27;: TopicBackendDict;
  &#x27;skill_id_to_description_dict&#x27;: SkillIdToDescriptionMap;
  &#x27;skill_id_to_rubrics_dict&#x27;: {
    [skillId: string]: RubricBackendDict[];
  };
}

interface UpdateTopicResponse {
  topicDict: TopicBackendDict;
  skillIdToDescriptionDict: SkillIdToDescriptionMap;
  skillIdToRubricsDict: {
    [skillId: string]: RubricBackendDict[];
  };
}

interface DoesTopicWithUrlFragmentExistBackendResponse {
  &#x27;topic_url_fragment_exists&#x27;: boolean;
}

interface DoesTopicWithNameExistBackendResponse {
  &#x27;topic_name_exists&#x27;: boolean;
}

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class EditableTopicBackendApiService {
  constructor(
    private http: HttpClient,
    private urlInterpolationService: UrlInterpolationService) {}

  private _fetchTopic(
      topicId: string,
      successCallback: (value?: FetchTopicResponse) =&gt; void,
      errorCallback: (reason?: string) =&gt; void): void {
    let topicDataUrl = this.urlInterpolationService.interpolateUrl(
      AppConstants.EDITABLE_TOPIC_DATA_URL_TEMPLATE, {
        topic_id: topicId
      });

    this.http.get&lt;FetchTopicBackendResponse&gt;(
      topicDataUrl).toPromise().then((response) =&gt; {
      if (successCallback) {
        // The response is passed as a dict with 2 fields and not as 2
        // parameters, because the successCallback is called as the resolve
        // callback function in $q in fetchTopic(), and according to its
        // documentation (https://docs.angularjs.org/api/ng/service/$q),
        // resolve or reject can have only a single parameter.
        successCallback({
          topicDict: response.topic_dict,
          groupedSkillSummaries: response.grouped_skill_summary_dicts,
          skillIdToDescriptionDict: response.skill_id_to_description_dict,
          skillQuestionCountDict: {
            ...response.skill_question_count_dict
          },
          skillIdToRubricsDict: response.skill_id_to_rubrics_dict,
          classroomUrlFragment: response.classroom_url_fragment,
          skillCreationIsAllowed: response.skill_creation_is_allowed
        });
      }
    }, (errorResponse) =&gt; {
      errorCallback(errorResponse.error);
    });
  }

  private _fetchStories(
      topicId: string,
      successCallback: (value?: StorySummaryBackendDict[]) =&gt; void,
      errorCallback: (reason?: string) =&gt; void): void {
    let storiesDataUrl = this.urlInterpolationService.interpolateUrl(
      TopicDomainConstants.TOPIC_EDITOR_STORY_URL_TEMPLATE, {
        topic_id: topicId
      });

    this.http.get&lt;FetchStoriesBackendResponse&gt;(
      storiesDataUrl).toPromise().then((response) =&gt; {
      let canonicalStorySummaries = response.canonical_story_summary_dicts;
      if (successCallback) {
        successCallback(canonicalStorySummaries);
      }
    }, (errorResponse) =&gt; {
      errorCallback(errorResponse.error);
    });
  }

  private _fetchSubtopicPage(
      topicId: string,
      subtopicId: number,
      successCallback: (value?: SubtopicPageBackendDict) =&gt; void,
      errorCallback: (reason?: string) =&gt; void): void {
    let subtopicPageDataUrl = this.urlInterpolationService.interpolateUrl(
      AppConstants.SUBTOPIC_PAGE_EDITOR_DATA_URL_TEMPLATE, {
        topic_id: topicId,
        subtopic_id: subtopicId.toString()
      });

    this.http.get&lt;FetchSubtopicPageBackendResponse&gt;(
      subtopicPageDataUrl).toPromise().then((response) =&gt; {
      let topic = (response.subtopic_page);
      if (successCallback) {
        successCallback(topic);
      }
    }, (errorResponse) =&gt; {
      errorCallback(errorResponse.error);
    });
  }

  private _deleteTopic(
      topicId: string,
      successCallback: (value?: number) =&gt; void,
      errorCallback: (reason?: string) =&gt; void): void {
    let topicDataUrl = this.urlInterpolationService.interpolateUrl(
      AppConstants.EDITABLE_TOPIC_DATA_URL_TEMPLATE, {
        topic_id: topicId
      });
    this.http.delete&lt;DeleteTopicBackendResponse&gt;(
      topicDataUrl).toPromise().then((response) =&gt; {
      if (successCallback) {
        successCallback(response.status);
      }
    }, (errorResponse) =&gt; {
      errorCallback(errorResponse.error);
    });
  }

  private _updateTopic(
      topicId: string,
      topicVersion: number,
      commitMessage: string,
      changeList: BackendChangeObject[],
      successCallback: (value?: UpdateTopicResponse) =&gt; void,
      errorCallback: (reason?: string) =&gt; void): void {
    let editableTopicDataUrl = this.urlInterpolationService.interpolateUrl(
      AppConstants.EDITABLE_TOPIC_DATA_URL_TEMPLATE, {
        topic_id: topicId
      });

    let putData = {
      version: topicVersion,
      commit_message: commitMessage,
      topic_and_subtopic_page_change_dicts: changeList
    };
    this.http.put&lt;UpdateTopicBackendResponse&gt;(
      editableTopicDataUrl, putData).toPromise().then((response) =&gt; {
      if (successCallback) {
        // Here also, a dict with 2 fields are passed instead of just 2
        // parameters, due to the same reason as written for _fetchTopic().
        successCallback({
          topicDict: response.topic_dict,
          skillIdToDescriptionDict: response.skill_id_to_description_dict,
          skillIdToRubricsDict: response.skill_id_to_rubrics_dict
        });
      }
    }, (errorResponse) =&gt; {
      errorCallback(errorResponse.error);
    });
  }

  private _doesTopicWithUrlFragmentExist(
      topicUrlFragment: string,
      successCallback: (value?: boolean) =&gt; void,
      errorCallback: (reason?: string) =&gt; void): void {
    let topicUrlFragmentUrl = this.urlInterpolationService.interpolateUrl(
      TopicDomainConstants.TOPIC_URL_FRAGMENT_HANDLER_URL_TEMPLATE, {
        topic_url_fragment: topicUrlFragment
      });
    this.http.get&lt;DoesTopicWithUrlFragmentExistBackendResponse&gt;(
      topicUrlFragmentUrl).toPromise().then((response) =&gt; {
      if (successCallback) {
        successCallback(response.topic_url_fragment_exists);
      }
    }, (errorResponse) =&gt; {
      errorCallback(errorResponse.error);
    });
  }

  private _doesTopicWithNameExist(
      topicName: string,
      successCallback: (value?: boolean) =&gt; void,
      errorCallback: (reason?: string) =&gt; void): void {
    let topicNameUrl = this.urlInterpolationService.interpolateUrl(
      TopicDomainConstants.TOPIC_NAME_HANDLER_URL_TEMPLATE, {
        topic_name: topicName
      });
    this.http.get&lt;DoesTopicWithNameExistBackendResponse&gt;(
      topicNameUrl).toPromise().then((response) =&gt; {
      if (successCallback) {
        successCallback(response.topic_name_exists);
      }
    }, (errorResponse) =&gt; {
      errorCallback(errorResponse.error);
    });
  }

  async fetchTopicAsync(topicId: string): Promise&lt;FetchTopicResponse&gt; {
    return new Promise((resolve, reject) =&gt; {
      this._fetchTopic(topicId, resolve, reject);
    });
  }

  async fetchStoriesAsync(topicId: string): Promise&lt;StorySummaryBackendDict[]&gt; {
    return new Promise((resolve, reject) =&gt; {
      this._fetchStories(topicId, resolve, reject);
    });
  }

  async fetchSubtopicPageAsync(
      topicId: string,
      subtopicId: number): Promise&lt;SubtopicPageBackendDict&gt; {
    return new Promise((resolve, reject) =&gt; {
      this._fetchSubtopicPage(topicId, subtopicId, resolve, reject);
    });
  }

  /**
   * Updates a topic in the backend with the provided topic ID.
   * The changes only apply to the topic of the given version and the
   * request to update the topic will fail if the provided topic
   * version is older than the current version stored in the backend. Both
   * the changes and the message to associate with those changes are used
   * to commit a change to the topic. The new topic is passed to
   * the success callback, if one is provided to the returned promise
   * object. Errors are passed to the error callback, if one is provided.
   */
  async updateTopicAsync(
      topicId: string,
      topicVersion: number,
      commitMessage: string,
      changeList: BackendChangeObject[]): Promise&lt;UpdateTopicResponse&gt; {
    return new Promise((resolve, reject) =&gt; {
      this._updateTopic(
        topicId, topicVersion, commitMessage, changeList,
        resolve, reject);
    });
  }

  async deleteTopicAsync(topicId: string): Promise&lt;number&gt; {
    return new Promise((resolve, reject) =&gt; {
      this._deleteTopic(topicId, resolve, reject);
    });
  }

  async doesTopicWithNameExistAsync(topicName: string):
      Promise&lt;boolean&gt; {
    return new Promise((resolve, reject) =&gt; {
      this._doesTopicWithNameExist(topicName, resolve, reject);
    });
  }

  async doesTopicWithUrlFragmentExistAsync(topicUrlFragment: string):
       Promise&lt;boolean&gt; {
    return new Promise((resolve, reject) =&gt; {
      this._doesTopicWithUrlFragmentExist(topicUrlFragment, resolve, reject);
    });
  }
}

angular.module(&#x27;oppia&#x27;).factory(
  &#x27;EditableTopicBackendApiService&#x27;,
  downgradeInjectable(EditableTopicBackendApiService));
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:138,&quot;character&quot;:8,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:139,&quot;character&quot;:20,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:139,&quot;character&quot;:34,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:158,&quot;character&quot;:8,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:159,&quot;character&quot;:20,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:159,&quot;character&quot;:34,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:180,&quot;character&quot;:8,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:181,&quot;character&quot;:20,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:181,&quot;character&quot;:34,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:198,&quot;character&quot;:8,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:199,&quot;character&quot;:20,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:199,&quot;character&quot;:34,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:231,&quot;character&quot;:8,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:232,&quot;character&quot;:20,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:232,&quot;character&quot;:34,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:249,&quot;character&quot;:8,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:250,&quot;character&quot;:20,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:250,&quot;character&quot;:34,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:267,&quot;character&quot;:8,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:268,&quot;character&quot;:20,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/topic/editable-topic-backend-api.service.ts&quot;,&quot;line&quot;:268,&quot;character&quot;:34,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:55 GMT</p>
    </body>
  </html>
  