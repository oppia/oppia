
  <!DOCTYPE html>
  <html>
    <head>
      <title>url-interpolation.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">core/templates/domain/utilities/url-interpolation.service.ts</td><td class="">98.72%</td><td class="">100%</td><td class="">235</td><td class="">232</td><td class="">3</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2015 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Service to construct URLs by inserting variables within them as
 * necessary to have a fully-qualified URL.
 */

import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;
import { Injectable } from &#x27;@angular/core&#x27;;

import { AlertsService } from &#x27;services/alerts.service&#x27;;
import { UrlService } from &#x27;services/contextual/url.service&#x27;;
import { UtilsService } from &#x27;services/utils.service&#x27;;

import { AppConstants } from &#x27;app.constants&#x27;;
const hashes = require(&#x27;hashes.json&#x27;);

// This makes the InterpolationValuesType like a dict whose keys and values both
// are string.
export interface InterpolationValuesType {
  [param: string]: string
}

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class UrlInterpolationService {
  constructor(
    private alertsService: AlertsService,
    private urlService: UrlService,
    private utilsService: UtilsService) {}

  get DEV_MODE(): boolean {
    return AppConstants.DEV_MODE;
  }

  validateResourcePath(resourcePath: string): void {
    if (!resourcePath) {
      this.alertsService.fatalWarning(&#x27;Empty path passed in method.&#x27;);
    }

    const RESOURCE_PATH_STARTS_WITH_FORWARD_SLASH = /^\//;
    // Ensure that resourcePath starts with a forward slash.
    if (!resourcePath.match(RESOURCE_PATH_STARTS_WITH_FORWARD_SLASH)) {
      this.alertsService.fatalWarning(
        &#x27;Path must start with \&#x27;\/\&#x27;: \&#x27;&#x27; + resourcePath + &#x27;\&#x27;.&#x27;);
    }
  }

  /**
   * Given a resource path relative to subfolder in /,
   * returns resource path with cache slug.
   */
  _getUrlWithSlug(resourcePath: string): string {
    if (!this.DEV_MODE) {
      if (hashes[resourcePath]) {
        let index = resourcePath.lastIndexOf(&#x27;.&#x27;);
        return (
          resourcePath.slice(0, index) + &#x27;.&#x27; + hashes[resourcePath] +
          resourcePath.slice(index));
      }
    }
    return resourcePath;
  }

  /**
   * Given a resource path relative to subfolder in /,
   * returns complete resource path with cache slug and prefixed with url
   * depending on dev/prod mode.
   */
  _getCompleteUrl(prefix: string, path: string): string {
    if (this.DEV_MODE) {
      return prefix + this._getUrlWithSlug(path);
    } else {
      return &#x27;/build&#x27; + prefix + this._getUrlWithSlug(path);
    }
  }

  /**
   * Given a resource path relative to extensions folder,
   * returns the complete url path to that resource.
   */
  getExtensionResourceUrl(resourcePath: string): string {
    this.validateResourcePath(resourcePath);
    return this._getCompleteUrl(&#x27;/extensions&#x27;, resourcePath);
  }

  /**
   * Given a formatted URL, interpolates the URL by inserting values the URL
   * needs using the interpolationValues object. For example, urlTemplate
   * might be:
   *
   *   /createhandler/resolved_answers/&lt;exploration_id&gt;/&lt;escaped_state_name&gt;
   *
   * interpolationValues is an object whose keys are variables within the
   * URL. For the above example, interpolationValues may look something
   * like:
   *
   *   { &#x27;exploration_id&#x27;: &#x27;0&#x27;, &#x27;escaped_state_name&#x27;: &#x27;InputBinaryNumber&#x27; }
   *
   * If a URL requires a value which is not keyed within the
   * interpolationValues object, this will return null.
   */
  interpolateUrl(
      urlTemplate: string,
      interpolationValues: InterpolationValuesType): string | null {
    if (!urlTemplate) {
      this.alertsService.fatalWarning(
        &#x27;Invalid or empty URL template passed in: \&#x27;&#x27; + urlTemplate + &#x27;\&#x27;&#x27;);
      return null;
    }

    // http://stackoverflow.com/questions/4775722
    if (!(interpolationValues instanceof Object) || (
      Object.prototype.toString.call(
        interpolationValues) === &#x27;[object Array]&#x27;)) {
      this.alertsService.fatalWarning(
        &#x27;Expected an object of interpolation values to be passed into &#x27; +
          &#x27;interpolateUrl.&#x27;);
      return null;
    }

    // Valid pattern: &lt;alphanum&gt;
    let INTERPOLATION_VARIABLE_REGEX = /&lt;(\w+)&gt;/;

    // Invalid patterns: &lt;&lt;stuff&gt;&gt;, &lt;stuff&gt;&gt;&gt;, &lt;&gt;
    let EMPTY_VARIABLE_REGEX = /&lt;&gt;/;
    let INVALID_VARIABLE_REGEX = /(&lt;{2,})(\w*)(&gt;{2,})/;

    if (urlTemplate.match(INVALID_VARIABLE_REGEX) ||
        urlTemplate.match(EMPTY_VARIABLE_REGEX)) {
      this.alertsService.fatalWarning(
        &#x27;Invalid URL template received: \&#x27;&#x27; + urlTemplate + &#x27;\&#x27;&#x27;);
      return null;
    }

    let nonStringParams = Object.entries(interpolationValues).filter(
      ([key, val]) =&gt; !this.utilsService.isString(val));
    if (nonStringParams.length &gt; 0) {
      this.alertsService.fatalWarning(
        &#x27;Every parameter passed into interpolateUrl must have string values, &#x27; +
        &#x27;but received: {&#x27; + nonStringParams.map(
          ([key, val]) =&gt; key + &#x27;: &#x27; + angular.toJson(val)).join(&#x27;, &#x27;) + &#x27;}&#x27;);
    }

    let escapedInterpolationValues: Record&lt;string, string&gt; = {};
    for (let varName in interpolationValues) {
      let value = interpolationValues[varName];
      escapedInterpolationValues[varName] = encodeURIComponent(value);
    }

    // Ensure the URL has no nested brackets (which would lead to
    // indirection in the interpolated variables).
    let filledUrl = urlTemplate;
    let match = filledUrl.match(INTERPOLATION_VARIABLE_REGEX);
    while (match) {
      let currentVarName = match[1];
      if (!escapedInterpolationValues.hasOwnProperty(currentVarName)) {
        this.alertsService.fatalWarning(
          &#x27;Expected variable \&#x27;&#x27; + currentVarName +
          &#x27;\&#x27; when interpolating URL.&#x27;);
        return null;
      }
      filledUrl = filledUrl.replace(
        INTERPOLATION_VARIABLE_REGEX,
        escapedInterpolationValues[currentVarName]);
      match = filledUrl.match(INTERPOLATION_VARIABLE_REGEX);
    }
    return filledUrl;
  }

  /**
   * Given an image path relative to /assets/images folder,
   * returns the complete url path to that image.
   */
  getStaticImageUrl(imagePath: string): string {
    this.validateResourcePath(imagePath);
    return this._getCompleteUrl(&#x27;/assets&#x27;, &#x27;/images&#x27; + imagePath);
  }

  /**
   * Given a video path relative to /assets/videos folder,
   * returns the complete url path to that image.
   */
  getStaticVideoUrl(videoPath: string): string {
    this.validateResourcePath(videoPath);
    return this._getCompleteUrl(&#x27;/assets&#x27;, &#x27;/videos&#x27; + videoPath);
  }

  /**
   * Given a path relative to /assets folder, returns the complete url path
   * to that asset.
   */
  getStaticAssetUrl(assetPath: string): string {
    this.validateResourcePath(assetPath);
    return this._getCompleteUrl(&#x27;/assets&#x27;, assetPath);
  }

  getFullStaticAssetUrl(path: string): string {
    this.validateResourcePath(path);
    if (this.DEV_MODE) {
      return this.urlService.getOrigin() + path;
    } else {
      return this.urlService.getOrigin() + &#x27;/build&#x27; + path;
    }
  }

  /**
   * Given an interaction id, returns the complete url path to
   * the thumbnail image for the interaction.
   */
  getInteractionThumbnailImageUrl(interactionId: string): string {
    if (!interactionId) {
      this.alertsService.fatalWarning(
        &#x27;Empty interactionId passed in getInteractionThumbnailImageUrl.&#x27;);
    }
    return this.getExtensionResourceUrl(
      &#x27;/interactions/&#x27; + interactionId + &#x27;/static/&#x27; + interactionId + &#x27;.png&#x27;);
  }

  /**
   * Given a directive path relative to head folder,
   * returns the complete url path to that directive.
   */
  getDirectiveTemplateUrl(path: string): string {
    this.validateResourcePath(path);
    if (this.DEV_MODE) {
      return &#x27;/templates&#x27; + this._getUrlWithSlug(path);
    } else {
      return &#x27;/build/templates&#x27; + this._getUrlWithSlug(path);
    }
  }
}

angular.module(&#x27;oppia&#x27;).factory(
  &#x27;UrlInterpolationService&#x27;,
  downgradeInjectable(UrlInterpolationService));
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;core/templates/domain/utilities/url-interpolation.service.ts&quot;,&quot;line&quot;:27,&quot;character&quot;:6,&quot;text&quot;:&quot;hashes&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/utilities/url-interpolation.service.ts&quot;,&quot;line&quot;:67,&quot;character&quot;:10,&quot;text&quot;:&quot;hashes&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/domain/utilities/url-interpolation.service.ts&quot;,&quot;line&quot;:70,&quot;character&quot;:47,&quot;text&quot;:&quot;hashes&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:54 GMT</p>
    </body>
  </html>
  