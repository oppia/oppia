
  <!DOCTYPE html>
  <html>
    <head>
      <title>answer-classification.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">core/templates/pages/exploration-player-page/services/answer-classification.service.ts</td><td class="">96.43%</td><td class="">100%</td><td class="">224</td><td class="">216</td><td class="">8</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2015 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Classification service for answer groups.
 */

import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;
import { Injectable } from &#x27;@angular/core&#x27;;

import { AlertsService } from &#x27;services/alerts.service&#x27;;
import { AnswerClassificationResult }
  from &#x27;domain/classifier/answer-classification-result.model&#x27;;
import { AnswerGroup } from &#x27;domain/exploration/AnswerGroupObjectFactory&#x27;;
import { AppService } from &#x27;services/app.service&#x27;;
import { ExplorationPlayerConstants } from
  &#x27;pages/exploration-player-page/exploration-player-page.constants&#x27;;
import { InteractionAnswer } from &#x27;interactions/answer-defs&#x27;;
import { Interaction } from &#x27;domain/exploration/InteractionObjectFactory&#x27;;
import { InteractionSpecsService } from &#x27;services/interaction-specs.service&#x27;;
import { Outcome } from &#x27;domain/exploration/OutcomeObjectFactory&#x27;;
import { PredictionAlgorithmRegistryService }
  // eslint-disable-next-line max-len
  from &#x27;pages/exploration-player-page/services/prediction-algorithm-registry.service&#x27;;
import { State } from &#x27;domain/state/StateObjectFactory&#x27;;
import { StateClassifierMappingService } from
  &#x27;pages/exploration-player-page/services/state-classifier-mapping.service&#x27;;
import { InteractionRuleInputs } from &#x27;interactions/rule-input-defs&#x27;;

export interface InteractionRulesService {
  [ruleName: string]: (
    answer: InteractionAnswer, ruleInputs: InteractionRuleInputs) =&gt; boolean;
}

@Injectable({providedIn: &#x27;root&#x27;})
export class AnswerClassificationService {
  constructor(
      private alertsService: AlertsService,
      private appService: AppService,
      private interactionSpecsService: InteractionSpecsService,
      private predictionAlgorithmRegistryService:
        PredictionAlgorithmRegistryService,
      private stateClassifierMappingService: StateClassifierMappingService) {}

  /**
   * Finds the first answer group with a rule that returns true.
   *
   * @param answer - The answer that the user has submitted.
   * @param answerGroups - The answer groups of the interaction. Each answer
   *     group contains rule_specs, which is a list of rules.
   * @param defaultOutcome - The default outcome of the interaction.
   * @param interactionRulesService The service which contains the explicit
   *     rules of that interaction.
   *
   * @return AnswerClassificationResult domain object.
   */
  private classifyAnswer(
      answer: InteractionAnswer,
      answerGroups: AnswerGroup[],
      defaultOutcome: Outcome,
      interactionRulesService): AnswerClassificationResult {
    // Find the first group that contains a rule which returns true
    // TODO(bhenning): Implement training data classification.
    for (var i = 0; i &lt; answerGroups.length; ++i) {
      const answerGroup = answerGroups[i];
      for (var j = 0; j &lt; answerGroup.rules.length; ++j) {
        const rule = answerGroup.rules[j];
        if (interactionRulesService[rule.type](answer, rule.inputs)) {
          return new AnswerClassificationResult(
            answerGroup.outcome, i, j,
            ExplorationPlayerConstants.EXPLICIT_CLASSIFICATION);
        }
      }
    }

    // If no rule in any answer group returns true, the default &#x27;group&#x27; is
    // returned. Throws an error if the default outcome is not defined.
    if (defaultOutcome) {
      return new AnswerClassificationResult(
        defaultOutcome, answerGroups.length, 0,
        ExplorationPlayerConstants.DEFAULT_OUTCOME_CLASSIFICATION);
    } else {
      this.alertsService.addWarning(
        &#x27;Something went wrong with the exploration.&#x27;);
    }
  }

  /**
   * Classifies the answer according to the answer groups. and returns the
   * corresponding answer classification result.
   *
   * @param stateName - The name of the state where the user submitted the
   *     answer.
   * @param interactionInOldState - The interaction present in the state where
   *     the user submitted the answer.
   * @param answer - The answer that the user has submitted.
   * @param interactionRulesService - The service which contains the explicit
   *     rules of that interaction.
   *
   * @return The resulting AnswerClassificationResult domain object.
   */
  getMatchingClassificationResult(
      stateName: string,
      interactionInOldState: Interaction,
      answer: InteractionAnswer,
      interactionRulesService: InteractionRulesService):
      AnswerClassificationResult {
    var answerClassificationResult = null;

    const answerGroups = interactionInOldState.answerGroups;
    const defaultOutcome = interactionInOldState.defaultOutcome;
    if (interactionRulesService) {
      answerClassificationResult = this.classifyAnswer(
        answer, answerGroups, defaultOutcome, interactionRulesService);
    } else {
      this.alertsService.addWarning(
        &#x27;Something went wrong with the exploration: no &#x27; +
        &#x27;interactionRulesService was available.&#x27;);
      throw new Error(
        &#x27;No interactionRulesService was available to classify the answer.&#x27;);
    }

    const ruleBasedOutcomeIsDefault = (
      answerClassificationResult.outcome === defaultOutcome);
    const interactionIsTrainable =
      this.interactionSpecsService.isInteractionTrainable(
        interactionInOldState.id);

    if (ruleBasedOutcomeIsDefault &amp;&amp; interactionIsTrainable) {
      for (var i = 0; i &lt; answerGroups.length; ++i) {
        const answerGroup = answerGroups[i];
        if (!answerGroup.trainingData) {
          continue;
        }
        for (const trainingDatum of answerGroup.trainingData) {
          if (angular.equals(answer, trainingDatum)) {
            return new AnswerClassificationResult(
              answerGroup.outcome, i, null,
              ExplorationPlayerConstants.TRAINING_DATA_CLASSIFICATION);
          }
        }
      }
      if (this.appService.isMachineLearningClassificationEnabled()) {
        const classifier = (
          this.stateClassifierMappingService.getClassifier(stateName));
        if (classifier &amp;&amp; classifier.classifierData &amp;&amp;
            classifier.algorithmId &amp;&amp; classifier.algorithmVersion) {
          const predictionService = (
            this.predictionAlgorithmRegistryService.getPredictionService(
              classifier.algorithmId, classifier.algorithmVersion));
          // If prediction service exists, we run classifier. We return the
          // default outcome otherwise.
          if (predictionService) {
            const predictedAnswerGroupIndex = predictionService.predict(
              classifier.classifierData, answer);
            if (predictedAnswerGroupIndex === -1) {
              answerClassificationResult = (
                new AnswerClassificationResult(
                  defaultOutcome, answerGroups.length, 0,
                  ExplorationPlayerConstants.DEFAULT_OUTCOME_CLASSIFICATION));
            } else {
              answerClassificationResult = (
                new AnswerClassificationResult(
                  answerGroups[predictedAnswerGroupIndex].outcome,
                  predictedAnswerGroupIndex, null,
                  ExplorationPlayerConstants.STATISTICAL_CLASSIFICATION));
            }
          }
        }
      }
    }

    return answerClassificationResult;
  }

  isClassifiedExplicitlyOrGoesToNewState(
      stateName: string, state: State, answer: InteractionAnswer,
      interactionRulesService: InteractionRulesService): boolean {
    const result = this.getMatchingClassificationResult(
      stateName, state.interaction, answer, interactionRulesService);
    return (
      result.outcome.dest !== state.name ||
      result.classificationCategorization !==
        ExplorationPlayerConstants.DEFAULT_OUTCOME_CLASSIFICATION);
  }
}

angular.module(&#x27;oppia&#x27;).factory(
  &#x27;AnswerClassificationService&#x27;,
  downgradeInjectable(AnswerClassificationService));
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/answer-classification.service.ts&quot;,&quot;line&quot;:71,&quot;character&quot;:6,&quot;text&quot;:&quot;interactionRulesService&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/answer-classification.service.ts&quot;,&quot;line&quot;:78,&quot;character&quot;:12,&quot;text&quot;:&quot;interactionRulesService&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/answer-classification.service.ts&quot;,&quot;line&quot;:118,&quot;character&quot;:8,&quot;text&quot;:&quot;answerClassificationResult&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/answer-classification.service.ts&quot;,&quot;line&quot;:123,&quot;character&quot;:6,&quot;text&quot;:&quot;answerClassificationResult&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/answer-classification.service.ts&quot;,&quot;line&quot;:134,&quot;character&quot;:6,&quot;text&quot;:&quot;answerClassificationResult&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/answer-classification.service.ts&quot;,&quot;line&quot;:134,&quot;character&quot;:33,&quot;text&quot;:&quot;outcome&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/answer-classification.service.ts&quot;,&quot;line&quot;:167,&quot;character&quot;:14,&quot;text&quot;:&quot;answerClassificationResult&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/answer-classification.service.ts&quot;,&quot;line&quot;:172,&quot;character&quot;:14,&quot;text&quot;:&quot;answerClassificationResult&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:55 GMT</p>
    </body>
  </html>
  