
  <!DOCTYPE html>
  <html>
    <head>
      <title>hints-and-solution-manager.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts</td><td class="">87.93%</td><td class="">100%</td><td class="">290</td><td class="">255</td><td class="">35</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2017 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Utility service for Hints in the learner&#x27;s view.
 */

import { EventEmitter, Injectable } from &#x27;@angular/core&#x27;;
import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;

import { Hint } from &#x27;domain/exploration/HintObjectFactory&#x27;;
import { Solution } from &#x27;domain/exploration/SolutionObjectFactory&#x27;;
import { SubtitledHtml } from &#x27;domain/exploration/subtitled-html.model&#x27;;
import { ExplorationPlayerConstants } from &#x27;pages/exploration-player-page/exploration-player-page.constants&#x27;;
import { PlayerPositionService } from &#x27;pages/exploration-player-page/services/player-position.service&#x27;;

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class HintsAndSolutionManagerService {
  timeout = null;
  ACCELERATED_HINT_WAIT_TIME_MSEC: number = 10000;
  WAIT_FOR_TOOLTIP_TO_BE_SHOWN_MSEC: number = 20000;

  _solutionViewedEventEmitter = new EventEmitter();
  private _timeoutElapsedEventEmitter = new EventEmitter();
  onTimeoutElapsed$ = this._timeoutElapsedEventEmitter.asObservable();

  numHintsReleased: number = 0;
  numHintsConsumed: number = 0;
  solutionReleased: boolean = false;
  solutionConsumed: boolean = false;
  hintsForLatestCard: Hint[] = [];
  solutionForLatestCard: Solution = null;
  wrongAnswersSinceLastHintConsumed: number = 0;
  correctAnswerSubmitted: boolean = false;

  _hintConsumedEventEmitter = new EventEmitter();

  // Variable tooltipIsOpen is a flag which says that the tooltip is currently
  // visible to the learner.
  tooltipIsOpen: boolean = false;
  // This is set to true as soon as a hint/solution is clicked or when the
  // tooltip has been triggered.
  hintsDiscovered: boolean = false;
  tooltipTimeout = null;

  constructor(private playerPositionService: PlayerPositionService) {
    // TODO(#10904): Refactor to move subscriptions into components.
    playerPositionService.onNewCardAvailable.subscribe(
      () =&gt; {
        this.correctAnswerSubmitted = true;
        this.tooltipIsOpen = false;
      }
    );
  }

  // This replaces any timeouts that are already queued.
  enqueueTimeout(func: () =&gt; void, timeToWaitMsec: number): void {
    if (this.timeout) {
      clearTimeout(this.timeout);
    }

    this.timeout = setTimeout(func.bind(this), timeToWaitMsec);
  }

  showTooltip(): void {
    this.tooltipIsOpen = true;
    this.hintsDiscovered = true;
    this._timeoutElapsedEventEmitter.next();
  }

  releaseHint(): void {
    if (!this.correctAnswerSubmitted) {
      this.numHintsReleased++;
      if (!this.hintsDiscovered &amp;&amp; !this.tooltipTimeout) {
        this.tooltipTimeout = setTimeout(
          this.showTooltip.bind(this), this.WAIT_FOR_TOOLTIP_TO_BE_SHOWN_MSEC);
      }
    }
    this._timeoutElapsedEventEmitter.next();
  }
  releaseSolution(): void {
    this.solutionReleased = true;
    this._timeoutElapsedEventEmitter.next();
  }
  accelerateHintRelease(): void {
    this.enqueueTimeout(this.releaseHint, this.ACCELERATED_HINT_WAIT_TIME_MSEC);
  }

  areAllHintsExhausted(): boolean {
    return this.numHintsReleased === this.hintsForLatestCard.length;
  }
  isAHintWaitingToBeViewed(): boolean {
    return this.numHintsConsumed &lt; this.numHintsReleased;
  }

  consumeHint(): void {
    this.hintsDiscovered = true;
    this.tooltipIsOpen = false;
    if (this.tooltipTimeout) {
      clearTimeout(this.tooltipTimeout);
      this.tooltipTimeout = null;
    }
    this.numHintsConsumed++;
    this._hintConsumedEventEmitter.emit();
    this.wrongAnswersSinceLastHintConsumed = 0;

    let funcToEnqueue = null;
    if (!this.areAllHintsExhausted()) {
      funcToEnqueue = this.releaseHint;
    } else if (!!this.solutionForLatestCard &amp;&amp; !this.solutionReleased) {
      funcToEnqueue = this.releaseSolution;
    }
    if (funcToEnqueue) {
      this.enqueueTimeout(
        funcToEnqueue,
        ExplorationPlayerConstants.WAIT_FOR_SUBSEQUENT_HINTS_MSEC);
    }
  }

  reset(newHints: Hint[], newSolution: Solution): void {
    this.numHintsReleased = 0;
    this.numHintsConsumed = 0;
    this.solutionReleased = false;
    this.solutionConsumed = false;
    this.hintsForLatestCard = newHints;
    this.solutionForLatestCard = newSolution;
    this.wrongAnswersSinceLastHintConsumed = 0;
    this.correctAnswerSubmitted = false;
    if (this.timeout) {
      clearTimeout(this.timeout);
      this.timeout = null;
    }
    if (this.tooltipTimeout) {
      clearTimeout(this.tooltipTimeout);
      this.tooltipTimeout = null;
    }

    if (this.hintsForLatestCard.length &gt; 0) {
      this.enqueueTimeout(
        this.releaseHint,
        ExplorationPlayerConstants.WAIT_FOR_FIRST_HINT_MSEC);
    }
  }
  // WARNING: This method has a side-effect. If the retrieved hint is a
  // pending hint that&#x27;s being viewed, it starts the timer for the next
  // hint.
  displayHint(index: number): SubtitledHtml | null {
    if (index === this.numHintsConsumed &amp;&amp;
      this.numHintsConsumed &lt; this.numHintsReleased) {
      // The latest hint has been consumed. Start the timer.
      this.consumeHint();
    }

    if (index &lt; this.numHintsReleased) {
      return this.hintsForLatestCard[index].hintContent;
    }
    return null;
  }

  displaySolution(): Solution {
    this.hintsDiscovered = true;
    this.solutionConsumed = true;
    this._solutionViewedEventEmitter.emit();
    if (this.tooltipTimeout) {
      clearTimeout(this.tooltipTimeout);
      this.tooltipTimeout = null;
    }
    return this.solutionForLatestCard;
  }

  getNumHints(): number {
    return this.hintsForLatestCard.length;
  }

  isHintViewable(index: number): boolean {
    return index &lt; this.numHintsReleased;
  }

  isHintConsumed(index: number): boolean {
    return index &lt; this.numHintsConsumed;
  }

  isHintTooltipOpen(): boolean {
    return this.tooltipIsOpen;
  }

  isSolutionViewable(): boolean {
    return this.solutionReleased;
  }

  isSolutionConsumed(): boolean {
    return this.solutionConsumed;
  }

  recordWrongAnswer(): void {
    if (this.isAHintWaitingToBeViewed()) {
      return;
    }

    this.wrongAnswersSinceLastHintConsumed++;
    if (!this.areAllHintsExhausted()) {
      if (
        this.numHintsReleased === 0 &amp;&amp;
        this.wrongAnswersSinceLastHintConsumed &gt;= 2) {
        this.accelerateHintRelease();
      } else if (
        this.numHintsReleased &gt; 0 &amp;&amp;
        this.wrongAnswersSinceLastHintConsumed &gt;= 1) {
        this.accelerateHintRelease();
      }
    }
  }

  get onSolutionViewedEventEmitter(): EventEmitter&lt;unknown&gt; {
    return this._solutionViewedEventEmitter;
  }

  get onHintConsumed(): EventEmitter&lt;unknown&gt; {
    return this._hintConsumedEventEmitter;
  }
}

angular.module(&#x27;oppia&#x27;).factory(
  &#x27;HintsAndSolutionManagerService&#x27;,
  downgradeInjectable(HintsAndSolutionManagerService));
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:31,&quot;character&quot;:2,&quot;text&quot;:&quot;timeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:35,&quot;character&quot;:2,&quot;text&quot;:&quot;_solutionViewedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:36,&quot;character&quot;:10,&quot;text&quot;:&quot;_timeoutElapsedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:37,&quot;character&quot;:2,&quot;text&quot;:&quot;onTimeoutElapsed$&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:37,&quot;character&quot;:27,&quot;text&quot;:&quot;_timeoutElapsedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:48,&quot;character&quot;:2,&quot;text&quot;:&quot;_hintConsumedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:56,&quot;character&quot;:2,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:70,&quot;character&quot;:13,&quot;text&quot;:&quot;timeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:71,&quot;character&quot;:24,&quot;text&quot;:&quot;timeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:74,&quot;character&quot;:9,&quot;text&quot;:&quot;timeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:80,&quot;character&quot;:9,&quot;text&quot;:&quot;_timeoutElapsedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:86,&quot;character&quot;:41,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:87,&quot;character&quot;:13,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:91,&quot;character&quot;:9,&quot;text&quot;:&quot;_timeoutElapsedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:95,&quot;character&quot;:9,&quot;text&quot;:&quot;_timeoutElapsedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:111,&quot;character&quot;:13,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:112,&quot;character&quot;:24,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:113,&quot;character&quot;:11,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:116,&quot;character&quot;:9,&quot;text&quot;:&quot;_hintConsumedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:119,&quot;character&quot;:8,&quot;text&quot;:&quot;funcToEnqueue&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:121,&quot;character&quot;:6,&quot;text&quot;:&quot;funcToEnqueue&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:123,&quot;character&quot;:6,&quot;text&quot;:&quot;funcToEnqueue&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:125,&quot;character&quot;:8,&quot;text&quot;:&quot;funcToEnqueue&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:141,&quot;character&quot;:13,&quot;text&quot;:&quot;timeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:142,&quot;character&quot;:24,&quot;text&quot;:&quot;timeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:143,&quot;character&quot;:11,&quot;text&quot;:&quot;timeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:145,&quot;character&quot;:13,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:146,&quot;character&quot;:24,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:147,&quot;character&quot;:11,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:175,&quot;character&quot;:9,&quot;text&quot;:&quot;_solutionViewedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:176,&quot;character&quot;:13,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:177,&quot;character&quot;:24,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:178,&quot;character&quot;:11,&quot;text&quot;:&quot;tooltipTimeout&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:227,&quot;character&quot;:16,&quot;text&quot;:&quot;_solutionViewedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/exploration-player-page/services/hints-and-solution-manager.service.ts&quot;,&quot;line&quot;:231,&quot;character&quot;:16,&quot;text&quot;:&quot;_hintConsumedEventEmitter&quot;,&quot;kind&quot;:2}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:56 GMT</p>
    </body>
  </html>
  