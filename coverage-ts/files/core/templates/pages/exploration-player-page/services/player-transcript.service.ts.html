
  <!DOCTYPE html>
  <html>
    <head>
      <title>player-transcript.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">core/templates/pages/exploration-player-page/services/player-transcript.service.ts</td><td class="">100.00%</td><td class="">100%</td><td class="">186</td><td class="">186</td><td class="">0</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2017 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Service for the learner view transcript.
 */

// A service that maintains the transcript of the playthrough (i.e., what cards
// are shown, what answers have been given, etc. Note that this service does
// not maintain the currently-active card -- it&#x27;s more like a log of what the
// learner has &#x27;discovered&#x27; so far.

import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;
import { Injectable } from &#x27;@angular/core&#x27;;

import cloneDeep from &#x27;lodash/cloneDeep&#x27;;

import { LoggerService } from &#x27;services/contextual/logger.service&#x27;;
import { StateCard } from &#x27;domain/state_card/StateCardObjectFactory&#x27;;

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class PlayerTranscriptService {
  constructor(private log: LoggerService) {}
  // Each element of this array represents a &#x27;StateCard&#x27; domain object.
  //
  // Note that every card in this transcript is visible on the screen. The
  // &#x27;card.getDestStateName()&#x27; field is intended to identify transcripts where
  // there is a card &#x27;in reserve&#x27;, but the learner has not yet navigated to it
  // -- this happens if the current card offers feedback to the learner before
  // they carry on.
  transcript: StateCard[] = [];
  numAnswersSubmitted = 0;

  restore(oldTranscript: StateCard[]): void {
    this.transcript = cloneDeep(oldTranscript);
  }

  restoreImmutably(oldTranscript: StateCard[]): void {
    for (let i = 0; i &lt; this.transcript.length; i++) {
      // Immutably restore the cards so that Angular can detect changes.
      this.transcript[i].restoreImmutable(oldTranscript[i]);
    }
  }

  init(): void {
    this.transcript = [];
    this.numAnswersSubmitted = 0;
  }

  hasEncounteredStateBefore(stateName: string): boolean {
    return this.transcript.some(transcriptItem =&gt; {
      return transcriptItem.getStateName() === stateName;
    });
  }
  addNewCard(newCard: StateCard): void {
    this.transcript.push(newCard);
    this.numAnswersSubmitted = 0;
  }

  addPreviousCard(): void {
    if (this.transcript.length === 1) {
      throw new Error(
        &#x27;Exploration player is on the first card and hence no previous &#x27; +
          &#x27;card exists.&#x27;);
    }
    // TODO(aks681): Once worked examples are introduced, modify the below
    // line to take into account the number of worked examples displayed.
    let copyOfPreviousCard =
        cloneDeep(this.transcript[this.transcript.length - 2]);
    copyOfPreviousCard.markAsNotCompleted();
    this.transcript.push(copyOfPreviousCard);
  }

  addNewInput(input: string, isHint: boolean): void {
    let card = this.getLastCard();
    let pairs = card.getInputResponsePairs();
    if (pairs.length &gt; 0 &amp;&amp; card.getLastOppiaResponse() === null) {
      throw new Error(
        &#x27;Trying to add an input before the response for the previous &#x27; +
          &#x27;input has been received.&#x27;
      );
    }
    if (!isHint) {
      this.numAnswersSubmitted += 1;
    }
    this.transcript[this.transcript.length - 1].addInputResponsePair({
      learnerInput: input,
      oppiaResponse: null,
      isHint: isHint
    });
  }

  addNewResponse(response: string): void {
    let card = this.getLastCard();
    card.setLastOppiaResponse(response);
  }

  getNumCards(): number {
    return this.transcript.length;
  }

  getCard(index: number): StateCard {
    if (index !== null &amp;&amp; (index &lt; 0 || index &gt;= this.transcript.length)) {
      this.log.error(
        &#x27;Requested card with index &#x27; + index +
          &#x27;, but transcript only has length &#x27; +
          this.transcript.length + &#x27; cards.&#x27;);
    }
    return this.transcript[index];
  }

  getLastAnswerOnDisplayedCard(displayedCardIndex: number): string | null {
    if (
      this.isLastCard(displayedCardIndex) ||
        this.transcript[displayedCardIndex].getStateName() === null ||
        this.transcript[displayedCardIndex].getInputResponsePairs().length ===
        0) {
      return null;
    } else {
      return this.transcript[displayedCardIndex].
        getInputResponsePairs().slice(-1)[0].learnerInput;
    }
  }

  isLastCard(index: number): boolean {
    return index === this.transcript.length - 1;
  }

  getLastCard(): StateCard {
    return this.getCard(this.transcript.length - 1);
  }

  getNumSubmitsForLastCard(): number {
    return this.numAnswersSubmitted;
  }

  updateLatestInteractionHtml(newInteractionHtml: string): void {
    this.getLastCard().setInteractionHtml(newInteractionHtml);
  }

  getLastStateName(): string {
    return this.getLastCard().getStateName();
  }
}

angular.module(&#x27;oppia&#x27;).factory(
  &#x27;PlayerTranscriptService&#x27;,
  downgradeInjectable(PlayerTranscriptService));
</textarea><pre id="annotations" style="display:none">[]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:54 GMT</p>
    </body>
  </html>
  