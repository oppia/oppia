
  <!DOCTYPE html>
  <html>
    <head>
      <title>exploration-data.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">core/templates/pages/exploration-editor-page/services/exploration-data.service.ts</td><td class="">100.00%</td><td class="">100%</td><td class="">284</td><td class="">284</td><td class="">0</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2021 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Service for handling all interactions
 * with the exploration editor backend.
 */

import { Injectable } from &#x27;@angular/core&#x27;;
import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;
import { EditableExplorationBackendApiService } from &#x27;domain/exploration/editable-exploration-backend-api.service&#x27;;
import { ExplorationChange } from &#x27;domain/exploration/exploration-draft.model&#x27;;
import { ExplorationBackendDict } from &#x27;domain/exploration/ExplorationObjectFactory&#x27;;
import { ReadOnlyExplorationBackendApiService, ReadOnlyExplorationBackendDict } from &#x27;domain/exploration/read-only-exploration-backend-api.service&#x27;;
import { tap } from &#x27;rxjs/operators&#x27;;
import { AlertsService } from &#x27;services/alerts.service&#x27;;
import { LoggerService } from &#x27;services/contextual/logger.service&#x27;;
import { UrlService } from &#x27;services/contextual/url.service&#x27;;
import { WindowRef } from &#x27;services/contextual/window-ref.service&#x27;;
import { LocalStorageService } from &#x27;services/local-storage.service&#x27;;
import { ExplorationDataBackendApiService } from &#x27;./exploration-data-backend-api.service&#x27;;

export interface DraftAutoSaveResponse {
  &#x27;draft_change_list_id&#x27;: number;
  &#x27;is_version_of_draft_valid&#x27;: boolean;
}
@Injectable({
  providedIn: &#x27;root&#x27;
})
export class ExplorationDataService {
  draftChangeListId: number | null = null;
  explorationDraftAutosaveUrl: string;
  explorationId: string;
  resolvedAnswersUrlPrefix: string;
  data: ExplorationBackendDict;

  constructor(
    private alertsService: AlertsService,
    private editableExplorationBackendApiService:
      EditableExplorationBackendApiService,
    private explorationDataBackendApiService: ExplorationDataBackendApiService,
    private localStorageService: LocalStorageService,
    private loggerService: LoggerService,
    private readOnlyExplorationBackendApiService:
      ReadOnlyExplorationBackendApiService,
    private urlService: UrlService,
    private windowRef: WindowRef
  ) {
    let explorationId = &#x27;&#x27;;
    // The pathname (without the hash) should be: .../create/{exploration_id}.
    const pathname = this.urlService.getPathname();
    const pathnameArray = pathname.split(&#x27;/&#x27;);
    for (let i = 0; i &lt; pathnameArray.length; i++) {
      if (pathnameArray[i] === &#x27;create&#x27;) {
        explorationId = pathnameArray[i + 1];
        break;
      }
    }

    if (!explorationId) {
      this.loggerService.error(
        &#x27;Unexpected call to ExplorationDataService for pathname: &#x27; + pathname);
      this.autosaveChangeListAsync = undefined;
      this.discardDraftAsync = undefined;
      this.getDataAsync = undefined;
      this.getLastSavedDataAsync = undefined;
      this.save = undefined;
    } else {
      this.explorationId = explorationId;
      this.resolvedAnswersUrlPrefix = (
        &#x27;/createhandler/resolved_answers/&#x27; + explorationId);
      this.explorationDraftAutosaveUrl = (
        &#x27;/createhandler/autosave_draft/&#x27; + explorationId);
    }
  }

  private async _autosaveChangeListAsync(
      changeList: ExplorationChange[]): Promise&lt;DraftAutoSaveResponse&gt; {
    this.localStorageService.saveExplorationDraft(
      this.explorationId, changeList, this.draftChangeListId);
    return this.explorationDataBackendApiService.saveChangeList(
      this.explorationDraftAutosaveUrl,
      changeList,
      this.data.version,
    ).pipe(
      tap(response =&gt; {
        this.draftChangeListId = response.draft_change_list_id;
        // We can safely remove the locally saved draft copy if it was saved
        // to the backend.
        this.localStorageService.removeExplorationDraft(this.explorationId);
      })).toPromise();
  }

  // Note that the changeList is the full changeList since the last
  // committed version (as opposed to the most recent autosave).
  async autosaveChangeListAsync(
      changeList: ExplorationChange[],
      successCallback: (response: DraftAutoSaveResponse) =&gt; void,
      errorCallback = () =&gt; {}
  ): Promise&lt;void&gt; {
    return this._autosaveChangeListAsync(changeList).then(
      (response) =&gt; {
        if (successCallback) {
          successCallback(response);
        }
      },
      () =&gt; {
        if (errorCallback) {
          errorCallback();
        }
      }
    );
  }

  async discardDraftAsync(): Promise&lt;void&gt; {
    return this.explorationDataBackendApiService.discardDraft(
      this.explorationDraftAutosaveUrl).toPromise();
  }

  async getDataAsync(errorCallback: (
    explorationId: string,
    lostChanges: ExplorationChange[]) =&gt; void | undefined
  ): Promise&lt;ExplorationBackendDict&gt; {
    if (this.data) {
      this.loggerService.info(&#x27;Found exploration data in cache.&#x27;);
      return Promise.resolve(this.data);
    } else {
      // Retrieve data from the server.
      // WARNING: Note that this is a version of the exploration with draft
      // changes applied. This makes a force-refresh necessary when changes
      // are discarded, otherwise the exploration-with-draft-changes
      // (which is cached here) will be reused.
      return new Promise((resolve, reject) =&gt; {
        this.editableExplorationBackendApiService
          .fetchApplyDraftExplorationAsync(
            this.explorationId).then((response) =&gt; {
            this.loggerService.info(&#x27;Retrieved exploration data.&#x27;);
            this.loggerService.info(JSON.stringify(response));
            this.draftChangeListId = response.draft_change_list_id;
            this.data = response;
            const draft = this.localStorageService.getExplorationDraft(
              this.explorationId);
            if (draft) {
              if (draft.isValid(this.draftChangeListId)) {
                var changeList = draft.getChanges();
                this._autosaveChangeListAsync(changeList).then(
                  // A reload is needed so that the changelist just saved is
                  // loaded as opposed to the exploration returned by this
                  // response.
                  () =&gt; {
                    this.windowRef.nativeWindow.location.reload();
                  },
                  // If the request errors out, do nothing.
                  () =&gt; {}
                );
              } else {
                if (errorCallback) {
                  errorCallback(this.explorationId, draft.getChanges());
                }
              }
            }
            resolve(response);
          });
      });
    }
  }

  // Returns a promise supplying the last saved version for the current
  // exploration.
  async getLastSavedDataAsync(): Promise&lt;ReadOnlyExplorationBackendDict&gt; {
    return this.readOnlyExplorationBackendApiService.loadLatestExplorationAsync(
      this.explorationId).then(response =&gt; {
      this.loggerService.info(&#x27;Retrieved saved exploration data.&#x27;);
      this.loggerService.info(JSON.stringify(response));

      return response.exploration;
    });
  }
  /**
   * Saves the exploration to the backend, and, on a success callback,
   * updates the local copy of the exploration data.
   * @param {object} changeList - Represents the change list for
   *   this save. Each element of the list is a command representing an
   *   editing action (such as add state, delete state, etc.). See the
   *  _&#x27;Change&#x27; class in exp_services.py for full documentation.
   * @param {string} commitMessage - The user-entered commit message for
   *   this save operation.
   */
  save(
      changeList: ExplorationChange[],
      commitMessage: string,
      successCallback: (
        isDraftVersionvalid: boolean,
        draftChanges: ExplorationChange[]) =&gt; void,
      errorCallback: () =&gt; void): void {
    this.editableExplorationBackendApiService.updateExplorationAsync(
      this.explorationId,
    this.data ? this.data.version : null,
    commitMessage, changeList).then(
      response =&gt; {
        this.alertsService.clearWarnings();
        this.data = response;
        if (successCallback) {
          successCallback(
            response.is_version_of_draft_valid,
            response.draft_changes);
        }
      }, () =&gt; {
        if (errorCallback) {
          errorCallback();
        }
      }
    );
  }
}

angular.module(&#x27;oppia&#x27;).factory(
  &#x27;ExplorationDataService&#x27;, downgradeInjectable(ExplorationDataService));
</textarea><pre id="annotations" style="display:none">[]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:56 GMT</p>
    </body>
  </html>
  