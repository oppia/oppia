
  <!DOCTYPE html>
  <html>
    <head>
      <title>story-editor-state.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">core/templates/pages/story-editor-page/services/story-editor-state.service.ts</td><td class="">94.74%</td><td class="">100%</td><td class="">323</td><td class="">306</td><td class="">17</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2018 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Service to maintain the state of a single story shared
 * throughout the story editor. This service provides functionality for
 * retrieving the story, saving it, and listening for changes.
 */

import { EventEmitter, Injectable } from &#x27;@angular/core&#x27;;
import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;

import { StoryChange } from &#x27;domain/editor/undo_redo/change.model&#x27;;
import { UndoRedoService } from &#x27;domain/editor/undo_redo/undo-redo.service&#x27;;
import { SkillSummaryBackendDict } from &#x27;domain/skill/skill-summary.model&#x27;;
import { Story, StoryBackendDict, StoryObjectFactory } from &#x27;domain/story/StoryObjectFactory&#x27;;
import { EditableStoryBackendApiService } from &#x27;domain/story/editable-story-backend-api.service&#x27;;
import { AlertsService } from &#x27;services/alerts.service&#x27;;

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class StoryEditorStateService {
  constructor(
    private alertsService: AlertsService,
    private editableStoryBackendApiService: EditableStoryBackendApiService,
    private storyObjectFactory: StoryObjectFactory,
    private undoRedoService: UndoRedoService) {}

  _story: Story = this.storyObjectFactory.createInterstitialStory();
  _storyIsInitialized: boolean = false;
  _storyIsLoading: boolean = false;
  _storyIsBeingSaved: boolean = false;
  _topicName: string = null;
  _storyIsPublished: boolean = false;
  _skillSummaries: SkillSummaryBackendDict[] = [];
  _expIdsChanged: boolean = false;
  _storyWithUrlFragmentExists: boolean = false;
  _classroomUrlFragment: string = null;
  _topicUrlFragment: string = null;

  _storyInitializedEventEmitter = new EventEmitter();
  _storyReinitializedEventEmitter = new EventEmitter();
  _viewStoryNodeEditorEventEmitter = new EventEmitter();
  _recalculateAvailableNodesEventEmitter = new EventEmitter();

  private _setStory(story: Story): void {
    this._story.copyFromStory(story);
    if (this._storyIsInitialized) {
      this._storyReinitializedEventEmitter.emit();
    } else {
      this._storyInitializedEventEmitter.emit();
      this._storyIsInitialized = true;
    }
  }

  private _setSkillSummaries(skillSummaries: SkillSummaryBackendDict[]): void {
    this._skillSummaries = angular.copy(skillSummaries);
  }

  private _setTopicName(topicName: string): void {
    this._topicName = topicName;
  }

  private _setStoryPublicationStatus(storyIsPublished: boolean): void {
    this._storyIsPublished = storyIsPublished;
  }

  private _updateStory(newBackendStoryObject: StoryBackendDict): void {
    this._setStory(
      this.storyObjectFactory.createFromBackendDict(newBackendStoryObject));
  }

  private _setStoryWithUrlFragmentExists(
      storyWithUrlFragmentExists: boolean): void {
    this._storyWithUrlFragmentExists = storyWithUrlFragmentExists;
  }

  private _setClassroomUrlFragment(classroomUrlFragment: string): void {
    this._classroomUrlFragment = classroomUrlFragment;
  }

  private _setTopicUrlFragment(topicUrlFragment: string): void {
    this._topicUrlFragment = topicUrlFragment;
  }

  /**
   * Loads, or reloads, the story stored by this service given a
   * specified story ID. See setStory() for more information on
   * additional behavior of this function.
   */
  loadStory(storyId: string): void {
    this._storyIsLoading = true;
    this.editableStoryBackendApiService.fetchStoryAsync(storyId).then(
      (newBackendStoryObject) =&gt; {
        this._setTopicName(newBackendStoryObject.topicName);
        this._setStoryPublicationStatus(
          newBackendStoryObject.storyIsPublished);
        this._setSkillSummaries(newBackendStoryObject.skillSummaries);
        this._updateStory(newBackendStoryObject.story);
        this._storyIsLoading = false;
        this._setClassroomUrlFragment(
          newBackendStoryObject.classroomUrlFragment);
        this._setTopicUrlFragment(newBackendStoryObject.topicUrlFragment);
      }, error =&gt; {
        this.alertsService.addWarning(
          error || &#x27;There was an error when loading the story.&#x27;);
        this._storyIsLoading = false;
      });
  }

  /**
   * Returns whether this service is currently attempting to load the
   * story maintained by this service.
   */
  isLoadingStory(): boolean {
    return this._storyIsLoading;
  }

  /**
   * Returns whether a story has yet been loaded using either
   * loadStory() or setStory().
   */
  hasLoadedStory(): boolean {
    return this._storyIsInitialized;
  }

  setExpIdsChanged(): void {
    this._expIdsChanged = true;
  }

  resetExpIdsChanged(): void {
    this._expIdsChanged = false;
  }

  areAnyExpIdsChanged(): boolean {
    return this._expIdsChanged;
  }

  /**
   * Returns the current story to be shared among the story
   * editor. Please note any changes to this story will be propogated
   * to all bindings to it. This story object will be retained for the
   * lifetime of the editor. This function never returns null, though it may
   * return an empty story object if the story has not yet been
   * loaded for this editor instance.
   */
  getStory(): Story {
    return this._story;
  }

  getSkillSummaries(): SkillSummaryBackendDict[] {
    return this._skillSummaries;
  }

  /**
   * Sets the story stored within this service, propogating changes to
   * all bindings to the story returned by getStory(). The first
   * time this is called it will fire a global event based on the
   * next() function of the _storyInitializedEventEmitter. All subsequent
   * calls will similarly fire a next() function of the
   * _storyReinitializedEventEmitter.
   */
  setStory(story: Story): void {
    this._setStory(story);
  }

  getTopicName(): string {
    return this._topicName;
  }

  isStoryPublished(): boolean {
    return this._storyIsPublished;
  }

  /**
   * Attempts to save the current story given a commit message. This
   * function cannot be called until after a story has been initialized
   * in this service. Returns false if a save is not performed due to no
   * changes pending, or true if otherwise. This function, upon success,
   * will clear the UndoRedoService of pending changes. This function also
   * shares behavior with setStory(), when it succeeds.
   */
  saveStory(
      commitMessage: string,
      successCallback: (value?: Object) =&gt; void,
      errorCallback: (value?: Object) =&gt; void): boolean {
    if (!this._storyIsInitialized) {
      this.alertsService.fatalWarning(
        &#x27;Cannot save a story before one is loaded.&#x27;);
    }

    // Don&#x27;t attempt to save the story if there are no changes pending.
    if (!this.undoRedoService.hasChanges()) {
      return false;
    }
    this._storyIsBeingSaved = true;
    this.editableStoryBackendApiService.updateStoryAsync(
      this._story.getId(), this._story.getVersion(), commitMessage,
      &lt;StoryChange[]&gt; this.undoRedoService.getCommittableChangeList()).then(
      (storyBackendObject) =&gt; {
        this._updateStory(storyBackendObject);
        this.undoRedoService.clearChanges();
        this._storyIsBeingSaved = false;
        if (successCallback) {
          successCallback();
        }
      }, error =&gt; {
        let errorMessage = error || &#x27;There was an error when saving the story.&#x27;;
        this.alertsService.addWarning(errorMessage);
        this._storyIsBeingSaved = false;
        if (errorCallback) {
          errorCallback(errorMessage);
        }
      });
    return true;
  }

  getTopicUrlFragment(): string {
    return this._topicUrlFragment;
  }

  getClassroomUrlFragment(): string {
    return this._classroomUrlFragment;
  }

  changeStoryPublicationStatus(
      newStoryStatusIsPublic: boolean,
      successCallback: (value?: Object) =&gt; void): boolean {
    if (!this._storyIsInitialized) {
      this.alertsService.fatalWarning(
        &#x27;Cannot publish a story before one is loaded.&#x27;);
    }

    this.editableStoryBackendApiService.changeStoryPublicationStatusAsync(
      this._story.getId(), newStoryStatusIsPublic).then(
      (storyBackendObject) =&gt; {
        this._setStoryPublicationStatus(newStoryStatusIsPublic);
        if (successCallback) {
          successCallback();
        }
      }, error =&gt; {
        this.alertsService.addWarning(
          error ||
          &#x27;There was an error when publishing/unpublishing the story.&#x27;);
      });
    return true;
  }

  /**
   * Returns whether this service is currently attempting to save the
   * story maintained by this service.
   */
  isSavingStory(): boolean {
    return this._storyIsBeingSaved;
  }

  get onStoryInitialized(): EventEmitter&lt;unknown&gt; {
    return this._storyInitializedEventEmitter;
  }

  get onStoryReinitialized(): EventEmitter&lt;unknown&gt; {
    return this._storyReinitializedEventEmitter;
  }

  get onViewStoryNodeEditor(): EventEmitter&lt;unknown&gt; {
    return this._viewStoryNodeEditorEventEmitter;
  }

  get onRecalculateAvailableNodes(): EventEmitter&lt;unknown&gt; {
    return this._recalculateAvailableNodesEventEmitter;
  }
  /**
   * Returns whether the story URL fragment already exists on the server.
   */
  getStoryWithUrlFragmentExists(): boolean {
    return this._storyWithUrlFragmentExists;
  }

  /**
   * Attempts to set the boolean variable _storyWithUrlFragmentExists based
   * on the value returned by doesStoryWithUrlFragmentExistAsync and
   * executes the success callback provided. No arguments are passed to the
   * success callback. Execution of the success callback indicates that the
   * async backend call was successful and that _storyWithUrlFragmentExists
   * has been successfully updated.
   */
  updateExistenceOfStoryUrlFragment(
      storyUrlFragment: string,
      successCallback: (value?: Object) =&gt; void): void {
    this.editableStoryBackendApiService.doesStoryWithUrlFragmentExistAsync(
      storyUrlFragment).then(
      (storyUrlFragmentExists) =&gt; {
        this._setStoryWithUrlFragmentExists(storyUrlFragmentExists);
        if (successCallback) {
          successCallback();
        }
      }, error =&gt; {
        this.alertsService.addWarning(
          error ||
          &#x27;There was an error when checking if the story url fragment &#x27; +
          &#x27;exists for another story.&#x27;);
      });
  }
}

angular.module(&#x27;oppia&#x27;).factory(
  &#x27;StoryEditorStateService&#x27;, downgradeInjectable(StoryEditorStateService));
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:52,&quot;character&quot;:2,&quot;text&quot;:&quot;_storyInitializedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:53,&quot;character&quot;:2,&quot;text&quot;:&quot;_storyReinitializedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:54,&quot;character&quot;:2,&quot;text&quot;:&quot;_viewStoryNodeEditorEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:55,&quot;character&quot;:2,&quot;text&quot;:&quot;_recalculateAvailableNodesEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:60,&quot;character&quot;:11,&quot;text&quot;:&quot;_storyReinitializedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:62,&quot;character&quot;:11,&quot;text&quot;:&quot;_storyInitializedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:115,&quot;character&quot;:9,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:210,&quot;character&quot;:6,&quot;text&quot;:&quot;&lt;StoryChange[]&gt; this.undoRedoService.getCommittableChangeList()&quot;,&quot;kind&quot;:4},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:218,&quot;character&quot;:9,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:219,&quot;character&quot;:12,&quot;text&quot;:&quot;errorMessage&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:219,&quot;character&quot;:27,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:252,&quot;character&quot;:9,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:269,&quot;character&quot;:16,&quot;text&quot;:&quot;_storyInitializedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:273,&quot;character&quot;:16,&quot;text&quot;:&quot;_storyReinitializedEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:277,&quot;character&quot;:16,&quot;text&quot;:&quot;_viewStoryNodeEditorEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:281,&quot;character&quot;:16,&quot;text&quot;:&quot;_recalculateAvailableNodesEventEmitter&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/story-editor-page/services/story-editor-state.service.ts&quot;,&quot;line&quot;:308,&quot;character&quot;:9,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:55 GMT</p>
    </body>
  </html>
  