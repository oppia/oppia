
  <!DOCTYPE html>
  <html>
    <head>
      <title>translation-modal.component.spec.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts</td><td class="">94.87%</td><td class="">100%</td><td class="">897</td><td class="">851</td><td class="">46</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2021 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Unit tests for TranslationModalComponent.
*/

import { HttpClientTestingModule, HttpTestingController } from &#x27;@angular/common/http/testing&#x27;;
import { ChangeDetectorRef, NO_ERRORS_SCHEMA } from &#x27;@angular/core&#x27;;

import { ComponentFixture, fakeAsync, flushMicrotasks, TestBed, waitForAsync } from &#x27;@angular/core/testing&#x27;;
import { NgbActiveModal } from &#x27;@ng-bootstrap/ng-bootstrap&#x27;;
import { AppConstants } from &#x27;app.constants&#x27;;
import { CkEditorCopyContentService } from &#x27;components/ck-editor-helpers/ck-editor-copy-content-service&#x27;;
import { OppiaAngularRootComponent } from &#x27;components/oppia-angular-root.component&#x27;;
import { TranslationModalComponent, TranslationOpportunity } from &#x27;pages/contributor-dashboard-page/modal-templates/translation-modal.component&#x27;;
import { TranslationLanguageService } from &#x27;pages/exploration-editor-page/translation-tab/services/translation-language.service&#x27;;
import { ContextService } from &#x27;services/context.service&#x27;;
import { ImageLocalStorageService } from &#x27;services/image-local-storage.service&#x27;;
import { SiteAnalyticsService } from &#x27;services/site-analytics.service&#x27;;
import { TranslateTextService } from &#x27;../services/translate-text.service&#x27;;

class MockChangeDetectorRef {
  detectChanges(): void {}
}

describe(&#x27;Translation Modal Component&#x27;, () =&gt; {
  let contextService: ContextService;
  let translateTextService: TranslateTextService;
  let translationLanguageService: TranslationLanguageService;
  let ckEditorCopyContentService: CkEditorCopyContentService;
  let siteAnalyticsService: SiteAnalyticsService;
  let imageLocalStorageService: ImageLocalStorageService;
  let activeModal: NgbActiveModal;
  let httpTestingController: HttpTestingController;
  let fixture: ComponentFixture&lt;TranslationModalComponent&gt;;
  let component: TranslationModalComponent;
  let changeDetectorRef: MockChangeDetectorRef = new MockChangeDetectorRef();
  const opportunity: TranslationOpportunity = {
    id: &#x27;1&#x27;,
    heading: &#x27;Heading&#x27;,
    subheading: &#x27;subheading&#x27;,
    progressPercentage: &#x27;20&#x27;,
    actionButtonTitle: &#x27;Action Button&#x27;
  };

  beforeEach(waitForAsync(() =&gt; {
    TestBed.configureTestingModule({
      imports: [
        HttpClientTestingModule
      ],
      declarations: [
        TranslationModalComponent
      ],
      providers: [
        NgbActiveModal,
        {
          provide: ChangeDetectorRef,
          useValue: changeDetectorRef
        }
      ],
      schemas: [NO_ERRORS_SCHEMA]
    }).compileComponents();
    OppiaAngularRootComponent.contextService = TestBed.inject(ContextService);
    contextService = OppiaAngularRootComponent.contextService;
  }));

  beforeEach(() =&gt; {
    fixture = TestBed.createComponent(TranslationModalComponent);
    component = fixture.componentInstance;
    component.opportunity = opportunity;
    httpTestingController = TestBed.inject(HttpTestingController);
    ckEditorCopyContentService = TestBed.inject(CkEditorCopyContentService);
    activeModal = TestBed.inject(NgbActiveModal);
    translateTextService = TestBed.inject(TranslateTextService);
    siteAnalyticsService = TestBed.inject(SiteAnalyticsService);
    imageLocalStorageService = TestBed.inject(ImageLocalStorageService);
    translationLanguageService = TestBed.inject(TranslationLanguageService);
    translationLanguageService.setActiveLanguageCode(&#x27;es&#x27;);
  });

  it(&#x27;should invoke change detection when html is updated&#x27;, () =&gt; {
    component.activeWrittenTranslation.html = &#x27;old&#x27;;
    spyOn(changeDetectorRef, &#x27;detectChanges&#x27;).and.callThrough();
    component.updateHtml(&#x27;new&#x27;);
    expect(component.activeWrittenTranslation.html).toEqual(&#x27;new&#x27;);
  });

  it(&#x27;should not invoke change detection when html is not updated&#x27;, () =&gt; {
    component.activeWrittenTranslation.html = &#x27;old&#x27;;
    spyOn(changeDetectorRef, &#x27;detectChanges&#x27;).and.callThrough();
    component.updateHtml(&#x27;old&#x27;);
    expect(component.activeWrittenTranslation.html).toEqual(&#x27;old&#x27;);
    expect(changeDetectorRef.detectChanges).toHaveBeenCalledTimes(0);
  });

  afterEach(() =&gt; {
    httpTestingController.verify();
  });

  it(&#x27;should close&#x27;, () =&gt; {
    spyOn(activeModal, &#x27;close&#x27;);
    component.close();
    expect(activeModal.close).toHaveBeenCalled();
  });

  describe(&#x27;when initialized&#x27;, () =&gt; {
    describe(&#x27;with an rtl language&#x27;, () =&gt; {
      beforeEach(fakeAsync(() =&gt; {
        translationLanguageService.setActiveLanguageCode(&#x27;ar&#x27;);
        spyOn(translateTextService, &#x27;init&#x27;).and.callFake(
          (expId, languageCode, successCallback) =&gt; successCallback());
        component.ngOnInit();
      }));

      it(&#x27;should set the schema constant correctly&#x27;, () =&gt; {
        expect(component.getHtmlSchema().ui_config.languageDirection)
          .toBe(&#x27;rtl&#x27;);
      });
    });

    describe(&#x27;with an ltr language&#x27;, () =&gt; {
      beforeEach(fakeAsync(() =&gt; {
        translationLanguageService.setActiveLanguageCode(&#x27;es&#x27;);
        spyOn(translateTextService, &#x27;init&#x27;).and.callFake(
          (expId, languageCode, successCallback) =&gt; successCallback());
        component.ngOnInit();
      }));

      it(&#x27;should set the schema constant correctly&#x27;, () =&gt; {
        expect(component.getHtmlSchema().ui_config.languageDirection)
          .toBe(&#x27;ltr&#x27;);
      });
    });

    it(&#x27;should set context correctly&#x27;, fakeAsync(() =&gt; {
      contextService.removeCustomEntityContext();
      contextService.resetImageSaveDestination();
      spyOn(translateTextService, &#x27;init&#x27;).and.callFake(
        (expId, languageCode, successCallback) =&gt; successCallback());
      component.ngOnInit();
      expect(contextService.getEntityType()).toBe(
        AppConstants.ENTITY_TYPE.EXPLORATION);
      expect(contextService.getEntityId()).toBe(&#x27;1&#x27;);
      expect(contextService.getImageSaveDestination()).toBe(
        AppConstants.IMAGE_SAVE_DESTINATION_LOCAL_STORAGE);
    }));

    it(&#x27;should initialize translateTextService&#x27;, fakeAsync(() =&gt; {
      spyOn(translateTextService, &#x27;init&#x27;).and.callThrough();
      spyOn(translateTextService, &#x27;getTextToTranslate&#x27;).and.callThrough();
      spyOn(translateTextService, &#x27;getPreviousTextToTranslate&#x27;)
        .and.callThrough();
      component.ngOnInit();
      expect(component.loadingData).toBeTrue();
      expect(translateTextService.init).toHaveBeenCalled();

      const sampleStateWiseContentMapping = {
        stateName1: {contentId1: &#x27;text1&#x27;},
        stateName2: {contentId2: &#x27;text2&#x27;}
      };

      const req = httpTestingController.expectOne(
        &#x27;/gettranslatabletexthandler?exp_id=1&amp;language_code=es&#x27;);
      expect(req.request.method).toEqual(&#x27;GET&#x27;);
      req.flush({
        state_names_to_content_id_mapping: sampleStateWiseContentMapping,
        version: 1
      });
      flushMicrotasks();
      expect(component.loadingData).toBeFalse();
      expect(translateTextService.getTextToTranslate).toHaveBeenCalled();

      expect(component.textToTranslate).toBe(&#x27;text1&#x27;);
      expect(component.moreAvailable).toBeTrue();
      component.skipActiveTranslation();
      component.returnToPreviousTranslation();
      expect(translateTextService.getPreviousTextToTranslate)
        .toHaveBeenCalled();
      expect(component.textToTranslate).toBe(&#x27;text1&#x27;);
      // The value of moreAvailable will be set to true when the operation
      // is viewing a previous translation. If the value is false, the
      // &#x27;save and close&#x27; button is shown. This should happen only on the
      // last translation.
      expect(component.moreAvailable).toBeTrue();
    }));

    it(&#x27;should set the schema constant based on the active language&#x27;, fakeAsync(
      () =&gt; {
        translationLanguageService.setActiveLanguageCode(&#x27;ar&#x27;);
        spyOn(translateTextService, &#x27;init&#x27;).and.callFake(
          (expId, languageCode, successCallback) =&gt; successCallback());
        component.ngOnInit();
        expect(component.getHtmlSchema().ui_config.language)
          .toBe(&#x27;ar&#x27;);
      }));
  });

  describe(&#x27;when clicking on the translatable content&#x27;, () =&gt; {
    const nonParagraphTarget: HTMLElement = document.createElement(&#x27;div&#x27;);
    const mathTarget: HTMLElement = document.createElement(
      &#x27;oppia-noninteractive-math&#x27;);
    let paragraphTarget: HTMLElement;
    let broadcastSpy: jasmine.Spy&lt;(target: HTMLElement) =&gt; void&gt;;
    let propagationSpy: jasmine.Spy&lt;() =&gt; void&gt;;
    beforeEach(fakeAsync(() =&gt; {
      paragraphTarget = document.createElement(&#x27;p&#x27;);
      spyOn(translateTextService, &#x27;init&#x27;).and.callFake(
        (expId, languageCode, successCallback) =&gt; successCallback());
      broadcastSpy = spyOn(
        ckEditorCopyContentService, &#x27;broadcastCopy&#x27;).and.stub();

      component.ngOnInit();
      nonParagraphTarget.onclick = function(this, ev) {
        propagationSpy = spyOn(ev, &#x27;stopPropagation&#x27;).and.stub();
        component.onContentClick(ev);
      };
      paragraphTarget.onclick = function(this, ev) {
        propagationSpy = spyOn(ev, &#x27;stopPropagation&#x27;).and.stub();
        component.onContentClick(ev);
      };
    }));

    it(&#x27;should not broadcast the clicked paragraph element&#x27;, () =&gt; {
      paragraphTarget.click();
      expect(broadcastSpy).not.toHaveBeenCalledWith(paragraphTarget);
    });

    it(&#x27;should broadcast the clicked non paragraph element&#x27;, () =&gt; {
      nonParagraphTarget.click();
      expect(broadcastSpy).toHaveBeenCalledWith(nonParagraphTarget);
    });

    it(&#x27;should broadcast the clicked math element&#x27;, () =&gt; {
      paragraphTarget.append(mathTarget);
      paragraphTarget.click();
      expect(broadcastSpy).toHaveBeenCalledWith(paragraphTarget);
    });

    describe(&#x27;when copy mode is active&#x27;, () =&gt; {
      beforeEach(() =&gt; {
        ckEditorCopyContentService.toggleCopyMode();
      });

      it(&#x27;should prevent default behavior&#x27;, () =&gt; {
        nonParagraphTarget.click();
        expect(propagationSpy).toHaveBeenCalled();
      });
    });

    describe(&#x27;when copy mode is inactive&#x27;, () =&gt; {
      it(&#x27;should not prevent default behavior&#x27;, () =&gt; {
        nonParagraphTarget.click();
        expect(propagationSpy).not.toHaveBeenCalled();
      });
    });
  });

  describe(&#x27;when skipping the active translation&#x27;, () =&gt; {
    describe(&#x27;when there is available text&#x27;, () =&gt; {
      beforeEach(fakeAsync(() =&gt; {
        component.ngOnInit();

        const sampleStateWiseContentMapping = {
          stateName1: {contentId1: &#x27;text1&#x27;},
          stateName2: {contentId2: &#x27;text2&#x27;}
        };

        const req = httpTestingController.expectOne(
          &#x27;/gettranslatabletexthandler?exp_id=1&amp;language_code=es&#x27;);
        expect(req.request.method).toEqual(&#x27;GET&#x27;);
        req.flush({
          state_names_to_content_id_mapping: sampleStateWiseContentMapping,
          version: 1
        });
        flushMicrotasks();
        component.skipActiveTranslation();
      }));


      it(&#x27;should retrieve remaining text and availability&#x27;, () =&gt; {
        expect(component.textToTranslate).toBe(&#x27;text2&#x27;);
        expect(component.moreAvailable).toBeFalse();
      });
    });
  });

  describe(&#x27;when suggesting translated text&#x27;, () =&gt; {
    let expectedPayload, imagesData;
    beforeEach(fakeAsync(() =&gt; {
      expectedPayload = {
        suggestion_type: &#x27;translate_content&#x27;,
        target_type: &#x27;exploration&#x27;,
        description: &#x27;Adds translation&#x27;,
        target_id: &#x27;1&#x27;,
        target_version_at_submission: 1,
        change: {
          cmd: &#x27;add_written_translation&#x27;,
          content_id: &#x27;contentId1&#x27;,
          state_name: &#x27;stateName1&#x27;,
          language_code: &#x27;es&#x27;,
          content_html: &#x27;text1&#x27;,
          translation_html: &#x27;texto1&#x27;,
          data_format: &#x27;html&#x27;
        }
      };
      component.ngOnInit();

      const sampleStateWiseContentMapping = {
        stateName1: {contentId1: &#x27;text1&#x27;},
        stateName2: {contentId2: &#x27;text2&#x27;}
      };

      const req = httpTestingController.expectOne(
        &#x27;/gettranslatabletexthandler?exp_id=1&amp;language_code=es&#x27;);
      expect(req.request.method).toEqual(&#x27;GET&#x27;);
      req.flush({
        state_names_to_content_id_mapping: sampleStateWiseContentMapping,
        version: 1
      });
      flushMicrotasks();
      component.activeWrittenTranslation.html = &#x27;texto1&#x27;;
    }));

    it(&#x27;should remove paragraph error&#x27;, fakeAsync(() =&gt; {
      component.hadCopyParagraphError = true;

      component.suggestTranslatedText();

      const req = httpTestingController.expectOne(
        &#x27;/suggestionhandler/&#x27;);
      expect(component.hadCopyParagraphError).toEqual(false);
      expect(req.request.method).toEqual(&#x27;POST&#x27;);
      expect(req.request.body.getAll(&#x27;payload&#x27;)[0]).toEqual(
        JSON.stringify(expectedPayload));
      req.flush({});
      flushMicrotasks();
    }));

    it(&#x27;should correctly submit a translation suggestion&#x27;, fakeAsync(() =&gt; {
      component.suggestTranslatedText();

      const req = httpTestingController.expectOne(
        &#x27;/suggestionhandler/&#x27;);
      expect(req.request.method).toEqual(&#x27;POST&#x27;);
      expect(req.request.body.getAll(&#x27;payload&#x27;)[0]).toEqual(
        JSON.stringify(expectedPayload));
      req.flush({});
      flushMicrotasks();
    }));

    it(&#x27;should correctly submit a translation suggestion&#x27;, fakeAsync(() =&gt; {
      spyOn(
        translateTextService,
        &#x27;getPreviousTextToTranslate&#x27;
      ).and.returnValue({
        text: &#x27;abc&#x27;,
        more: true,
        status: &#x27;submitted&#x27;,
        translationHtml: &#x27;cba&#x27;
      });
      expect(component.isSubmitted()).toBeFalse();

      component.returnToPreviousTranslation();

      expect(component.isSubmitted()).toBeTrue();
    }));

    describe(&#x27;when already uploading a translation&#x27;, () =&gt; {
      it(&#x27;should not submit the translation&#x27;, fakeAsync(() =&gt; {
        spyOn(translateTextService, &#x27;suggestTranslatedText&#x27;).and.callThrough();

        component.suggestTranslatedText();
        component.suggestTranslatedText();

        const req = httpTestingController.expectOne(
          &#x27;/suggestionhandler/&#x27;);
        expect(req.request.method).toEqual(&#x27;POST&#x27;);
        expect(req.request.body.getAll(&#x27;payload&#x27;)[0]).toEqual(
          JSON.stringify(expectedPayload));
        req.flush({});
        flushMicrotasks();
        // Prevention of concurrent suggestions also confirmed by &quot;expectOne&quot;.
        expect(translateTextService.suggestTranslatedText)
          .toHaveBeenCalledTimes(1);
      }));
    });

    describe(&#x27;when currently loading data&#x27;, () =&gt; {
      it(&#x27;should not submit the translation&#x27;, () =&gt; {
        component.loadingData = true;
        spyOn(translateTextService, &#x27;suggestTranslatedText&#x27;).and.callThrough();

        component.suggestTranslatedText();

        expect(translateTextService.suggestTranslatedText)
          .toHaveBeenCalledTimes(0);
      });
    });

    describe(&#x27;when all images are not copied&#x27;, () =&gt; {
      it(&#x27;should not submit the translation&#x27;, () =&gt; {
        component.textToTranslate = &#x27;&lt;oppia-noninteractive-image alt-with-val&#x27; +
          &#x27;ue=&quot;&amp;amp;quot;Image description&amp;amp;quot;&quot; caption-with-value=&quot;&amp;&#x27; +
          &#x27;amp;quot;Image caption&amp;amp;quot;&quot; filepath-with-value=&quot;&amp;amp;quot;&#x27; +
          &#x27;img_20210129_210552_zbv0mdty94_height_54_width_490.png&amp;amp;quot;&quot;&gt;&#x27; +
          &#x27;&lt;/oppia-noninteractive-image&gt;&#x27;;
        component.activeWrittenTranslation.html = &#x27;&#x27;;
        spyOn(translateTextService, &#x27;suggestTranslatedText&#x27;).and.callThrough();

        component.suggestTranslatedText();

        expect(translateTextService.suggestTranslatedText)
          .toHaveBeenCalledTimes(0);
      });
    });

    describe(&#x27;when alt text is not changed in copied images&#x27;, () =&gt; {
      it(&#x27;should not submit the translation&#x27;, () =&gt; {
        component.textToTranslate = &#x27;&lt;oppia-noninteractive-image alt-with-&#x27; +
          &#x27;value=&quot;&amp;amp;quot;Image description&amp;amp;quot;&quot; caption-with-value=&#x27; +
          &#x27;&quot;&amp;amp;quot;Image caption&amp;amp;quot;&quot; filepath-with-value=&quot;&amp;amp;quot&#x27; +
          &#x27;;img_20210129_210552_zbv0mdty94_height_54_width_490.png&amp;amp;quot;&quot;&#x27; +
          &#x27;&gt;&lt;/oppia-noninteractive-image&gt;&#x27;;
        component.activeWrittenTranslation.html = &#x27;&lt;oppia-noninteractive-&#x27; +
          &#x27;image alt-with-value=&quot;&amp;amp;quot;Image description&amp;amp;quot;&#x27; +
          &#x27;&quot; caption-with-value=&quot;&amp;amp;quot;New caption&amp;amp;quot;&quot;&#x27; +
          &#x27; filepath-with-value=&quot;&amp;amp;quot;img_20210129_210552_zbv0mdty94&#x27; +
          &#x27;_height_54_width_490.png&amp;amp;quot;&quot;&gt;&lt;/oppia-noninteractive-image&gt;&#x27;;
        spyOn(translateTextService, &#x27;suggestTranslatedText&#x27;).and.callThrough();

        component.suggestTranslatedText();

        expect(translateTextService.suggestTranslatedText)
          .toHaveBeenCalledTimes(0);
      });
    });

    describe(&#x27;when caption is not changed in copied images&#x27;, () =&gt; {
      it(&#x27;should not submit the translation&#x27;, () =&gt; {
        component.textToTranslate = &#x27;&lt;oppia-noninteractive-image alt-with-&#x27; +
          &#x27;value=&quot;&amp;amp;quot;Image description&amp;amp;quot;&quot; caption-with-value=&#x27; +
          &#x27;&quot;&amp;amp;quot;Image caption&amp;amp;quot;&quot; filepath-with-value=&quot;&amp;amp;quot&#x27; +
          &#x27;;img_20210129_210552_zbv0mdty94_height_54_width_490.png&amp;amp;quot;&quot;&#x27; +
          &#x27;&gt;&lt;/oppia-noninteractive-image&gt;&#x27;;
        component.activeWrittenTranslation.html = &#x27;&lt;oppia-noninteractive&#x27; +
          &#x27;-image alt-with-value=&quot;&amp;amp;quot;New description&amp;amp;quot;&quot;&#x27; +
          &#x27; caption-with-value=&quot;&amp;amp;quot;Image caption&amp;amp;quot;&quot;&#x27; +
          &#x27; filepath-with-value=&quot;&amp;amp;quot:img_20210129_210552_zbv0mdty9&#x27; +
          &#x27;4_height_54_width_490.png&amp;amp;quot;&quot;&gt;&lt;/oppia-noninteractive-image&gt;&#x27;;
        spyOn(translateTextService, &#x27;suggestTranslatedText&#x27;).and.callThrough();

        component.suggestTranslatedText();

        expect(translateTextService.suggestTranslatedText)
          .toHaveBeenCalledTimes(0);
      });
    });

    describe(&#x27;when translation is not completed&#x27;, () =&gt; {
      it(&#x27;should not submit the translation&#x27;, () =&gt; {
        component.textToTranslate = &#x27;&lt;p&gt;First para&lt;/p&gt;&lt;p&gt;Second para&lt;/p&gt;&#x27;;
        component.activeWrittenTranslation.html = &#x27;&lt;p&gt;New First para&lt;/p&gt;&#x27;;
        spyOn(translateTextService, &#x27;suggestTranslatedText&#x27;).and.callThrough();

        component.suggestTranslatedText();

        expect(translateTextService.suggestTranslatedText)
          .toHaveBeenCalledTimes(0);
      });
    });

    describe(&#x27;when translation elements are not matching with the elements &#x27; +
        &#x27;of the text to translate&#x27;, () =&gt; {
      it(&#x27;should not submit the translation&#x27;, () =&gt; {
        component.textToTranslate = &#x27;&lt;p&gt;First para&lt;/p&gt;&lt;p&gt;Second para&lt;/p&gt;&#x27;;
        component.activeWrittenTranslation.html = &#x27;&lt;p&gt;New First para&lt;/p&gt;&lt;div&gt;&#x27; +
          &#x27;&lt;/div&gt;&#x27;;
        spyOn(translateTextService, &#x27;suggestTranslatedText&#x27;).and.callThrough();

        component.suggestTranslatedText();

        expect(translateTextService.suggestTranslatedText)
          .toHaveBeenCalledTimes(0);
      });
    });

    describe(&#x27;when suggesting the last available text&#x27;, () =&gt; {
      beforeEach(() =&gt; {
        expectedPayload = {
          suggestion_type: &#x27;translate_content&#x27;,
          target_type: &#x27;exploration&#x27;,
          description: &#x27;Adds translation&#x27;,
          target_id: &#x27;1&#x27;,
          target_version_at_submission: 1,
          change: {
            cmd: &#x27;add_written_translation&#x27;,
            content_id: &#x27;contentId2&#x27;,
            state_name: &#x27;stateName2&#x27;,
            language_code: &#x27;es&#x27;,
            content_html: &#x27;text2&#x27;,
            translation_html: &#x27;texto2&#x27;,
            data_format: &#x27;html&#x27;
          }
        };
        component.skipActiveTranslation();
        component.activeWrittenTranslation.html = &#x27;texto2&#x27;;
      });

      it(&#x27;should close the modal&#x27;, fakeAsync(() =&gt; {
        spyOn(component, &#x27;close&#x27;);
        component.suggestTranslatedText();

        const req = httpTestingController.expectOne(
          &#x27;/suggestionhandler/&#x27;);
        expect(req.request.method).toEqual(&#x27;POST&#x27;);
        expect(req.request.body.getAll(&#x27;payload&#x27;)[0]).toEqual(
          JSON.stringify(expectedPayload));
        req.flush({});
        flushMicrotasks();
        expect(component.close).toHaveBeenCalled();
      }));
    });

    it(&#x27;should register a contributor dashboard submit suggestion event&#x27;,
      () =&gt; {
        spyOn(
          siteAnalyticsService,
          &#x27;registerContributorDashboardSubmitSuggestionEvent&#x27;
        );
        spyOn(translateTextService, &#x27;suggestTranslatedText&#x27;).and.stub();
        component.suggestTranslatedText();
      });

    it(&#x27;should flush stored image data&#x27;,
      fakeAsync(() =&gt; {
        imagesData = [{
          filename: &#x27;imageFilename1&#x27;,
          imageBlob: &#x27;imageBlob1&#x27;
        }, {
          filename: &#x27;imageFilename1&#x27;,
          imageBlob: &#x27;imageBlob2&#x27;
        }, {
          filename: &#x27;imageFilename2&#x27;,
          imageBlob: &#x27;imageBlob1&#x27;
        }, {
          filename: &#x27;imageFilename2&#x27;,
          imageBlob: &#x27;imageBlob2&#x27;
        }];
        spyOn(imageLocalStorageService, &#x27;getStoredImagesData&#x27;).and.returnValue(
          imagesData
        );
        component.suggestTranslatedText();
        const req = httpTestingController.expectOne(
          &#x27;/suggestionhandler/&#x27;);
        expect(req.request.method).toEqual(&#x27;POST&#x27;);
        const filename1Blobs = req.request.body.getAll(&#x27;imageFilename1&#x27;);
        const filename2Blobs = req.request.body.getAll(&#x27;imageFilename2&#x27;);
        expect(filename1Blobs).toContain(&#x27;imageBlob1&#x27;);
        expect(filename1Blobs).toContain(&#x27;imageBlob2&#x27;);
        expect(filename2Blobs).toContain(&#x27;imageBlob1&#x27;);
        expect(filename2Blobs).toContain(&#x27;imageBlob2&#x27;);
        req.flush({});
        flushMicrotasks();
      }));

    it(&#x27;should not reset the image save destination&#x27;, () =&gt; {
      spyOn(translateTextService, &#x27;suggestTranslatedText&#x27;).and.stub();
      expect(contextService.getImageSaveDestination()).toBe(
        AppConstants.IMAGE_SAVE_DESTINATION_LOCAL_STORAGE);
      component.suggestTranslatedText();
      expect(contextService.getImageSaveDestination()).toBe(
        AppConstants.IMAGE_SAVE_DESTINATION_LOCAL_STORAGE);
    });

    it(&#x27;should reset the image save destination&#x27;, fakeAsync(() =&gt; {
      component.suggestTranslatedText();
      const req = httpTestingController.expectOne(
        &#x27;/suggestionhandler/&#x27;);
      expect(req.request.method).toEqual(&#x27;POST&#x27;);
      expect(req.request.body.getAll(&#x27;payload&#x27;)[0]).toEqual(
        JSON.stringify(expectedPayload));
      req.flush({
        error: &#x27;Error&#x27;
      }, {
        status: 500, statusText: &#x27;Internal Server Error&#x27;
      });
      flushMicrotasks();
      component.suggestTranslatedText();
      expect(contextService.getImageSaveDestination()).toBe(
        AppConstants.IMAGE_SAVE_DESTINATION_SERVER);
    }));
  });
});
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:175,&quot;character&quot;:17,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:281,&quot;character&quot;:19,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:299,&quot;character&quot;:8,&quot;text&quot;:&quot;expectedPayload&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:299,&quot;character&quot;:25,&quot;text&quot;:&quot;imagesData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:301,&quot;character&quot;:6,&quot;text&quot;:&quot;expectedPayload&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:326,&quot;character&quot;:17,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:343,&quot;character&quot;:17,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:344,&quot;character&quot;:17,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:344,&quot;character&quot;:25,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:344,&quot;character&quot;:30,&quot;text&quot;:&quot;getAll&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:345,&quot;character&quot;:23,&quot;text&quot;:&quot;expectedPayload&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:355,&quot;character&quot;:17,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:356,&quot;character&quot;:17,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:356,&quot;character&quot;:25,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:356,&quot;character&quot;:30,&quot;text&quot;:&quot;getAll&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:357,&quot;character&quot;:23,&quot;text&quot;:&quot;expectedPayload&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:388,&quot;character&quot;:19,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:389,&quot;character&quot;:19,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:389,&quot;character&quot;:27,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:389,&quot;character&quot;:32,&quot;text&quot;:&quot;getAll&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:390,&quot;character&quot;:25,&quot;text&quot;:&quot;expectedPayload&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:500,&quot;character&quot;:8,&quot;text&quot;:&quot;expectedPayload&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:526,&quot;character&quot;:19,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:527,&quot;character&quot;:19,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:527,&quot;character&quot;:27,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:527,&quot;character&quot;:32,&quot;text&quot;:&quot;getAll&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:528,&quot;character&quot;:25,&quot;text&quot;:&quot;expectedPayload&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:547,&quot;character&quot;:8,&quot;text&quot;:&quot;imagesData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:566,&quot;character&quot;:19,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:567,&quot;character&quot;:14,&quot;text&quot;:&quot;filename1Blobs&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:567,&quot;character&quot;:35,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:567,&quot;character&quot;:43,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:567,&quot;character&quot;:48,&quot;text&quot;:&quot;getAll&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:568,&quot;character&quot;:14,&quot;text&quot;:&quot;filename2Blobs&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:568,&quot;character&quot;:35,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:568,&quot;character&quot;:43,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:568,&quot;character&quot;:48,&quot;text&quot;:&quot;getAll&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:569,&quot;character&quot;:15,&quot;text&quot;:&quot;filename1Blobs&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:570,&quot;character&quot;:15,&quot;text&quot;:&quot;filename1Blobs&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:571,&quot;character&quot;:15,&quot;text&quot;:&quot;filename2Blobs&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:572,&quot;character&quot;:15,&quot;text&quot;:&quot;filename2Blobs&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:590,&quot;character&quot;:17,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:591,&quot;character&quot;:17,&quot;text&quot;:&quot;request&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:591,&quot;character&quot;:25,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:591,&quot;character&quot;:30,&quot;text&quot;:&quot;getAll&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/contributor-dashboard-page/modal-templates/translation-modal.component.spec.ts&quot;,&quot;line&quot;:592,&quot;character&quot;:23,&quot;text&quot;:&quot;expectedPayload&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:59 GMT</p>
    </body>
  </html>
  