
  <!DOCTYPE html>
  <html>
    <head>
      <title>admin-features-tab.component.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts</td><td class="">97.18%</td><td class="">100%</td><td class="">461</td><td class="">448</td><td class="">13</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2020 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Component for the feature tab in the admin panel.
 */

import { Component, OnInit, EventEmitter, Output } from &#x27;@angular/core&#x27;;
import { downgradeComponent } from &#x27;@angular/upgrade/static&#x27;;

import cloneDeep from &#x27;lodash/cloneDeep&#x27;;
import isEqual from &#x27;lodash/isEqual&#x27;;

import { AdminFeaturesTabConstants } from
  &#x27;pages/admin-page/features-tab/admin-features-tab.constants&#x27;;
import { WindowRef } from &#x27;services/contextual/window-ref.service&#x27;;
import { AdminDataService } from
  &#x27;pages/admin-page/services/admin-data.service&#x27;;
import { AdminTaskManagerService } from
  &#x27;pages/admin-page/services/admin-task-manager.service&#x27;;
import { PlatformFeatureAdminBackendApiService } from
  &#x27;domain/platform_feature/platform-feature-admin-backend-api.service&#x27;;
import { PlatformFeatureDummyBackendApiService } from
  &#x27;domain/platform_feature/platform-feature-dummy-backend-api.service&#x27;;
import { PlatformFeatureService } from &#x27;services/platform-feature.service&#x27;;
import {
  PlatformParameterFilterType,
  PlatformParameterFilter,
} from &#x27;domain/platform_feature/platform-parameter-filter.model&#x27;;
import { PlatformParameter, FeatureStage } from
  &#x27;domain/platform_feature/platform-parameter.model&#x27;;
import { PlatformParameterRule } from
  &#x27;domain/platform_feature/platform-parameter-rule.model&#x27;;

@Component({
  selector: &#x27;admin-features-tab&#x27;,
  templateUrl: &#x27;./admin-features-tab.component.html&#x27;
})
export class AdminFeaturesTabComponent implements OnInit {
  @Output() setStatusMessage = new EventEmitter&lt;string&gt;();

  readonly availableFilterTypes: PlatformParameterFilterType[] = Object
    .keys(PlatformParameterFilterType)
    .map(key =&gt; PlatformParameterFilterType[key]);

  readonly filterTypeToContext: {
    [key in PlatformParameterFilterType]: {
      displayName: string,
      operators: readonly string[],
      options?: readonly string[],
      optionFilter?: (feature: PlatformParameter, option: string) =&gt; boolean;
      placeholder?: string;
      inputRegex?: RegExp;
    }
  } = {
    [PlatformParameterFilterType.ServerMode]: {
      displayName: &#x27;Server Mode&#x27;,
      options: AdminFeaturesTabConstants.ALLOWED_SERVER_MODES,
      operators: [&#x27;=&#x27;],
      optionFilter: (feature: PlatformParameter, option: string): boolean =&gt; {
        switch (feature.featureStage) {
          case FeatureStage.DEV:
            return option === &#x27;dev&#x27;;
          case FeatureStage.TEST:
            return option === &#x27;dev&#x27; || option === &#x27;test&#x27;;
          case FeatureStage.PROD:
            return true;
          default:
            return false;
        }
      }
    },
    [PlatformParameterFilterType.PlatformType]: {
      displayName: &#x27;Platform Type&#x27;,
      options: AdminFeaturesTabConstants.ALLOWED_PLATFORM_TYPES,
      operators: [&#x27;=&#x27;]
    },
    [PlatformParameterFilterType.BrowserType]: {
      displayName: &#x27;Browser Type&#x27;,
      options: AdminFeaturesTabConstants.ALLOWED_BROWSER_TYPES,
      operators: [&#x27;=&#x27;]
    },
    [PlatformParameterFilterType.AppVersion]: {
      displayName: &#x27;App Version&#x27;,
      operators: [&#x27;=&#x27;, &#x27;&lt;&#x27;, &#x27;&gt;&#x27;, &#x27;&lt;=&#x27;, &#x27;&gt;=&#x27;],
      placeholder: &#x27;e.g. 1.0.0&#x27;,
      inputRegex: AdminFeaturesTabConstants.APP_VERSION_REGEXP
    },
    [PlatformParameterFilterType.AppVersionFlavor]: {
      displayName: &#x27;App Version Flavor&#x27;,
      options: AdminFeaturesTabConstants.ALLOWED_APP_VERSION_FLAVORS,
      operators: [&#x27;=&#x27;, &#x27;&lt;&#x27;, &#x27;&gt;&#x27;, &#x27;&lt;=&#x27;, &#x27;&gt;=&#x27;]
    }
  };

  private readonly defaultNewFilter: PlatformParameterFilter =
    PlatformParameterFilter.createFromBackendDict({
      type: PlatformParameterFilterType.ServerMode,
      conditions: []
    });

  private readonly defaultNewRule: PlatformParameterRule =
    PlatformParameterRule.createFromBackendDict({
      filters: [this.defaultNewFilter.toBackendDict()],
      value_when_matched: false
    });

  featureFlags: PlatformParameter[] = [];
  featureFlagNameToBackupMap: Map&lt;string, PlatformParameter&gt;;

  isDummyApiEnabled: boolean = false;

  constructor(
    private windowRef: WindowRef,
    private adminDataService: AdminDataService,
    private adminTaskManager: AdminTaskManagerService,
    private apiService: PlatformFeatureAdminBackendApiService,
    private featureService: PlatformFeatureService,
    private dummyApiService: PlatformFeatureDummyBackendApiService,
  ) {}

  async reloadFeatureFlagsAsync(): Promise&lt;void&gt; {
    const data = await this.adminDataService.getDataAsync();

    this.featureFlags = data.featureFlags;

    this.featureFlagNameToBackupMap = new Map(
      this.featureFlags.map(feature =&gt; [feature.name, cloneDeep(feature)]));
  }

  addNewRuleToTop(feature: PlatformParameter): void {
    feature.rules.unshift(cloneDeep(this.defaultNewRule));
  }

  addNewRuleToBottom(feature: PlatformParameter): void {
    feature.rules.push(cloneDeep(this.defaultNewRule));
  }

  addNewFilter(rule: PlatformParameterRule): void {
    rule.filters.push(cloneDeep(this.defaultNewFilter));
  }

  addNewCondition(filter: PlatformParameterFilter): void {
    const context = this.filterTypeToContext[filter.type];
    filter.conditions.push([
      context.operators[0],
      context.options ? context.options[0] : &#x27;&#x27;
    ]);
  }

  removeRule(feature: PlatformParameter, ruleIndex: number): void {
    feature.rules.splice(ruleIndex, 1);
  }

  removeFilter(rule: PlatformParameterRule, filterIndex: number): void {
    rule.filters.splice(filterIndex, 1);
  }

  removeCondition(
      filter: PlatformParameterFilter, conditionIndex: number): void {
    filter.conditions.splice(conditionIndex, 1);
  }

  moveRuleUp(feature: PlatformParameter, ruleIndex: number): void {
    const rule = feature.rules[ruleIndex];
    this.removeRule(feature, ruleIndex);
    feature.rules.splice(ruleIndex - 1, 0, rule);
  }

  moveRuleDown(feature: PlatformParameter, ruleIndex: number): void {
    const rule = feature.rules[ruleIndex];
    this.removeRule(feature, ruleIndex);
    feature.rules.splice(ruleIndex + 1, 0, rule);
  }

  async updateFeatureRulesAsync(feature: PlatformParameter): Promise&lt;void&gt; {
    const issues = this.validateFeatureFlag(feature);
    if (issues.length &gt; 0) {
      this.windowRef.nativeWindow.alert(issues.join(&#x27;\n&#x27;));
      return;
    }
    if (this.adminTaskManager.isTaskRunning()) {
      return;
    }
    const commitMessage = this.windowRef.nativeWindow.prompt(
      &#x27;This action is irreversible. If you insist to proceed, please enter &#x27; +
      &#x27;the commit message for the update&#x27;,
      `Update feature &#x27;${feature.name}&#x27;.`
    );
    if (commitMessage === null) {
      return;
    }

    try {
      this.adminTaskManager.startTask();

      await this.apiService.updateFeatureFlag(
        feature.name, commitMessage, feature.rules);

      this.featureFlagNameToBackupMap.set(feature.name, cloneDeep(feature));

      this.setStatusMessage.emit(&#x27;Saved successfully.&#x27;);
    } catch (e) {
      if (e.error &amp;&amp; e.error.error) {
        this.setStatusMessage.emit(`Update failed: ${e.error.error}`);
      } else {
        this.setStatusMessage.emit(&#x27;Update failed.&#x27;);
      }
    } finally {
      this.adminTaskManager.finishTask();
    }
  }

  clearChanges(featureFlag: PlatformParameter): void {
    if (!this.windowRef.nativeWindow.confirm(
      &#x27;This will revert all changes you made. Are you sure?&#x27;)) {
      return;
    }
    const backup = this.featureFlagNameToBackupMap.get(featureFlag.name);
    featureFlag.rules = cloneDeep(backup.rules);
  }

  clearFilterConditions(filter: PlatformParameterFilter): void {
    filter.conditions.splice(0);
  }

  isFeatureFlagRulesChanged(feature: PlatformParameter): boolean {
    const original = this.featureFlagNameToBackupMap.get(feature.name);
    return !isEqual(original.rules, feature.rules);
  }

  /**
   * Validates feature flag before updating, checks if there are identical
   * rules, filters or conditions at the same level.
   *
   * @param {PlatformParameter} feature - the feature flag to be validated.
   *
   * @returns {string[]} - Array of issue messages, if any.
   */
  validateFeatureFlag(feature: PlatformParameter): string[] {
    const issues = [];

    const seenRules: PlatformParameterRule[] = [];
    for (const [ruleIndex, rule] of feature.rules.entries()) {
      const sameRuleIndex = seenRules.findIndex(
        seenRule =&gt; isEqual(seenRule, rule));
      if (sameRuleIndex !== -1) {
        issues.push(
          `The ${sameRuleIndex + 1}-th &amp; ${ruleIndex + 1}-th rules are` +
          &#x27; identical.&#x27;);
        continue;
      }
      seenRules.push(rule);

      const seenFilters: PlatformParameterFilter[] = [];
      for (const [filterIndex, filter] of rule.filters.entries()) {
        const sameFilterIndex = seenFilters.findIndex(
          seenFilter =&gt; isEqual(seenFilter, filter));
        if (sameFilterIndex !== -1) {
          issues.push(
            `In the ${ruleIndex + 1}-th rule: the ${sameFilterIndex + 1}-th` +
            ` &amp; ${filterIndex + 1}-th filters are identical.`);
          continue;
        }
        seenFilters.push(filter);

        const seenConditions: [string, string][] = [];
        for (const [conditionIndex, condition] of filter.conditions
          .entries()) {
          const sameCondIndex = seenConditions.findIndex(
            seenCond =&gt; isEqual(seenCond, condition));
          if (sameCondIndex !== -1) {
            issues.push(
              `In the ${ruleIndex + 1}-th rule, ${filterIndex + 1}-th` +
              ` filter: the ${sameCondIndex + 1}-th &amp; ` +
              `${conditionIndex + 1}-th conditions are identical.`);
            continue;
          }

          seenConditions.push(condition);
        }
      }
    }
    return issues;
  }

  get isDummyFeatureEnabled(): boolean {
    return this.featureService.status.DummyFeature.isEnabled;
  }

  async reloadDummyHandlerStatusAsync(): Promise&lt;void&gt; {
    if (this.isDummyFeatureEnabled) {
      this.isDummyApiEnabled = await this.dummyApiService.isHandlerEnabled();
    }
  }

  ngOnInit(): void {
    this.reloadFeatureFlagsAsync();
    this.reloadDummyHandlerStatusAsync();
  }
}

angular.module(&#x27;oppia&#x27;).directive(
  &#x27;adminFeaturesTab&#x27;, downgradeComponent(
    {component: AdminFeaturesTabComponent}));
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:214,&quot;character&quot;:10,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:214,&quot;character&quot;:12,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:214,&quot;character&quot;:21,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:214,&quot;character&quot;:23,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:214,&quot;character&quot;:29,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:215,&quot;character&quot;:53,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:215,&quot;character&quot;:55,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:215,&quot;character&quot;:61,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:213,&quot;character&quot;:13,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:251,&quot;character&quot;:10,&quot;text&quot;:&quot;issues&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:258,&quot;character&quot;:8,&quot;text&quot;:&quot;issues&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:270,&quot;character&quot;:10,&quot;text&quot;:&quot;issues&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/pages/admin-page/features-tab/admin-features-tab.component.ts&quot;,&quot;line&quot;:283,&quot;character&quot;:12,&quot;text&quot;:&quot;issues&quot;,&quot;kind&quot;:2}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:57 GMT</p>
    </body>
  </html>
  