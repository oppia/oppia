
  <!DOCTYPE html>
  <html>
    <head>
      <title>search.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">core/templates/services/search.service.ts</td><td class="">96.09%</td><td class="">100%</td><td class="">307</td><td class="">295</td><td class="">12</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2020 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Search service for activityTilesInfinityGrid.
 */

import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;
import { Injectable, EventEmitter } from &#x27;@angular/core&#x27;;

import { ExplorationSummaryBackendDict } from &#x27;domain/summary/exploration-summary-backend-api.service&#x27;;
import { SearchBackendApiService } from &#x27;./search-backend-api.service&#x27;;

export class SelectionList {
  [key: string]: boolean;
}

class FilterDetails {
  description: string;
  itemsName: string;
  masterList: {
    id: string;
    text: string;
  }[];
  selections: SelectionList;
  numSelections: number;
  summary: string;
}

export class SelectionDetails {
  categories: FilterDetails;
  languageCodes: FilterDetails;
}

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class SearchService {
  private _lastQuery: string = null;
  private _lastSelectedCategories: SelectionList = {};
  private _lastSelectedLanguageCodes: SelectionList = {};
  private _searchCursor: string = null;
  private _isCurrentlyFetchingResults = false;
  private _searchBarLoadedEventEmitter = new EventEmitter&lt;string&gt;();
  private _initialSearchResultsLoadedEventEmitter =
    new EventEmitter&lt;ExplorationSummaryBackendDict&gt;();
  public numSearchesInProgress = 0;

  constructor(
    private _searchBackendApiService: SearchBackendApiService) {
  }

  private _getSuffixForQuery(
      selectedCategories: SelectionList,
      selectedLanguageCodes: SelectionList): string {
    let querySuffix = &#x27;&#x27;;

    let _categories = &#x27;&#x27;;
    for (let key in selectedCategories) {
      if (selectedCategories[key]) {
        if (_categories) {
          _categories += &#x27;&quot; OR &quot;&#x27;;
        }
        _categories += key;
      }
    }
    if (_categories) {
      querySuffix += &#x27;&amp;category=(&quot;&#x27; + _categories + &#x27;&quot;)&#x27;;
    }

    let _languageCodes = &#x27;&#x27;;
    for (let key in selectedLanguageCodes) {
      if (selectedLanguageCodes[key]) {
        if (_languageCodes) {
          _languageCodes += &#x27;&quot; OR &quot;&#x27;;
        }
        _languageCodes += key;
      }
    }
    if (_languageCodes) {
      querySuffix += &#x27;&amp;language_code=(&quot;&#x27; + _languageCodes + &#x27;&quot;)&#x27;;
    }

    return querySuffix;
  }

  hasReachedEndOfPage(): boolean {
    return this._searchCursor === null;
  }

  updateSearchFields(
      itemsType: string, urlComponent: string,
      selectionDetails: SelectionDetails
  ): void {
    const itemCodeGroup = urlComponent.match(/=\(&quot;[A-Za-z%20&quot; ]+&quot;\)/);
    const itemCodes = itemCodeGroup ? itemCodeGroup[0] : null;

    const EXPECTED_PREFIX = &#x27;=(&quot;&#x27;;
    const EXPECTED_SUFFIX = &#x27;&quot;)&#x27;;

    if (!itemCodes ||
        itemCodes.indexOf(EXPECTED_PREFIX) !== 0 ||
        itemCodes.lastIndexOf(EXPECTED_SUFFIX) !==
          itemCodes.length - EXPECTED_SUFFIX.length) {
      throw new Error(
        &#x27;Invalid search query url fragment for &#x27; +
        itemsType + &#x27;: &#x27; + urlComponent);
    }

    const items = itemCodes.substring(
      EXPECTED_PREFIX.length, itemCodes.length - EXPECTED_SUFFIX.length
    ).split(&#x27;&quot; OR &quot;&#x27;);

    const selections = selectionDetails[itemsType].selections;
    for (let i = 0; i &lt; items.length; i++) {
      selections[items[i]] = true;
    }
  }

  getQueryUrl(searchUrlQueryString: string): string {
    return &#x27;?q=&#x27; + searchUrlQueryString;
  }

  getSearchUrlQueryString(
      searchQuery: string,
      selectedCategories: SelectionList,
      selectedLanguageCodes: SelectionList): string {
    return encodeURIComponent(searchQuery) +
      this._getSuffixForQuery(selectedCategories, selectedLanguageCodes);
  }


  // Note that an empty query results in all activities being shown.
  executeSearchQuery(
      searchQuery: string,
      selectedCategories: SelectionList,
      selectedLanguageCodes: SelectionList,
      successCallback: () =&gt; void,
      errorCallback?: (reason: string) =&gt; void): void {
    const queryUrl = this.getQueryUrl(
      this.getSearchUrlQueryString(
        searchQuery, selectedCategories, selectedLanguageCodes));

    this._isCurrentlyFetchingResults = true;
    this.numSearchesInProgress++;
    this._searchBackendApiService.fetchExplorationSearchResultAsync(queryUrl)
      .then((response) =&gt; {
        this._lastQuery = searchQuery;
        this._lastSelectedCategories = angular.copy(selectedCategories);
        this._lastSelectedLanguageCodes = angular.copy(selectedLanguageCodes);
        this._searchCursor = response.search_cursor;
        this.numSearchesInProgress--;

        this._initialSearchResultsLoadedEventEmitter.emit(
          response.activity_list);

        this._isCurrentlyFetchingResults = false;
      }, (errorResponse) =&gt; {
        this.numSearchesInProgress--;
        if (errorCallback) {
          errorCallback(errorResponse.error.error);
        }
      });

    if (successCallback) {
      successCallback();
    }
  }

  isSearchInProgress(): boolean {
    return this.numSearchesInProgress &gt; 0;
  }

  /**
   * Takes in the url search component as an argument and the
   * selectionDetails. It will update selectionDetails with the relevant
   * fields that were extracted from the url.
   * @returns the unencoded search query string.
  */
  updateSearchFieldsBasedOnUrlQuery(
      urlComponent: string, selectionDetails: SelectionDetails): string {
    const urlQuery = urlComponent.substring(&#x27;?q=&#x27;.length);
    // The following will split the urlQuery into 3 components:
    // 1. query
    // 2. categories (optional)
    // 3. language codes (default to &#x27;en&#x27;).
    const querySegments = urlQuery.split(&#x27;&amp;&#x27;);

    for (let i = 1; i &lt; querySegments.length; i++) {
      urlComponent = decodeURIComponent(querySegments[i]);

      let itemsType = null;
      if (urlComponent.indexOf(&#x27;category&#x27;) === 0) {
        itemsType = &#x27;categories&#x27;;
      } else if (urlComponent.indexOf(&#x27;language_code&#x27;) === 0) {
        itemsType = &#x27;languageCodes&#x27;;
      } else {
        continue;
      }

      try {
        this.updateSearchFields(itemsType, urlComponent, selectionDetails);
      } catch (error) {
        selectionDetails[itemsType].selections = {};
      }
    }

    return decodeURIComponent(querySegments[0]);
  }

  getCurrentUrlQueryString(): string {
    return this.getSearchUrlQueryString(
      this._lastQuery,
      this._lastSelectedCategories,
      this._lastSelectedLanguageCodes
    );
  }

  loadMoreData(
      successCallback: (SearchResponseData, boolean) =&gt; void,
      failureCallback?: (any) =&gt; void): void {
    // If a new query is still being sent, or the end of the page has been
    // reached, do not fetch more results.
    if (this._isCurrentlyFetchingResults || this.hasReachedEndOfPage()) {
      failureCallback(this.hasReachedEndOfPage());
      return;
    }

    let queryUrl = this.getQueryUrl(this.getCurrentUrlQueryString());

    if (this._searchCursor) {
      queryUrl += &#x27;&amp;cursor=&#x27; + this._searchCursor;
    }

    this._isCurrentlyFetchingResults = true;
    this._searchBackendApiService.fetchExplorationSearchResultAsync(queryUrl)
      .then((response) =&gt; {
        this._searchCursor = response.search_cursor;
        this._isCurrentlyFetchingResults = false;

        if (successCallback) {
          successCallback(response, this.hasReachedEndOfPage());
        }
      });
  }

  get onSearchBarLoaded(): EventEmitter&lt;string&gt; {
    return this._searchBarLoadedEventEmitter;
  }

  get onInitialSearchResultsLoaded():
    EventEmitter&lt;ExplorationSummaryBackendDict&gt; {
    return this._initialSearchResultsLoadedEventEmitter;
  }
}

angular.module(&#x27;oppia&#x27;).factory(
  &#x27;SearchService&#x27;,
  downgradeInjectable(SearchService)
);
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:168,&quot;character&quot;:10,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:171,&quot;character&quot;:24,&quot;text&quot;:&quot;errorResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:171,&quot;character&quot;:38,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:171,&quot;character&quot;:44,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:202,&quot;character&quot;:10,&quot;text&quot;:&quot;itemsType&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:204,&quot;character&quot;:8,&quot;text&quot;:&quot;itemsType&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:206,&quot;character&quot;:8,&quot;text&quot;:&quot;itemsType&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:214,&quot;character&quot;:25,&quot;text&quot;:&quot;itemsType&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:213,&quot;character&quot;:15,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:230,&quot;character&quot;:24,&quot;text&quot;:&quot;SearchResponseData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:230,&quot;character&quot;:44,&quot;text&quot;:&quot;boolean&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/search.service.ts&quot;,&quot;line&quot;:231,&quot;character&quot;:25,&quot;text&quot;:&quot;any&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:56 GMT</p>
    </body>
  </html>
  