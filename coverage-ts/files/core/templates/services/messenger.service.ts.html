
  <!DOCTYPE html>
  <html>
    <head>
      <title>messenger.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">core/templates/services/messenger.service.ts</td><td class="">96.65%</td><td class="">100%</td><td class="">269</td><td class="">260</td><td class="">9</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2014 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Service for sending messages to a parent iframe. All outbound
 * communication with a parent iframe should pass through here. (This
 * communication should be outbound only; reverse communication should NOT
 * be attempted due to cross-domain security issues.)
 */

import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;
import { Injectable } from &#x27;@angular/core&#x27;;

import { LoggerService } from &#x27;services/contextual/logger.service&#x27;;
import { WindowRef } from &#x27;services/contextual/window-ref.service&#x27;;

interface HeightChangeData {
  height: number;
  scroll: number;
}

interface ExplorationLoadedData {
  explorationVersion: number;
  explorationTitle: string;
}

interface StateTransitionData {
  explorationVersion: number;
  oldStateName: string;
  jsonAnswer: string;
  newStateName: string;
}

interface ExplorationCompletedData {
  explorationVersion: number;
}

interface MessageValidatorsType {
  heightChange(payload: HeightChangeData): boolean;
  explorationLoaded(): boolean;
  stateTransition(payload: StateTransitionData): boolean;
  explorationReset(payload: {stateName: string}): boolean;
  explorationCompleted(): boolean;
}

interface GetPayloadType {
  heightChange(data: HeightChangeData): HeightChangeData;
  explorationLoaded(data: ExplorationLoadedData): ExplorationLoadedData;
  stateTransition(data: StateTransitionData): StateTransitionData;
  explorationCompleted(
    data: ExplorationCompletedData): ExplorationCompletedData;
  explorationReset(data: string): {stateName: string};
}

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class MessengerService {
  constructor(
    private loggerService: LoggerService, private windowRef: WindowRef) {}

  // TODO(brianrodri): Move these into a .constants.ts file.
  HEIGHT_CHANGE: string = &#x27;heightChange&#x27;;
  EXPLORATION_LOADED: string = &#x27;explorationLoaded&#x27;;
  STATE_TRANSITION: string = &#x27;stateTransition&#x27;;
  EXPLORATION_RESET: string = &#x27;explorationReset&#x27;;
  EXPLORATION_COMPLETED: string = &#x27;explorationCompleted&#x27;;

  SUPPORTED_HASHDICT_VERSIONS: Set&lt;string&gt; = (
    new Set([&#x27;0.0.0&#x27;, &#x27;0.0.1&#x27;, &#x27;0.0.2&#x27;, &#x27;0.0.3&#x27;]));

  MESSAGE_VALIDATORS: MessageValidatorsType = {
    heightChange(payload: HeightChangeData): boolean {
      const {height, scroll} = payload;
      return (
        Number.isInteger(height) &amp;&amp; height &gt; 0 &amp;&amp; typeof scroll === &#x27;boolean&#x27;);
    },
    explorationLoaded(): boolean {
      return true;
    },
    stateTransition(payload: StateTransitionData): boolean {
      return Boolean(payload.oldStateName) || Boolean(payload.newStateName);
    },
    explorationReset(payload: {stateName: string}): boolean {
      return Boolean(payload.stateName);
    },
    explorationCompleted(): boolean {
      return true;
    }
  };

  getPayload: GetPayloadType = {
    heightChange(data: HeightChangeData): HeightChangeData {
      return {
        height: data.height,
        scroll: data.scroll
      };
    },
    explorationLoaded(data: ExplorationLoadedData): ExplorationLoadedData {
      return {
        explorationVersion: data.explorationVersion,
        explorationTitle: data.explorationTitle
      };
    },
    stateTransition(data: StateTransitionData): StateTransitionData {
      return {
        explorationVersion: data.explorationVersion,
        oldStateName: data.oldStateName,
        jsonAnswer: data.jsonAnswer,
        newStateName: data.newStateName
      };
    },
    explorationCompleted(
        data: ExplorationCompletedData): ExplorationCompletedData {
      return {
        explorationVersion: data.explorationVersion
      };
    },
    // ---- DEPRECATED ----
    explorationReset(data: string): {stateName: string} {
      return {
        stateName: data
      };
    }
  };

  /**
   * Sends a message to the parent iframe.
   * @param messageTitle - The title of the message.
   * @param messageData - The data of the message. It is of type
   *   Object since it can have different properties based on the messageTitle.
   */
  sendMessage(messageTitle: string, messageData: Object): void {
    // TODO(sll): For the stateTransition and explorationCompleted events,
    // we now send paramValues in the messageData. We should broadcast these
    // to the parent page as well.
    // TODO(sll): Delete/deprecate &#x27;reset exploration&#x27; from the list of
    // events sent to a container page.

    // Only send a message to the parent if the oppia window is iframed and
    // a hash is passed in.
    let window = this.windowRef.nativeWindow;
    let rawHash = window.location.hash.substring(1);
    if (window.parent !== window &amp;&amp; rawHash &amp;&amp;
        this.MESSAGE_VALIDATORS.hasOwnProperty(messageTitle)) {
      // Protractor tests may prepend a / to this hash, which we remove.
      let hash =
        (rawHash.charAt(0) === &#x27;/&#x27;) ? rawHash.substring(1) : rawHash;
      let hashParts = hash.split(&#x27;&amp;&#x27;);
      let hashDict = {
        version: null,
        secret: null,
        tagid: null
      };
      for (let i = 0; i &lt; hashParts.length; i++) {
        if (hashParts[i].indexOf(&#x27;=&#x27;) === -1) {
          this.loggerService.error(&#x27;Invalid hash for embedding: &#x27; + hash);
          return;
        }

        let separatorLocation = hashParts[i].indexOf(&#x27;=&#x27;);
        hashDict[hashParts[i].substring(0, separatorLocation)] = (
          hashParts[i].substring(separatorLocation + 1));
      }

      if (!hashDict.version || !hashDict.secret) {
        this.loggerService.error(&#x27;Invalid hash for embedding: &#x27; + hash);
        return;
      }

      if (this.SUPPORTED_HASHDICT_VERSIONS.has(hashDict.version)) {
        this.loggerService.info(&#x27;Posting message to parent: &#x27; + messageTitle);

        let payload = this.getPayload[messageTitle](messageData);
        if (!this.MESSAGE_VALIDATORS[messageTitle](payload)) {
          this.loggerService.error(&#x27;Error validating payload: &#x27; + payload);
          return;
        }

        this.loggerService.info(payload);

        let objToSendToParent = {
          title: messageTitle,
          payload: payload,
          sourceTagId: null,
          secret: null
        };
        if (hashDict.version === &#x27;0.0.0&#x27;) {
          // Ensure backwards-compatibility.
          objToSendToParent.sourceTagId = hashDict.tagid;
          objToSendToParent.secret = hashDict.secret;
        }

        // The targetOrigin needs to be * because any page can iframe an
        // exploration.
        window.parent.postMessage(JSON.stringify(objToSendToParent), &#x27;*&#x27;);
      } else {
        this.loggerService.error(
          &#x27;Unknown version for embedding: &#x27; + hashDict.version);
        return;
      }
    }
  }
}
angular.module(&#x27;oppia&#x27;).factory(&#x27;MessengerService&#x27;,
  downgradeInjectable(MessengerService));
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;core/templates/services/messenger.service.ts&quot;,&quot;line&quot;:176,&quot;character&quot;:20,&quot;text&quot;:&quot;version&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/messenger.service.ts&quot;,&quot;line&quot;:176,&quot;character&quot;:41,&quot;text&quot;:&quot;secret&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/messenger.service.ts&quot;,&quot;line&quot;:181,&quot;character&quot;:56,&quot;text&quot;:&quot;version&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/messenger.service.ts&quot;,&quot;line&quot;:198,&quot;character&quot;:21,&quot;text&quot;:&quot;version&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/messenger.service.ts&quot;,&quot;line&quot;:200,&quot;character&quot;:28,&quot;text&quot;:&quot;sourceTagId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/messenger.service.ts&quot;,&quot;line&quot;:200,&quot;character&quot;:51,&quot;text&quot;:&quot;tagid&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/messenger.service.ts&quot;,&quot;line&quot;:201,&quot;character&quot;:28,&quot;text&quot;:&quot;secret&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/messenger.service.ts&quot;,&quot;line&quot;:201,&quot;character&quot;:46,&quot;text&quot;:&quot;secret&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/messenger.service.ts&quot;,&quot;line&quot;:209,&quot;character&quot;:55,&quot;text&quot;:&quot;version&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:55 GMT</p>
    </body>
  </html>
  