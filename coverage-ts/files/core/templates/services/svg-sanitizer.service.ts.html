
  <!DOCTYPE html>
  <html>
    <head>
      <title>svg-sanitizer.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">core/templates/services/svg-sanitizer.service.ts</td><td class="">96.71%</td><td class="">100%</td><td class="">213</td><td class="">206</td><td class="">7</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// Copyright 2020 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview SVG related checks and sanitization service.
 */

import { Injectable } from &#x27;@angular/core&#x27;;
import { DomSanitizer, SafeResourceUrl } from &#x27;@angular/platform-browser&#x27;;
import { downgradeInjectable } from &#x27;@angular/upgrade/static&#x27;;

import constants from &#x27;assets/constants&#x27;;

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class SvgSanitizerService {
  constructor(private sanitizer: DomSanitizer) {}

  cleanMathExpressionSvgString(svgString: string): string {
    // We need to modify/remove unnecessary attributes added by mathjax
    // from the svg tag.
    let domParser = new DOMParser();
    let doc = domParser.parseFromString(svgString, &#x27;image/svg+xml&#x27;);
    doc.querySelectorAll(&#x27;*&#x27;).forEach((node) =&gt; {
      if (node.tagName.toLowerCase() === &#x27;svg&#x27;) {
        node.removeAttribute(&#x27;xmlns:xlink&#x27;);
        node.removeAttribute(&#x27;role&#x27;);
        // We are removing this attribute, because currently it is not in
        // the allowlist of valid attributes.
        node.removeAttribute(&#x27;aria-hidden&#x27;);
        node.setAttribute(&#x27;xmlns&#x27;, &#x27;http://www.w3.org/2000/svg&#x27;);
      }
      // Remove the custom data attributes added by MathJax.
      // These custom attributes don&#x27;t affect the rendering of the SVGs,
      // and they are not present in the white list for allowed attributes.
      for (let i = 0; i &lt; node.attributes.length; i++) {
        if (node.attributes[i].name.toLowerCase().startsWith(&#x27;data-&#x27;)) {
          node.removeAttribute(node.attributes[i].name.toLowerCase());
        }
      }
    });
    return doc.documentElement.outerHTML;
  }

  extractDimensionsFromMathExpressionSvgString(svgString: string): {
    height: string, width: string, verticalPadding: string} {
    // The method below extracts the dimensions from the attributes of a
    // math SVG string generated by mathJax.
    let domParser = new DOMParser();
    let dimensions = {
      height: &#x27;&#x27;,
      width: &#x27;&#x27;,
      verticalPadding: &#x27;&#x27;
    };
    let doc = domParser.parseFromString(svgString, &#x27;image/svg+xml&#x27;);
    doc.querySelectorAll(&#x27;*&#x27;).forEach((node) =&gt; {
      // Mathjax SVGs have relative dimensions in the unit of &#x27;ex&#x27; rather
      // than &#x27;px&#x27;(pixels). Hence the dimensions have decimal points in them,
      // we need to replace these decimals with a letter so that it&#x27;s easier
      // to process and validate the filenames.
      if (node.tagName.toLowerCase() === &#x27;svg&#x27;) {
        dimensions.height = (
          (node.getAttribute(&#x27;height&#x27;).match(/\d+\.*\d*/g)[0]).replace(
            &#x27;.&#x27;, &#x27;d&#x27;));
        dimensions.width = (
          (node.getAttribute(&#x27;width&#x27;).match(/\d+\.*\d*/g)[0]).replace(
            &#x27;.&#x27;, &#x27;d&#x27;));
        // This attribute is useful for the vertical alignment of the
        // Math SVG while displaying inline with other text.
        // Math SVGs don&#x27;t necessarily have a vertical alignment, in that
        // case we assign it zero.
        let styleValue = node.getAttribute(&#x27;style&#x27;).match(/\d+\.*\d*/g);
        if (styleValue) {
          dimensions.verticalPadding = styleValue[0].replace(&#x27;.&#x27;, &#x27;d&#x27;);
        } else {
          dimensions.verticalPadding = &#x27;0&#x27;;
        }
      }
    });
    return dimensions;
  }

  private _getInvalidSvgTagsAndAttrs(
      svg: Document): {tags: string[], attrs: string[]} {
    let invalidTags = [];
    let invalidAttrs = [];
    let allowedTags = Object.keys(constants.SVG_ATTRS_WHITELIST);
    let nodeTagName = null;
    svg.querySelectorAll(&#x27;*&#x27;).forEach((node) =&gt; {
      nodeTagName = node.tagName.toLowerCase();
      if (allowedTags.indexOf(nodeTagName) !== -1) {
        for (let i = 0; i &lt; node.attributes.length; i++) {
          if (constants.SVG_ATTRS_WHITELIST[nodeTagName].indexOf(
            node.attributes[i].name.toLowerCase()) === -1) {
            invalidAttrs.push(
              node.tagName + &#x27;:&#x27; + node.attributes[i].name);
          }
        }
      } else {
        invalidTags.push(node.tagName);
      }
    });
    return { tags: invalidTags, attrs: invalidAttrs };
  }

  getInvalidSvgTagsAndAttrs(svg: Document): {tags: string[], attrs: string[]} {
    return this._getInvalidSvgTagsAndAttrs(svg);
  }

  getInvalidSvgTagsAndAttrsFromDataUri(
      dataURI: string): {tags: string[], attrs: string[]} {
    // Convert base64/URLEncoded data component to raw binary data
    // held in a string.
    let svgString = atob(dataURI.split(&#x27;,&#x27;)[1]);
    let domParser = new DOMParser();
    let doc = domParser.parseFromString(svgString, &#x27;image/svg+xml&#x27;);
    return this._getInvalidSvgTagsAndAttrs(doc);
  }

  /**
   * Checks the input for malicious or invalid SVG code.
   * The checks:
   * 1. Is base64 encoded.
   * 2. Has no invalid tags or attributes. This check is performed by the
   *    getInvalidSvgTagsAndAttrsFromDataUri function in this file.
   *
   * @returns {boolean} True if all the checks pass. False Otherwise.
   */
  isValidBase64Svg(base64ImageData: string): boolean {
    const DATA_URL_PATTERN = /^data:image\/svg\+xml;base64,[a-z0-9+\/]+=*$/i;
    // Check if data passed is a valid bse64 SVG.
    if (!base64ImageData.match(DATA_URL_PATTERN)) {
      return false;
    }

    // Check for malicious SVG.
    const { tags: invalidTags, attrs: invalidAttributes } = (
      this.getInvalidSvgTagsAndAttrsFromDataUri(base64ImageData));

    if (invalidTags.length &gt; 0 || invalidAttributes.length &gt; 0) {
      return false;
    }

    // The SVG is safe and valid.
    return true;
  }

  /**
   * Checks the input for malicious or invalid SVG code.
   * Angular by default treats svg+xml data as unsafe. In order to show the SVG
   * we need to check the SVG data for possible XSS attacks. The spec file for
   * this component showcases some scenarios where XSS attacks are possible if
   * the SVG is not checked for such attacks. The following function checks the
   * SVG data for possible XSS vulnerabilities.
   *
   * @returns {SafeResourceUrl | null} SafeResourceUrl if the SVG is valid and
   * trusted. Otherwise returns null.
   */
  getTrustedSvgResourceUrl(base64ImageData: string): SafeResourceUrl | null {
    if (this.isValidBase64Svg(base64ImageData)) {
      return this.sanitizer.bypassSecurityTrustResourceUrl(base64ImageData);
    }
    return null;
  }
}

angular.module(&#x27;oppia&#x27;).factory(
  &#x27;SvgSanitizerService&#x27;, downgradeInjectable(SvgSanitizerService));
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;core/templates/services/svg-sanitizer.service.ts&quot;,&quot;line&quot;:96,&quot;character&quot;:8,&quot;text&quot;:&quot;invalidTags&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/services/svg-sanitizer.service.ts&quot;,&quot;line&quot;:97,&quot;character&quot;:8,&quot;text&quot;:&quot;invalidAttrs&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/services/svg-sanitizer.service.ts&quot;,&quot;line&quot;:99,&quot;character&quot;:8,&quot;text&quot;:&quot;nodeTagName&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/svg-sanitizer.service.ts&quot;,&quot;line&quot;:101,&quot;character&quot;:6,&quot;text&quot;:&quot;nodeTagName&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/svg-sanitizer.service.ts&quot;,&quot;line&quot;:104,&quot;character&quot;:44,&quot;text&quot;:&quot;nodeTagName&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;core/templates/services/svg-sanitizer.service.ts&quot;,&quot;line&quot;:106,&quot;character&quot;:12,&quot;text&quot;:&quot;invalidAttrs&quot;,&quot;kind&quot;:2},{&quot;file&quot;:&quot;core/templates/services/svg-sanitizer.service.ts&quot;,&quot;line&quot;:111,&quot;character&quot;:8,&quot;text&quot;:&quot;invalidTags&quot;,&quot;kind&quot;:2}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 17 Jun 2021 20:43:54 GMT</p>
    </body>
  </html>
  