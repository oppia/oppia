var_for_docker_image: &docker_image circleci/python:2.7.14-jessie-browsers

anchor_for_job_defaults: &job_defaults
  working_directory: /home/circleci/oppia
  docker:
    - image: *docker_image

anchor_for_installing_dependencies: &install_dependencies
  name: Install dependencies
  command: |
    source scripts/setup.sh || exit 1
    source scripts/setup_gae.sh || exit 1

anchor_for_restoring_cache: &restore_cache
  keys:
    - setup-files-cache-{{ checksum "date" }}
    - third-party-cache-{{ checksum "date" }}

version: 2
jobs:
  setup:
    <<: *job_defaults
    steps:
      - checkout
      - run: date +%F > date
      - restore_cache:
          <<: *restore_cache
      - run:
          <<: *install_dependencies
      - save_cache:
          key: setup-files-cache-{{ checksum "date" }}
          paths:
            - ../node_modules/
            - ../oppia_tools/

  lint_tests:
    <<: *job_defaults
    steps:
      - checkout
      - run: date +%F > date
      - restore_cache:
          <<: *restore_cache
      - run:
          name: Run lint tests
          command: |
            bash scripts/install_third_party.sh
            python scripts/third_party_size_check.py
            python scripts/pre_commit_linter.py --path=. --verbose
      - save_cache:
          key: third-party-cache-{{ checksum "date" }}
          paths:
            - third_party/

  frontend_tests:
    <<: *job_defaults
    steps:
      - checkout
      - run: date +%F > date
      - restore_cache:
          <<: *restore_cache
      - run:
          name: Run frontend tests
          command: |
            bash -x scripts/run_frontend_tests.sh --run-minified-tests=true
      - run:
          name: Generate frontend coverage report
          command: |
            sudo pip install codecov
            codecov --file ../karma_coverage_reports/coverage-final.json
          when: on_success

  backend_tests:
    <<: *job_defaults
    steps:
      - checkout
      - run: date +%F > date
      - restore_cache:
          <<: *restore_cache
      - run:
          name: Run backend tests
          command: |
            bash scripts/run_backend_tests.sh --generate_coverage_report --exclude_load_tests
      - run:
          name: Generate backend coverage report
          command: |
            sudo pip install codecov
            codecov
          when: on_success

  e2e_tests:
    <<: *job_defaults
    steps:
      - checkout
      - run: date +%F > date
      - restore_cache:
          <<: *restore_cache
      - run:
          name: E2E Tests
          command: |
            sudo apt-get install lsb-release libappindicator3-1
            curl -L -o google-chrome.deb https://github.com/webnicer/chrome-downloads/raw/master/x64.deb/google-chrome-stable_67.0.3396.99-1_amd64.deb
            sudo dpkg -i google-chrome.deb
            sudo sed -i 's|HERE/chrome"|HERE/chrome" --disable-setuid-sandbox|g' /opt/google/chrome/google-chrome
            rm google-chrome.deb
            bash scripts/run_e2e_tests.sh --suite="accessibility" --prod_env
            # bash scripts/run_e2e_tests.sh --suite="additionalEditorAndPlayerFeatures" --prod_env
            bash scripts/run_e2e_tests.sh --suite="collections" --prod_env
            bash scripts/run_e2e_tests.sh --suite="coreEditorAndPlayerFeatures" --prod_env
            # bash scripts/run_e2e_tests.sh --suite="embedding" --prod_env
            # bash scripts/run_e2e_tests.sh --suite="explorationFeedbackTab --prod_env
            bash scripts/run_e2e_tests.sh --suite="explorationHistoryTab" --prod_env
            #  bash scripts/run_e2e_tests.sh --suite="explorationStatisticsTab" --prod_env
            bash scripts/run_e2e_tests.sh --suite="explorationTranslationTab" --prod_env
            # bash scripts/run_e2e_tests.sh --suite="extensions" --prod_env
            # bash scripts/run_e2e_tests.sh --suite="learnerDashboard" --prod_env
            # bash scripts/run_e2e_tests.sh --suite="learner" --prod_env
            # bash scripts/run_e2e_tests.sh --suite="library" --prod_env
            bash scripts/run_e2e_tests.sh --suite="navigation" --prod_env
            bash scripts/run_e2e_tests.sh --suite="preferences" --prod_env
            bash scripts/run_e2e_tests.sh --suite="profileMenu" --prod_env
            bash scripts/run_e2e_tests.sh --suite="publication" --prod_env
            bash scripts/run_e2e_tests.sh --suite="skillEditorPage" --prod_env
            # bash scripts/run_e2e_tests.sh --suite="subscriptions" --prod_env
            # bash scripts/run_e2e_tests.sh --suite="topicsAndSkillsDashboard" --prod_env
            # bash scripts/run_e2e_tests.sh --suite="topicAndStoryEditor" --prod_env
            # bash scripts/run_e2e_tests.sh --suite="users" --prod_env
  
  # chrome_version:
  #   <<: *job_defaults
  #   steps:
  #     - checkout
  #     - run: date +%F > date
  #     - restore_cache:
  #         <<: *restore_cache
  #     - run:
  #         name: Chrome Version
  #         command: |
  #           google-chrome --version

workflows:
  version: 2
  circleci_tests:
    jobs:
      - setup
      - lint_tests:
          requires:
            - setup
      - frontend_tests:
          requires:
            - setup
      - backend_tests:
          requires:
            - setup
      - e2e_tests:
          requires:
            - setup
notify:
  webhooks:
    # A list of hook hashes, containing the url field
    # gitter hook
    - url: https://webhooks.gitter.im/e/71ac71505d1d45161035
