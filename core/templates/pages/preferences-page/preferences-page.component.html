<background-banner></background-banner>
<form *ngIf="hasPageLoaded" [formGroup]="preferencesForm" (ngSubmit)="savePreferences()">
  <div class="oppia-dashboard-container ng-scope">
    <h1 class="oppia-preferences-page-heading e2e-test-preferences-title" tabindex="0">
        {{ 'I18N_PREFERENCES_HEADING' | translate }}
    </h1>
    <mat-card class="oppia-page-card">
      <div *ngIf="hasPageLoaded">
        <!--
            The 'hasPageLoaded' variable is used to ensure that the form group is created.
            else it will be undefined and we cannot access its properties below, so it throws an error in the console.
            Eg: formControlName="userBio".
        -->
        <div class="container">
          <div class="form-group row">
            <label class="col-lg-4 col-md-4 col-sm-4" tabindex="0" [attr.aria-label]="'Username: ' + username">
              {{ 'I18N_PREFERENCES_USERNAME' | translate }}
            </label>
            <div class="col-lg-8 col-md-8 col-sm-8">
              <a *ngIf="username"
                 aria-label="Go to profile page"
                 href="/profile/{{ username }}"
                 [smartRouterLink]="'/profile/' + username"
                 class="preferences-page-tab-focus">
                  {{ username }}
              </a>
              <em *ngIf="!username">
                {{ 'I18N_PREFERENCES_USERNAME_NOT_SELECTED' | translate }}
              </em>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-lg-4 col-md-4 col-sm-4">
              {{ 'I18N_PREFERENCES_PICTURE' | translate }}
            </label>
            <div class="col-lg-8 col-md-8 col-sm-8">
              <div class="oppia-editable-section oppia-editor-profile-picture-container"
                   title="{{ 'I18N_PREFERENCES_CHANGE_PICTURE' | translate }}">
                <div class="oppia-click-to-start-editing e2e-test-photo-clickable"
                     (click)="showEditProfilePictureModal()">
                </div>
                <div class="oppia-editor-edit-btn oppia-editor-edit-btn-pos">
                  <i class="fas fa-pen oppia-editor-profile-edit-icon"
                     tabindex="0"
                     aria-label="Edit profile picture"
                     role="button"
                     (keydown.enter)="showEditProfilePictureModal()">
                  </i>
                </div>
                <picture *ngIf="preferencesForm.get('profilePicturePngDataUrl').value">
                  <source type="image/webp" [srcset]="preferencesForm.get('profilePictureWebpDataUrl').value" >
                  <source type="image/png" [srcset]="preferencesForm.get('profilePicturePngDataUrl').value">
                  <img [src]="preferencesForm.get('profilePicturePngDataUrl').value"
                       class="img-thumbnail e2e-test-custom-photo"
                       alt="Profile photo picture">
                </picture>
                <picture *ngIf="!preferencesForm.get('profilePicturePngDataUrl').value">
                  <source type="image/webp" [srcset]="getStaticImageUrl('/general/no_profile_picture.webp')">
                  <source type="image/png" [srcset]="getStaticImageUrl('/general/no_profile_picture.png')">
                  <img [src]="getStaticImageUrl('/general/no_profile_picture.png')"
                       class="img-thumbnail"
                       alt="Empty profile picture">
                </picture>
              </div>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-lg-4 col-md-4 col-sm-4">
              {{ 'I18N_PREFERENCES_BIO' | translate }}
            </label>
            <div class="col-lg-8 col-md-8 col-sm-8">
              <textarea [attr.aria-label]="'Bio. ' + ('I18N_PREFERENCES_BIO_EXPLAIN_TEXT' | translate)"
                        class="oppia-bio-border e2e-test-user-bio oppia-autofocus"
                        formControlName="userBio"
                        rows="5"
                        maxlength="2000">
              </textarea>
              <span class="form-text oppia-form-text">
                {{ 'I18N_PREFERENCES_BIO_EXPLAIN_TEXT' | translate }}
              </span>
            </div>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-lg-4 col-md-4 col-sm-4"
                 tabindex="0"
                 [attr.aria-label]="('I18N_PREFERENCES_PREFERRED_DASHBOARD' | translate) + ('I18N_PREFERENCES_PREFERRED_DASHBOARD_EXPLAIN' | translate)">
            {{ 'I18N_PREFERENCES_PREFERRED_DASHBOARD' | translate }}
          </label>
          <div class="col-lg-8 col-md-8 col-sm-8">
            <div class="checkbox oppia-checkbox">
              <input type="radio"
                     #firstRadio
                     (keydown)="handleTabForFirstRadio($event)"
                     formControlName="defaultDashboard"
                     value="{{ DASHBOARD_TYPE_CREATOR }}"
                     class="e2e-test-creator-dashboard-radio"
                     attr.aria-label="{{ 'I18N_PREFERENCES_PREFERRED_DASHBOARD' | translate }}, {{ 'I18N_TOPNAV_CREATOR_DASHBOARD' | translate }}">
              <span aria-hidden="true">
                {{ 'I18N_TOPNAV_CREATOR_DASHBOARD' | translate }}
              </span>
            </div>
            <div class="checkbox oppia-checkbox">
              <input type="radio"
                     #secondRadio
                     (keydown)="handleTabForSecondRadio($event)"
                     formControlName="defaultDashboard"
                     value="{{ DASHBOARD_TYPE_LEARNER }}"
                     class="e2e-test-learner-dashboard-radio"
                     attr.aria-label="{{ 'I18N_PREFERENCES_PREFERRED_DASHBOARD' | translate }}, {{ 'I18N_TOPNAV_LEARNER_DASHBOARD' | translate }}">
              <span aria-hidden="true">
                {{ 'I18N_TOPNAV_LEARNER_DASHBOARD' | translate }}
              </span>
            </div>
            <div class="checkbox oppia-checkbox">
              <input type="radio"
                     #thirdRadio
                     (keydown)="handleTabForThirdRadio($event)"
                     formControlName="defaultDashboard"
                     value="{{ DASHBOARD_TYPE_CONTRIBUTOR }}"
                     class="e2e-test-contributor-dashboard-radio"
                     attr.aria-label="{{ 'I18N_PREFERENCES_PREFERRED_DASHBOARD' | translate }}, {{ 'I18N_TOPNAV_CONTRIBUTOR_DASHBOARD' | translate }}">
              <span aria-hidden="true">
                {{ 'I18N_TOPNAV_CONTRIBUTOR_DASHBOARD' | translate }}
              </span>
            </div>
            <span class="form-text oppia-form-text">
              {{ 'I18N_PREFERENCES_PREFERRED_DASHBOARD_EXPLAIN' | translate }}
            </span>
          </div>
        </div>

        <div class="form-group row">
          <label for="label-target-interests-dropdown"
                 class="col-lg-4 col-md-4 col-sm-4"
                 tabindex="0"
                 [attr.aria-label]="('I18N_PREFERENCES_SUBJECT_INTERESTS' | translate) + ('I18N_PREFERENCES_SUBJECT_INTERESTS_HELP_BLOCK' | translate)">
            {{ 'I18N_PREFERENCES_SUBJECT_INTERESTS' | translate }}
          </label>
          <div class="col-lg-8 col-md-8 col-sm-8">
            <div *ngIf="hasPageLoaded">
              <oppia-subject-interests formControlName="subjectInterests">
              </oppia-subject-interests>
            </div>
            <span class="form-text oppia-form-text">
              {{ 'I18N_PREFERENCES_SUBJECT_INTERESTS_HELP_BLOCK' | translate }}
            </span>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-lg-4 col-md-4 col-sm-4" tabindex="0">
            {{ 'I18N_PREFERENCES_SUBSCRIBED_CREATORS' | translate }}
          </label>
          <div class="col-lg-8 col-md-8 col-sm-8">
            <span *ngIf="subscriptionList?.length === 0" class="form-text oppia-form-text" tabindex="0">
              {{ 'I18N_PREFERENCES_NO_SUBSCRIPTIONS' | translate }}
            </span>
            <mat-grid-list *ngIf="subscriptionList?.length > 0" cols="2" rowHeight="100px">
              <mat-grid-tile *ngFor="let subscription of subscriptionList">
                <mat-card class="oppia-subscription-card oppia-subscription-list-container">
                  <a class="oppia-subscription-profile-link"
                     href="/profile/{{ subscription.creator_username }}"
                     [smartRouterLink]="'/profile/' + subscription.creator_username"
                     tabindex="0"
                     rel="noopener"
                     target="_blank">
                    <picture>
                      <source type="image/webp"
                              [srcset]="getProfileImageWebpDataUrl(subscription.creator_username)">
                      <source type="image/png"
                              [srcset]="getProfileImagePngDataUrl(subscription.creator_username)">
                      <img class="oppia-subscription-card-profile-picture rounded-circle"
                           [src]="getProfileImagePngDataUrl(subscription.creator_username)"
                           alt="User Avatar">
                    </picture>
                    <span class="oppia-subscription-card-summary">
                      <div class="oppia-subscription-card-summary-text-container">
                        <strong class="e2e-test-subscription-name"
                                [ngbPopover]="subscription.creator_username"
                                [triggers]="showUsernamePopover(subscription.creator_username)">
                          {{ subscription.creator_username| truncate:10 }}
                        </strong>
                      </div>
                      <div class="oppia-impact-text">
                        <span>
                          {{ 'I18N_PREFERENCES_OPPIA_IMPACT_SECTION_HEADING' | translate }}
                        </span>
                        <span>
                          {{ subscription.creator_impact || 0 }}
                        </span>
                      </div>
                    </span>
                  </a>
                </mat-card>
              </mat-grid-tile>
            </mat-grid-list>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-lg-4 col-md-4 col-sm-4"
                 tabindex="0"
                 [attr.aria-label]="('I18N_PREFERENCES_PREFERRED_EXPLORATION_LANGUAGE' | translate) + ('I18N_PREFERENCES_PREFERRED_EXPLORATION_LANGUAGE_EXPLAIN' | translate)">
            {{ 'I18N_PREFERENCES_PREFERRED_EXPLORATION_LANGUAGE' | translate }}
          </label>
          <div class="col-lg-8 col-md-8 col-sm-8">
            <div *ngIf="hasPageLoaded">
              <oppia-preferred-languages formControlName="preferredLanguageCodes"
                                         [choices]="LANGUAGE_CHOICES">
              </oppia-preferred-languages>
            </div>
            <span class="form-text oppia-form-text">
              {{ 'I18N_PREFERENCES_PREFERRED_EXPLORATION_LANGUAGE_EXPLAIN' | translate }}
            </span>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-lg-4 col-md-4 col-sm-4"
                 tabindex="0"
                 [attr.aria-label]="('I18N_PREFERENCES_PREFERRED_SITE_LANGUAGE' | translate) + ('I18N_PREFERENCES_PREFERRED_SITE_LANGUAGE_EXPLAIN' | translate)">
            {{ 'I18N_PREFERENCES_PREFERRED_SITE_LANGUAGE' | translate }}
          </label>
          <div class="col-lg-8 col-md-8 col-sm-8">
            <div *ngIf="hasPageLoaded">
              <oppia-preferred-language-selector formControlName="preferredSiteLanguageCode"
                                                 [choices]="SITE_LANGUAGE_CHOICES"
                                                 entity="{{ 'I18N_PREFERENCES_SITE_LANGUAGE_LABEL' | translate }}">
              </oppia-preferred-language-selector>
            </div>
            <span class="form-text oppia-form-text">
              {{ 'I18N_PREFERENCES_PREFERRED_SITE_LANGUAGE_EXPLAIN' | translate }}
            </span>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-lg-4 col-md-4 col-sm-4"
                 tabindex="0"
                 [attr.aria-label]="('I18N_PREFERENCES_PREFERRED_AUDIO_LANGUAGE' | translate) + ('I18N_PREFERENCES_PREFERRED_AUDIO_LANGUAGE_EXPLAIN' | translate)">
            {{ "I18N_PREFERENCES_PREFERRED_AUDIO_LANGUAGE" | translate }}
          </label>
          <div class="col-lg-8 col-md-8 col-sm-8">
            <div *ngIf="hasPageLoaded">
              <oppia-preferred-language-selector formControlName="preferredAudioLanguageCode"
                                                 [choices]="AUDIO_LANGUAGE_CHOICES"
                                                 entity="{{ 'I18N_PREFERENCES_AUDIO_LANGUAGE_LABEL' | translate }}">
              </oppia-preferred-language-selector>
            </div>
            <span class="form-text oppia-form-text">
              {{ 'I18N_PREFERENCES_PREFERRED_AUDIO_LANGUAGE_EXPLAIN' | translate }}
            </span>
          </div>
        </div>
        <hr>
        <div role="form" class="form-group row">
          <label class="col-lg-4 col-md-4 col-sm-4" tabindex="0">
            {{ 'I18N_PREFERENCES_EMAIL' | translate }}
          </label>
          <div class="col-lg-8 col-md-8 col-sm-8" formGroupName="emailPreferences">
            <span class="help-block oppia-form-text" tabindex="0">
              {{ email }} {{ 'I18N_PREFERENCES_EMAIL_EXPLAIN' | translate }}
            </span>
            <div tabindex="0">
              <i>
                <span class="help-block oppia-form-text">
                  {{ 'I18N_PREFERENCES_EMAIL_CLARIFICATION' | translate }}
                </span>
              </i>
            </div>
            <div class="checkbox">
              <label>
                <input type="checkbox"
                       class="e2e-test-email-updates-checkbox"
                       formControlName="canReceiveEmailUpdates">
                <span>
                  {{ 'I18N_PREFERENCES_EMAIL_RECEIVE_NEWS' | translate }}
                </span>
              </label>
              <div class="alert alert-warning" *ngIf="showEmailSignupLink">
                <span class="help-block oppia-form-text">
                  {{ 'I18N_PREFERENCES_EMAIL_SIGNUP_TEXT' | translate }}
                </span>
                <a class="help-block oppia-form-text"
                   [href]="emailSignupLink"
                   target="_blank"
                   rel="noopener">
                  {{ emailSignupLink }}
                </a>
              </div>
            </div>
            <div class="checkbox">
              <label>
                <input type="checkbox"
                       class="e2e-test-editor-role-email-checkbox"
                       formControlName="canReceiveEditorRoleEmail">
                <span>
                  {{ 'I18N_PREFERENCES_EMAIL_RECEIVE_EDIT_RIGHTS_NEWS' | translate }}
                </span>
              </label>
            </div>
            <div class="checkbox">
              <label>
                <input type="checkbox"
                       class="e2e-test-subscription-email-checkbox"
                       formControlName="canReceiveSubscriptionEmail">
                <span>
                  {{ 'I18N_PREFERENCES_EMAIL_RECEIVE_SUBSCRIPTION_NEWS' | translate }}
                </span>
              </label>
            </div>
            <div class="checkbox">
              <label>
                <input type="checkbox"
                       class="e2e-test-feedback-message-email-checkbox"
                       formControlName="canReceiveFeedbackMessageEmail">
                <span>
                  {{ 'I18N_PREFERENCES_EMAIL_RECEIVE_FEEDBACK_NEWS' | translate }}
                </span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <hr>
      <div role="form" class="form-group row">
        <label class="col-lg-4 col-md-4 col-sm-4" tabindex="0">
          {{ 'I18N_DELETE_ACCOUNT_PAGE_HEADING' | translate }}
        </label>
        <div class="col-lg-8 col-md-8 col-sm-8">
          <a href="/delete-account"
             [attr.aria-label]="('I18N_DELETE_ACCOUNT_PAGE_HEADING' | translate) + ('I18N_DELETE_ACCOUNT_PAGE_REDIRECT_INFO' | translate)"
             class="preferences-page-tab-focus"
            [smartRouterLink]="'/' + PAGES_REGISTERED_WITH_FRONTEND.DELETE_ACCOUNT.ROUTE">
            <button tabindex="-1" type="button" class="btn btn-danger e2e-test-delete-account-button">
              {{ 'I18N_DELETE_ACCOUNT_PAGE_HEADING' | translate }}
            </button>
          </a>
          <span class="form-text oppia-form-text">
            {{ 'I18N_DELETE_ACCOUNT_PAGE_REDIRECT_INFO' | translate }}
          </span>
        </div>
      </div>

      <hr>

      <div role="form" class="form-group row">
        <label class="col-lg-4 col-md-4 col-sm-4 text-capitalize" tabindex="0">
          {{ 'I18N_PREFERENCES_EXPORT_ACCOUNT' | translate }}
        </label>
        <div class="col-lg-8 col-md-8 col-sm-8" *ngIf="!exportingData">
          <a href="/export-account-handler"
             tabindex="0"
             [attr.aria-label]="('I18N_PREFERENCES_EXPORT_ACCOUNT' | translate) + ('I18N_PREFERENCES_EXPORT_ACCOUNT_INFO_TEXT' | translate)"
             class="preferences-page-tab-focus">
            <button type="button"
                    class="btn btn-primary e2e-test-export-account-button"
                    title="Export account"
                    tabindex="-1"
                    (click)="handleExportDataClick()">
                    {{ 'I18N_PREFERENCES_EXPORT_ACCOUNT' | translate }}
            </button>
          </a>
          <span class="form-text oppia-form-text">
            {{ 'I18N_PREFERENCES_EXPORT_ACCOUNT_INFO_TEXT' | translate }}
          </span>
        </div>
        <div class="col-lg-8 col-md-8 col-sm-8" *ngIf="exportingData">
          <span class="form-text oppia-form-text">
            {{ 'I18N_PREFERENCES_EXPORT_ACCOUNT_WARNING_TEXT' | translate }} <a href="mailto:support@oppia.org">support@oppia.org</a>.
          </span>
        </div>
      </div>

    </mat-card>
  </div>
  <div class="oppia-sticky-footer-container">
    <div class="oppia-save-btn-container">
      <button type="submit"
              class="btn oppia-save-button e2e-test-save-changes-button"
              [disabled]="!hasPageLoaded || !preferencesForm.dirty ">
        {{ 'I18N_PREFERENCES_SAVE_CHANGES' | translate }}
      </button>
    </div>
  </div>
</form>
