language: python

python:
- 2.7

addons:
  firefox: latest
  sauce_connect: true
  apt:
    sources:
    - google-chrome

branches:
  only:
  - master
  - develop
  # This branch is added for testing. should be removed before merged to develop
  #- new-travis-tests

env:
  matrix:
    - RUN_E2E_TESTS=true
    - RUN_BACKEND_TESTS=false RUN_FRONTEND_TESTS=false RUN_LINT=true REPORT_BACKEND_COVERAGE=false
    - RUN_BACKEND_TESTS=false RUN_FRONTEND_TESTS=true RUN_LINT=false REPORT_BACKEND_COVERAGE=false
    - RUN_BACKEND_TESTS=true RUN_FRONTEND_TESTS=false RUN_LINT=false REPORT_BACKEND_COVERAGE=false
    - RUN_BACKEND_TESTS=true RUN_FRONTEND_TESTS=false RUN_LINT=false REPORT_BACKEND_COVERAGE=true
  # Connect to SauceLabs by adding encripted username and Sauce Key
  # They will be available globaly in travis env to be used by core/tests/protractor.conf.js
  global:
    #- secure: CdqriDTcKaS6LMGsL+zqLGyhKv4xWzycKgBFlhVEBwgG70kOH7I+HKj29UzA6Ym1Mb2hofKVSlRkhepzuG8CgH9Rd07lUeWnERphIdaZwGYNMulVZhZM0/6Quo2hNDDDHzyhOWlM2XkmzUsaBp8M0J/tIa5A9HkSpHZ4Fj3tEAsPzqj1wewxS7iQHlOhCXZb8WzpG/WEiJH8tonPbJCZBr+ZW8C3F8DdnTrl4Boino0PBLr01rgu5sURYbPKpi1Qa3iW9DMKAA9qEbz89ofnSvt9tXz7FdNqAbJ0B0KYpmS1rU82+Lz58dMXmHFnRxAZiIBeG+Fhzl97b0fG+d/S2+KiRostXcWVbVHa/h4wyfoBtVZD0XFgSUxCKJ10T+eFJhLrBstoCfIzJ10sxHLr/hrmPpJ/Ac+v2F2/ib3pFIvHrJOmbve831HzMVTlAVVqX2C+kkr+WH1QhdUw1AMm6aYTOsE4ZxBGV6IqWOkPOn7kA/CWnqaea2xVJ7O7drkXbO5cQCVpP3X+RxF1w2tUfseJftGx8A9Ca0JRjWpNvFX2AVyuK6gEgB7fWfCmfVmLdaVtSPXNMerTWaD/jLKPwcla92+sUh9iCVEiVfrYxx63U+27YJ8hwfHfkIXuuf6iGzh5vmp04KA93KSmQmMRddN4MhuuV7t/avVXRxKxuwQ=
    #- secure: S+epWEt5+Kliht0gH7EepXOwydt4YhPs10q+ZbF2V81zbDA54goVdwedU5c03vjiheXAl781+M8zfd+U8Ew531vwEkJ9HMnpS5dyUEexRtlyw7K//MHkbUyxWe7f1Jkq7baKD9j9eBN2gzeVTT8m6787aoIaTvSgVB0uifbW+rUq0k4+ENgSziERNBMVVnJkfvZM2zIjpeMFqpn5Ui2ARkYNnZwSAQN8K/KiKQx/v62/bLz5C59s1S9LjFfUzfXzOX73tdE4dw28jgc1toF2PLkXj8gtJM03hpHWvPTwDu/NGStUBpnj7e4Tp4ladfnuSGly1BTQtUfbK6gEdC/Y/OruLx94Ww/3BdBC2Peyh5DF0BDCViTYzQ0RDkIXtf4QL6AfHuqTBO2d088TkozAO7HasqFR+iSyeSyC2zXHJlyt0jZP14h/6gVO/lcO4XSS/eKWEMf6BgL8Weu8Rt8fZFPQYZ1idXkRF5ZMipO1akU0zOLHuDgXfauzaF/cv9cqyV5dXH5EBMwj+XGjtpTU+/6RyU0IBKK+1hqggXStvILrFyY/cnTo0cnReO2KM6SI+JpRjrOf5KfWnuKxesXVRfZ/MS4mXINrUCTbxl5UMP6vxPIa830pHbPSH9xnrE22fZytrvAlQltSxIDIZlpMFgKlsJQGomm/aQK3TdHMcZU=
    - secure: IX/SX0D4DQiD9sRXMxe2Kqx+L8r0r1AXmTyE3pcTHoM3aScnHbFRztZnuBA1TJsw4f17aOKAO3btxAMsblFKkoNLjdIvgrS227Zp/862sRvvOwHGPr1rgO9gtLBbP2fhFQi9UWVrbWVqY8rHPWjm+v80bjwqCmurVSPnXoZzD0tW1cKkD63uxn52HDVrMnwjz+o8zvD3M39/y7e3RcqEpW4VSQL1KhjygCWtu4okvvHDV8DmxI8GwyuMCW2478CmQE17SAs/vLBAQEe6ir1XWqkB4LZFCudIB4YDX6pQuVXJmbjWKGfVIN6+RkPosxUhidhHdfMedl88Rz9hRR4Nz3Zts3n7N2dwNC4PBpedrATOrjvdaBKNGXJG8dG2QIcM4eaYCDgU0rfzmBdFlV1l76UxTJOUDIgk98Lrz0aoiwl/qV82V7z+pcb+aITV6hf53ytv2DlIrpGIVcbfflmTsOSQZUX0AT6SEFR5KlR/VsbWpcTE3jViFSGN3D2R5sy8clV1b31nc232JTS6s4tcGNTB15Tki/rHIS/SN3jzGwG6B50c9Bi40T6hZkknNE3gPSH5RyNoufz8m129YHdIwH54kzETVG9UCNKHCD4s9NL30Tp4HFV+J7hl0ZtrV3a9AvjGn2CRZO+yRj6gFnSpJhX3jrMZazXGRX+n4KauEPw=
    - secure: Uv3mFr7FxGgT2wNVD7g+/xVopinMUCgbiCRbGy840phhMk8obh9evdoxdDiungDT4rCosA+CuDT8PBPqueDrAntZ+hELKy2IaZQ42y/HaSlCBnI6Yn7JJmchlYEtRlNN0KpNnjkSmb8/TUhaBjJr+JmFRDIfjuBgKGQfQUsZBQnDvZZYW7VyfxEocfMnIfDqBWemGvRuZnMBLO3rJKOi4/s6jH3iPvklQRA6+oHqPIYKZuH3aRKZ6ZwWRnJgO8Xtq0BdjpxLcsVsgqwEH0JGsR0Nrmm+Z9WXlkr7FjpajmMExdniykG4TCulkxlK/Ls95gUnjVwLaIp7nhrg8bfSzw6WBbcixHC2dr6et9R5ttwBeMMqy3cM01fXQxi07FNz03cHpEZRUMiohDqQnX8o/hZ4AjiDrkzBDXcDLkEbLZoEvkTO/RDaAbz7YJTt3rQ4BAkSzDfgGNR6dqtOK4UaYvi2HBhDVy1lGgy6CGN8rolkFSQs40uip0kUeXyVPMId/eqx+A6fMqM1A0SzYsCZONdoiFVkM0vh4LtiPo/G4EwElDWDKIR4d4JVB/ubu4EeIucSFTmPkNp0XthzvYV9NcC2r2VUdi8TOPsoi/ekQnkJJsGIP7tF4oW15ze381Eo3au60eBopl7srmKcBAiMT8MMhngXksDqO1zUE1+LLZs=
matrix:
  allow_failures:
  # The backend tests, with coverage, take too long to run, so we make this
  # optional.
  - env: RUN_BACKEND_TESTS=true RUN_FRONTEND_TESTS=false RUN_LINT=false REPORT_BACKEND_COVERAGE=true
  fast_finish: true

notifications:
  email:
    recipients:
    - sean@seanlip.org
    - henning.benmax@gmail.com
    - wxy.xinyu@gmail.com
    on_success: change
    on_failure: change
  irc:
    channels:
    - chat.freenode.net#oppia
    on_success: never
    on_failure: always
  webhooks:
    urls:
    # This URL can be obtained by going to the Gitter chat room
    # and clicking Settings > Integrations.
    - https://webhooks.gitter.im/e/f8f782497ec1ffcea2e7
    on_success: always
    on_failure: always

before_install:
- pip install codecov
- export CHROME_BIN=chromium-browser
- export DISPLAY=:99.0
- bash -e /etc/init.d/xvfb start

install:
- set -e
- pushd $TRAVIS_BUILD_DIR
- source scripts/setup.sh || exit 1
- source scripts/setup_gae.sh || exit 1

script:
- if [ $RUN_E2E_TESTS == 'true' ]; then bash scripts/run_e2e_tests.sh; fi
- if [ $RUN_BACKEND_TESTS == 'true' ] && [ $REPORT_BACKEND_COVERAGE == 'true' ]; then bash scripts/run_backend_tests.sh --generate_coverage_report; fi
- if [ $RUN_BACKEND_TESTS == 'true' ] && [ $REPORT_BACKEND_COVERAGE == 'false' ]; then bash scripts/run_backend_tests.sh; fi
- if [ $RUN_LINT == 'true' ]; then bash scripts/install_third_party.sh; python scripts/pre_commit_linter.py --path=.; fi
# Travis aborts test run if nothing is printed back to STDOUT for some time.
# -x is used to avoid that.
- if [ $RUN_FRONTEND_TESTS == 'true' ]; then bash -x scripts/run_frontend_tests.sh --run-minified-tests=true; fi

after_success:
- if [ $RUN_BACKEND_TESTS == 'true' ] && [ $REPORT_BACKEND_COVERAGE == 'true' ]; then codecov; fi
- if [ $RUN_FRONTEND_TESTS == 'true' ]; then codecov --file ../karma_coverage_reports/coverage-final.json; fi

cache:
  # Cache Oppia's dependencies.
  directories:
    - ../node_modules/
    - ../oppia_tools/
    - third_party/

before_cache:
  # Delete python bytecode to prevent cache rebuild.
  - find third_party -name "*.pyc" -print -delete
