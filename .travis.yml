language: python

python:
- 2.7

addons:
  firefox: latest
  sauce_connect: true
  apt:
    sources:
    - google-chrome

branches:
  only:
  - master
  - develop

env:
  matrix:
    - RUN_E2E_TESTS=true
    - RUN_BACKEND_TESTS=false RUN_FRONTEND_TESTS=false RUN_LINT=true REPORT_BACKEND_COVERAGE=false
    - RUN_BACKEND_TESTS=false RUN_FRONTEND_TESTS=true RUN_LINT=false REPORT_BACKEND_COVERAGE=false
    - RUN_BACKEND_TESTS=true RUN_FRONTEND_TESTS=false RUN_LINT=false REPORT_BACKEND_COVERAGE=false
    - RUN_BACKEND_TESTS=true RUN_FRONTEND_TESTS=false RUN_LINT=false REPORT_BACKEND_COVERAGE=true
  # Connect to SauceLabs by adding encripted username and Sauce Key
  # They will be available globaly in travis env to be used by core/tests/protractor.conf.js
  global:
    - secure: il8Eb6rqBkOw50jRYXyFAlYYU4FLP38HTWWb1an91C+8eTCUK8YEY/uIUEcJorWz1VpRHR0wYil7VonCSq3b3U4flkQ9qLgnqt+7RKZQc5yD6ZX22RYBi5CuHqZBafhUggUcpXjl/sjKMUrfSl5lQSQyQPq6fUGtwrvdJrYW4QXY+WudgnmW2SgnDi9m5shQ3dDEU3JYFGrQG7egHZ4fotlMxcU69k96L4CFf5+a6+mH1WHNBdMLXk1oXxrjWlf18e+m0Vm9Xcnu48PYBGPWY6QrMiT/WC9LDIMWE5HTtTSXRnvI0GVsbAdsWyg6Z2Fe4olgniddKbXQOmdSXCrjHVx9hT8O3ZWxrnn16qm8n7Qp71HzBZlx2q9NO85Te6g7T8K46/7ShD+7S0W/raByZrcW//PkmpJPeEuOCx9loBR2yj6jKfg0+SUi/QVQjAQt+VrQm13V9aYp/Qn5PMUo9yYuziLIZ7V/FKbafmhk9yEf8O5/e6d472jj8FrMJizMdOTKBeAaR7It9QfLPhME0aimZjnSMe2txKu1P80oLLNwQkQEokxWPdUMFHXLA4dNqcF4bNKeNQU3BVYh1vCBHecd86Qzx66bLxNfetloVrzLQr5mYwkMcWcFGKH39As5fdWkrSaWvg0V0tPZwA1t/LTfKv+yUMseenO8QlETgCM=
    - secure: N545gZz/W4TumpZzWPKLkg3Er1zYM15Lwvxvv+jQugXBBszs5yeEU7LJI6t6Udl8G7CrWNk7JVXDRbKaIOgreJscDeiCjqO3WZPW3cJ2Wf1Fa9CSNo8w43JunbTmDIyi2/L1BfInV4Vt/Qqh3U6kO3No+SH7UvW14Q3Uj4mnGgh0NPX+dZlCdz2uJ5vM9aDDm2jWyP8vUw6DFNJ4SvTS5ZB3dz+9iYdLRxC0l8GpLSEFAb2CGqQl7OgOwCWIDVHQSUrabwdZw/j/gQEF2OaisFMN7g+HBBNBHtnwNOJomr6+ak2B8ipoBlwlKDOV/FdeDNF3+wmt0mbpQcCV+/g/GK8ntzkR/y9B5SuzLKvwB6gFa/yFn9lj8+mb9ku5J0NS4gm3DWc1chLN51upxDypgwoi4n6LPh25XvpwQIZHHhaCAV2Vmxr7NQsqIlsX8A1l5zr/Bl9gt0vmo53Tey4FDr5bZQGZcQUj9MbspZf6aKUjY3PLE5hYYn6BrXdE8Lf7fQKUhx/e6H/zr/Qrht5gCmEuXJtw0yBonntsrvdCzX1Du285X4oyubBcgEQ/fijwPM8qg3SAJuh/TQs27LxdlVidJ/LfCZAZ1Ad1vI6ActAzcEWLgaMk8YngbRX4mIXQ/X0YsJRwHHzecymsop3Sas8c5+YC6ILClFAvK/2/XTI=
matrix:
  allow_failures:
  # The backend tests, with coverage, take too long to run, so we make this
  # optional.
  - env: RUN_BACKEND_TESTS=true RUN_FRONTEND_TESTS=false RUN_LINT=false REPORT_BACKEND_COVERAGE=true
  fast_finish: true

notifications:
  email:
    recipients:
    - sean@seanlip.org
    - henning.benmax@gmail.com
    - wxy.xinyu@gmail.com
    on_success: change
    on_failure: change
  irc:
    channels:
    - chat.freenode.net#oppia
    on_success: never
    on_failure: always
  webhooks:
    urls:
    # This URL can be obtained by going to the Gitter chat room
    # and clicking Settings > Integrations.
    - https://webhooks.gitter.im/e/f8f782497ec1ffcea2e7
    on_success: always
    on_failure: always

before_install:
- pip install codecov
- export CHROME_BIN=chromium-browser
- export DISPLAY=:99.0
- bash -e /etc/init.d/xvfb start

install:
- set -e
- pushd $TRAVIS_BUILD_DIR
- source scripts/setup.sh || exit 1
- source scripts/setup_gae.sh || exit 1

script:
- if [ $RUN_E2E_TESTS == 'true' ]; then bash scripts/run_e2e_tests.sh; fi
- if [ $RUN_BACKEND_TESTS == 'true' ] && [ $REPORT_BACKEND_COVERAGE == 'true' ]; then bash scripts/run_backend_tests.sh --generate_coverage_report; fi
- if [ $RUN_BACKEND_TESTS == 'true' ] && [ $REPORT_BACKEND_COVERAGE == 'false' ]; then bash scripts/run_backend_tests.sh; fi
- if [ $RUN_LINT == 'true' ]; then bash scripts/install_third_party.sh; python scripts/pre_commit_linter.py --path=.; fi
# Travis aborts test run if nothing is printed back to STDOUT for some time.
# -x is used to avoid that.
- if [ $RUN_FRONTEND_TESTS == 'true' ]; then bash -x scripts/run_frontend_tests.sh --run-minified-tests=true; fi

after_success:
- if [ $RUN_BACKEND_TESTS == 'true' ] && [ $REPORT_BACKEND_COVERAGE == 'true' ]; then codecov; fi
- if [ $RUN_FRONTEND_TESTS == 'true' ]; then codecov --file ../karma_coverage_reports/coverage-final.json; fi

cache:
  # Cache Oppia's dependencies.
  directories:
    - ../node_modules/
    - ../oppia_tools/
    - third_party/

before_cache:
  # Delete python bytecode to prevent cache rebuild.
  - find third_party -name "*.pyc" -print -delete
